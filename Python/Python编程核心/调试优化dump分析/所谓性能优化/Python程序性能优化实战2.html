<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python程序性能优化实战2 | 思源笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link href="/images/logo.png" rel="icon">
    <meta name="description" content="来自思源笔记的内容">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.d3c0dc77.js" as="script"><link rel="preload" href="/assets/js/2.5fbe0391.js" as="script"><link rel="preload" href="/assets/js/1.dc7adba2.js" as="script"><link rel="preload" href="/assets/js/355.70321476.js" as="script"><link rel="prefetch" href="/assets/js/10.a9ace829.js"><link rel="prefetch" href="/assets/js/100.1ffa901d.js"><link rel="prefetch" href="/assets/js/101.37fdabbb.js"><link rel="prefetch" href="/assets/js/102.9c0f99bd.js"><link rel="prefetch" href="/assets/js/103.571daa23.js"><link rel="prefetch" href="/assets/js/104.88901889.js"><link rel="prefetch" href="/assets/js/105.e1c7fc4a.js"><link rel="prefetch" href="/assets/js/106.366c43d3.js"><link rel="prefetch" href="/assets/js/107.077c5081.js"><link rel="prefetch" href="/assets/js/108.c7d4e1fb.js"><link rel="prefetch" href="/assets/js/109.e7b7cb8f.js"><link rel="prefetch" href="/assets/js/11.32adc493.js"><link rel="prefetch" href="/assets/js/110.86cb08fa.js"><link rel="prefetch" href="/assets/js/111.b725586a.js"><link rel="prefetch" href="/assets/js/112.9f3b9f75.js"><link rel="prefetch" href="/assets/js/113.4a5023eb.js"><link rel="prefetch" href="/assets/js/114.6556c4e7.js"><link rel="prefetch" href="/assets/js/115.72cdb14c.js"><link rel="prefetch" href="/assets/js/116.6d5b51c2.js"><link rel="prefetch" href="/assets/js/117.65ec9b76.js"><link rel="prefetch" href="/assets/js/118.7f4861c9.js"><link rel="prefetch" href="/assets/js/119.650ac25d.js"><link rel="prefetch" href="/assets/js/12.92b47e85.js"><link rel="prefetch" href="/assets/js/120.8e7250e1.js"><link rel="prefetch" href="/assets/js/121.c5a06028.js"><link rel="prefetch" href="/assets/js/122.29f4e7bd.js"><link rel="prefetch" href="/assets/js/123.5e449baf.js"><link rel="prefetch" href="/assets/js/124.a44b0134.js"><link rel="prefetch" href="/assets/js/125.df3fe3e7.js"><link rel="prefetch" href="/assets/js/126.6974e54f.js"><link rel="prefetch" href="/assets/js/127.f2454306.js"><link rel="prefetch" href="/assets/js/128.b900fa7e.js"><link rel="prefetch" href="/assets/js/129.15864c0a.js"><link rel="prefetch" href="/assets/js/13.ebfb1f42.js"><link rel="prefetch" href="/assets/js/130.cc6853ea.js"><link rel="prefetch" href="/assets/js/131.5bb214da.js"><link rel="prefetch" href="/assets/js/132.1a83e445.js"><link rel="prefetch" href="/assets/js/133.da4547b9.js"><link rel="prefetch" href="/assets/js/134.0aeb00a9.js"><link rel="prefetch" href="/assets/js/135.16eb5d31.js"><link rel="prefetch" href="/assets/js/136.67396e70.js"><link rel="prefetch" href="/assets/js/137.afeb5d96.js"><link rel="prefetch" href="/assets/js/138.36e805ef.js"><link rel="prefetch" href="/assets/js/139.7d8c0405.js"><link rel="prefetch" href="/assets/js/14.3e65117c.js"><link rel="prefetch" href="/assets/js/140.6df70824.js"><link rel="prefetch" href="/assets/js/141.f642dacf.js"><link rel="prefetch" href="/assets/js/142.10230571.js"><link rel="prefetch" href="/assets/js/143.d599ee24.js"><link rel="prefetch" href="/assets/js/144.e1a88c20.js"><link rel="prefetch" href="/assets/js/145.eb357101.js"><link rel="prefetch" href="/assets/js/146.b3fe7f16.js"><link rel="prefetch" href="/assets/js/147.dbfb2f7d.js"><link rel="prefetch" href="/assets/js/148.8ed5bf1d.js"><link rel="prefetch" href="/assets/js/149.2c73c82d.js"><link rel="prefetch" href="/assets/js/15.5304afab.js"><link rel="prefetch" href="/assets/js/150.78115158.js"><link rel="prefetch" href="/assets/js/151.22badb82.js"><link rel="prefetch" href="/assets/js/152.a99d0f22.js"><link rel="prefetch" href="/assets/js/153.6a863a43.js"><link rel="prefetch" href="/assets/js/154.c6a0b3dc.js"><link rel="prefetch" href="/assets/js/155.b8591455.js"><link rel="prefetch" href="/assets/js/156.dd9eeca0.js"><link rel="prefetch" href="/assets/js/157.48909220.js"><link rel="prefetch" href="/assets/js/158.99fac6bc.js"><link rel="prefetch" href="/assets/js/159.3bcae7d0.js"><link rel="prefetch" href="/assets/js/16.9ca9aae8.js"><link rel="prefetch" href="/assets/js/160.7c8a9be5.js"><link rel="prefetch" href="/assets/js/161.30bee0bb.js"><link rel="prefetch" href="/assets/js/162.0dde5818.js"><link rel="prefetch" href="/assets/js/163.d4de9cde.js"><link rel="prefetch" href="/assets/js/164.1aa26354.js"><link rel="prefetch" href="/assets/js/165.67d8c450.js"><link rel="prefetch" href="/assets/js/166.81d14b26.js"><link rel="prefetch" href="/assets/js/167.ae715f9a.js"><link rel="prefetch" href="/assets/js/168.f2998afb.js"><link rel="prefetch" href="/assets/js/169.fd39ee46.js"><link rel="prefetch" href="/assets/js/17.3dbcb51f.js"><link rel="prefetch" href="/assets/js/170.147fd31a.js"><link rel="prefetch" href="/assets/js/171.35f8ce60.js"><link rel="prefetch" href="/assets/js/172.10db3085.js"><link rel="prefetch" href="/assets/js/173.11a8ff33.js"><link rel="prefetch" href="/assets/js/174.e196a1f6.js"><link rel="prefetch" href="/assets/js/175.0157f18d.js"><link rel="prefetch" href="/assets/js/176.6d3d456c.js"><link rel="prefetch" href="/assets/js/177.9c40b853.js"><link rel="prefetch" href="/assets/js/178.8dd00920.js"><link rel="prefetch" href="/assets/js/179.f7f4c661.js"><link rel="prefetch" href="/assets/js/18.4c170722.js"><link rel="prefetch" href="/assets/js/180.d02b4575.js"><link rel="prefetch" href="/assets/js/181.be3c0f7a.js"><link rel="prefetch" href="/assets/js/182.ae4673f8.js"><link rel="prefetch" href="/assets/js/183.ed56a865.js"><link rel="prefetch" href="/assets/js/184.43db12b1.js"><link rel="prefetch" href="/assets/js/185.3a09c20e.js"><link rel="prefetch" href="/assets/js/186.77240fee.js"><link rel="prefetch" href="/assets/js/187.c544cb6a.js"><link rel="prefetch" href="/assets/js/188.682782b1.js"><link rel="prefetch" href="/assets/js/189.1e81f7d7.js"><link rel="prefetch" href="/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/assets/js/190.c60243cc.js"><link rel="prefetch" href="/assets/js/191.841c59cf.js"><link rel="prefetch" href="/assets/js/192.6b3c14f5.js"><link rel="prefetch" href="/assets/js/193.47319c1f.js"><link rel="prefetch" href="/assets/js/194.95c798e0.js"><link rel="prefetch" href="/assets/js/195.258b0234.js"><link rel="prefetch" href="/assets/js/196.c5e95bf4.js"><link rel="prefetch" href="/assets/js/197.0a40131d.js"><link rel="prefetch" href="/assets/js/198.6ae77026.js"><link rel="prefetch" href="/assets/js/199.be929f6f.js"><link rel="prefetch" href="/assets/js/20.0d880388.js"><link rel="prefetch" href="/assets/js/200.6fdb4cde.js"><link rel="prefetch" href="/assets/js/201.2db1075b.js"><link rel="prefetch" href="/assets/js/202.6989c482.js"><link rel="prefetch" href="/assets/js/203.fed5be3d.js"><link rel="prefetch" href="/assets/js/204.2e2bd97a.js"><link rel="prefetch" href="/assets/js/205.919ad25d.js"><link rel="prefetch" href="/assets/js/206.caf46f82.js"><link rel="prefetch" href="/assets/js/207.b2786542.js"><link rel="prefetch" href="/assets/js/208.3ff31c7c.js"><link rel="prefetch" href="/assets/js/209.1ff1e0ba.js"><link rel="prefetch" href="/assets/js/21.0ad1d6a3.js"><link rel="prefetch" href="/assets/js/210.5673535d.js"><link rel="prefetch" href="/assets/js/211.07da8ae4.js"><link rel="prefetch" href="/assets/js/212.9a0d098d.js"><link rel="prefetch" href="/assets/js/213.289228c1.js"><link rel="prefetch" href="/assets/js/214.a9e3f658.js"><link rel="prefetch" href="/assets/js/215.2c849138.js"><link rel="prefetch" href="/assets/js/216.0b799039.js"><link rel="prefetch" href="/assets/js/217.248fa9ab.js"><link rel="prefetch" href="/assets/js/218.77bc5089.js"><link rel="prefetch" href="/assets/js/219.d0bcdf70.js"><link rel="prefetch" href="/assets/js/22.288b4852.js"><link rel="prefetch" href="/assets/js/220.abb5d7d1.js"><link rel="prefetch" href="/assets/js/221.39a29724.js"><link rel="prefetch" href="/assets/js/222.c8f848c5.js"><link rel="prefetch" href="/assets/js/223.3ea7fe96.js"><link rel="prefetch" href="/assets/js/224.afb1f423.js"><link rel="prefetch" href="/assets/js/225.cdd67273.js"><link rel="prefetch" href="/assets/js/226.89d69b6c.js"><link rel="prefetch" href="/assets/js/227.f5305f39.js"><link rel="prefetch" href="/assets/js/228.3276d530.js"><link rel="prefetch" href="/assets/js/229.ca4a013c.js"><link rel="prefetch" href="/assets/js/23.730038ee.js"><link rel="prefetch" href="/assets/js/230.19be1bec.js"><link rel="prefetch" href="/assets/js/231.940832b4.js"><link rel="prefetch" href="/assets/js/232.18dbe9c8.js"><link rel="prefetch" href="/assets/js/233.03187181.js"><link rel="prefetch" href="/assets/js/234.ed91cd88.js"><link rel="prefetch" href="/assets/js/235.277f96ac.js"><link rel="prefetch" href="/assets/js/236.8dee6d1a.js"><link rel="prefetch" href="/assets/js/237.6feb0534.js"><link rel="prefetch" href="/assets/js/238.57e64c14.js"><link rel="prefetch" href="/assets/js/239.8aeba238.js"><link rel="prefetch" href="/assets/js/24.933fffa9.js"><link rel="prefetch" href="/assets/js/240.864cffac.js"><link rel="prefetch" href="/assets/js/241.a1c6f45e.js"><link rel="prefetch" href="/assets/js/242.14475f90.js"><link rel="prefetch" href="/assets/js/243.fc4f7920.js"><link rel="prefetch" href="/assets/js/244.89f0d9fc.js"><link rel="prefetch" href="/assets/js/245.4836bb38.js"><link rel="prefetch" href="/assets/js/246.c3e0d73b.js"><link rel="prefetch" href="/assets/js/247.19eaf435.js"><link rel="prefetch" href="/assets/js/248.681c16e7.js"><link rel="prefetch" href="/assets/js/249.91c7786c.js"><link rel="prefetch" href="/assets/js/25.5a3957e2.js"><link rel="prefetch" href="/assets/js/250.999d9d17.js"><link rel="prefetch" href="/assets/js/251.758471d1.js"><link rel="prefetch" href="/assets/js/252.69b6befe.js"><link rel="prefetch" href="/assets/js/253.dd46a3dd.js"><link rel="prefetch" href="/assets/js/254.be5da0c1.js"><link rel="prefetch" href="/assets/js/255.d817ce68.js"><link rel="prefetch" href="/assets/js/256.2c7be7d4.js"><link rel="prefetch" href="/assets/js/257.a6b2fbe0.js"><link rel="prefetch" href="/assets/js/258.a5554c78.js"><link rel="prefetch" href="/assets/js/259.5a99fba0.js"><link rel="prefetch" href="/assets/js/26.fe1a83b5.js"><link rel="prefetch" href="/assets/js/260.41f4e520.js"><link rel="prefetch" href="/assets/js/261.0f73b7e7.js"><link rel="prefetch" href="/assets/js/262.28fa19f9.js"><link rel="prefetch" href="/assets/js/263.4bfbecf4.js"><link rel="prefetch" href="/assets/js/264.e0c89f62.js"><link rel="prefetch" href="/assets/js/265.e9e1d674.js"><link rel="prefetch" href="/assets/js/266.a63b71fb.js"><link rel="prefetch" href="/assets/js/267.420cd7e6.js"><link rel="prefetch" href="/assets/js/268.51e0f667.js"><link rel="prefetch" href="/assets/js/269.3f0d4774.js"><link rel="prefetch" href="/assets/js/27.916eabeb.js"><link rel="prefetch" href="/assets/js/270.c644f9d3.js"><link rel="prefetch" href="/assets/js/271.35387f6e.js"><link rel="prefetch" href="/assets/js/272.a776fe07.js"><link rel="prefetch" href="/assets/js/273.6e463c6b.js"><link rel="prefetch" href="/assets/js/274.8ef8b8e6.js"><link rel="prefetch" href="/assets/js/275.aa2e316d.js"><link rel="prefetch" href="/assets/js/276.9d603319.js"><link rel="prefetch" href="/assets/js/277.d428f5d6.js"><link rel="prefetch" href="/assets/js/278.f702bcfc.js"><link rel="prefetch" href="/assets/js/279.e1449e30.js"><link rel="prefetch" href="/assets/js/28.1116b232.js"><link rel="prefetch" href="/assets/js/280.7601eaee.js"><link rel="prefetch" href="/assets/js/281.84cdb64a.js"><link rel="prefetch" href="/assets/js/282.a6f561ff.js"><link rel="prefetch" href="/assets/js/283.c55742fa.js"><link rel="prefetch" href="/assets/js/284.924e0d7d.js"><link rel="prefetch" href="/assets/js/285.a997b1fb.js"><link rel="prefetch" href="/assets/js/286.cdb934a7.js"><link rel="prefetch" href="/assets/js/287.6f03d7f1.js"><link rel="prefetch" href="/assets/js/288.79e9f811.js"><link rel="prefetch" href="/assets/js/289.4861ef8b.js"><link rel="prefetch" href="/assets/js/29.6bff2814.js"><link rel="prefetch" href="/assets/js/290.e5a58a2f.js"><link rel="prefetch" href="/assets/js/291.9fee54ed.js"><link rel="prefetch" href="/assets/js/292.f8550342.js"><link rel="prefetch" href="/assets/js/293.5f22eb00.js"><link rel="prefetch" href="/assets/js/294.0a21c523.js"><link rel="prefetch" href="/assets/js/295.278a632b.js"><link rel="prefetch" href="/assets/js/296.ffc317e3.js"><link rel="prefetch" href="/assets/js/297.239cab1c.js"><link rel="prefetch" href="/assets/js/298.9f79e196.js"><link rel="prefetch" href="/assets/js/299.5f334485.js"><link rel="prefetch" href="/assets/js/3.bc6bba9e.js"><link rel="prefetch" href="/assets/js/30.218767d4.js"><link rel="prefetch" href="/assets/js/300.0ba14677.js"><link rel="prefetch" href="/assets/js/301.e8f27c97.js"><link rel="prefetch" href="/assets/js/302.c122edfe.js"><link rel="prefetch" href="/assets/js/303.da637783.js"><link rel="prefetch" href="/assets/js/304.4ec1b29e.js"><link rel="prefetch" href="/assets/js/305.3c00ea1f.js"><link rel="prefetch" href="/assets/js/306.b20e9815.js"><link rel="prefetch" href="/assets/js/307.6b91424e.js"><link rel="prefetch" href="/assets/js/308.dc89c12c.js"><link rel="prefetch" href="/assets/js/309.cc9c859e.js"><link rel="prefetch" href="/assets/js/31.2759a7a8.js"><link rel="prefetch" href="/assets/js/310.a9d45b6b.js"><link rel="prefetch" href="/assets/js/311.2054a97f.js"><link rel="prefetch" href="/assets/js/312.4bbc87ce.js"><link rel="prefetch" href="/assets/js/313.6bfffef1.js"><link rel="prefetch" href="/assets/js/314.80c7873d.js"><link rel="prefetch" href="/assets/js/315.e2b4b0eb.js"><link rel="prefetch" href="/assets/js/316.3e4bf82f.js"><link rel="prefetch" href="/assets/js/317.67d43206.js"><link rel="prefetch" href="/assets/js/318.29c1cdea.js"><link rel="prefetch" href="/assets/js/319.902203c8.js"><link rel="prefetch" href="/assets/js/32.49c74da8.js"><link rel="prefetch" href="/assets/js/320.9f322f6c.js"><link rel="prefetch" href="/assets/js/321.9ec16835.js"><link rel="prefetch" href="/assets/js/322.3afb0458.js"><link rel="prefetch" href="/assets/js/323.7c17fa0a.js"><link rel="prefetch" href="/assets/js/324.99ba59d2.js"><link rel="prefetch" href="/assets/js/325.6317221b.js"><link rel="prefetch" href="/assets/js/326.05691f3e.js"><link rel="prefetch" href="/assets/js/327.57a0752b.js"><link rel="prefetch" href="/assets/js/328.bd689f6c.js"><link rel="prefetch" href="/assets/js/329.9d95b288.js"><link rel="prefetch" href="/assets/js/33.da97d900.js"><link rel="prefetch" href="/assets/js/330.3f1aabde.js"><link rel="prefetch" href="/assets/js/331.4d2b6bf2.js"><link rel="prefetch" href="/assets/js/332.3d04f06d.js"><link rel="prefetch" href="/assets/js/333.f76ff221.js"><link rel="prefetch" href="/assets/js/334.cd2fc1ea.js"><link rel="prefetch" href="/assets/js/335.03d03979.js"><link rel="prefetch" href="/assets/js/336.4190f1ee.js"><link rel="prefetch" href="/assets/js/337.fdb48b71.js"><link rel="prefetch" href="/assets/js/338.7db8c869.js"><link rel="prefetch" href="/assets/js/339.90cdb7f0.js"><link rel="prefetch" href="/assets/js/34.42f8b6ab.js"><link rel="prefetch" href="/assets/js/340.4ba3bbd5.js"><link rel="prefetch" href="/assets/js/341.697b02a9.js"><link rel="prefetch" href="/assets/js/342.4af3bc4a.js"><link rel="prefetch" href="/assets/js/343.ba3f5e26.js"><link rel="prefetch" href="/assets/js/344.a3cf4ad3.js"><link rel="prefetch" href="/assets/js/345.d00eb266.js"><link rel="prefetch" href="/assets/js/346.74f1e6d3.js"><link rel="prefetch" href="/assets/js/347.cc3995b9.js"><link rel="prefetch" href="/assets/js/348.37774278.js"><link rel="prefetch" href="/assets/js/349.94d05b9c.js"><link rel="prefetch" href="/assets/js/35.42c35a21.js"><link rel="prefetch" href="/assets/js/350.47f1df55.js"><link rel="prefetch" href="/assets/js/351.1627936d.js"><link rel="prefetch" href="/assets/js/352.277ab034.js"><link rel="prefetch" href="/assets/js/353.c11e8bb5.js"><link rel="prefetch" href="/assets/js/354.ba01078c.js"><link rel="prefetch" href="/assets/js/356.94f404af.js"><link rel="prefetch" href="/assets/js/357.ec546a74.js"><link rel="prefetch" href="/assets/js/358.d72741b2.js"><link rel="prefetch" href="/assets/js/359.31c31ceb.js"><link rel="prefetch" href="/assets/js/36.c3767d58.js"><link rel="prefetch" href="/assets/js/360.a654dc23.js"><link rel="prefetch" href="/assets/js/361.46441143.js"><link rel="prefetch" href="/assets/js/362.0aa22356.js"><link rel="prefetch" href="/assets/js/363.355f7781.js"><link rel="prefetch" href="/assets/js/364.7e5168cd.js"><link rel="prefetch" href="/assets/js/365.b5f9bbf4.js"><link rel="prefetch" href="/assets/js/366.35422147.js"><link rel="prefetch" href="/assets/js/367.17af4dd9.js"><link rel="prefetch" href="/assets/js/368.99c04015.js"><link rel="prefetch" href="/assets/js/369.6e269202.js"><link rel="prefetch" href="/assets/js/37.b8f739e7.js"><link rel="prefetch" href="/assets/js/370.4c9fc0f9.js"><link rel="prefetch" href="/assets/js/371.fe9ddc42.js"><link rel="prefetch" href="/assets/js/372.a1a19937.js"><link rel="prefetch" href="/assets/js/373.8244356e.js"><link rel="prefetch" href="/assets/js/374.046bb182.js"><link rel="prefetch" href="/assets/js/375.95079f01.js"><link rel="prefetch" href="/assets/js/376.cb4cbf85.js"><link rel="prefetch" href="/assets/js/377.7f9dcc45.js"><link rel="prefetch" href="/assets/js/378.8396aba6.js"><link rel="prefetch" href="/assets/js/379.78f55713.js"><link rel="prefetch" href="/assets/js/38.cfd18851.js"><link rel="prefetch" href="/assets/js/380.9df95a65.js"><link rel="prefetch" href="/assets/js/381.db02d710.js"><link rel="prefetch" href="/assets/js/382.f5f01bd1.js"><link rel="prefetch" href="/assets/js/383.551a9e39.js"><link rel="prefetch" href="/assets/js/384.521cbf24.js"><link rel="prefetch" href="/assets/js/385.ce4ea212.js"><link rel="prefetch" href="/assets/js/386.3f4d7458.js"><link rel="prefetch" href="/assets/js/387.70a5c9bc.js"><link rel="prefetch" href="/assets/js/388.6d8e6a12.js"><link rel="prefetch" href="/assets/js/389.0088e683.js"><link rel="prefetch" href="/assets/js/39.af3d4c88.js"><link rel="prefetch" href="/assets/js/390.ac189a90.js"><link rel="prefetch" href="/assets/js/391.77894ec3.js"><link rel="prefetch" href="/assets/js/392.94725ec9.js"><link rel="prefetch" href="/assets/js/393.0d91a9e5.js"><link rel="prefetch" href="/assets/js/394.035a8e79.js"><link rel="prefetch" href="/assets/js/395.6dfbee1b.js"><link rel="prefetch" href="/assets/js/396.beb18051.js"><link rel="prefetch" href="/assets/js/397.5326e3a9.js"><link rel="prefetch" href="/assets/js/398.02a3983e.js"><link rel="prefetch" href="/assets/js/399.59d68b2b.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.feab1c20.js"><link rel="prefetch" href="/assets/js/400.f8253cec.js"><link rel="prefetch" href="/assets/js/401.fe8992b6.js"><link rel="prefetch" href="/assets/js/402.c0f7e134.js"><link rel="prefetch" href="/assets/js/403.48996262.js"><link rel="prefetch" href="/assets/js/41.e39d4dc8.js"><link rel="prefetch" href="/assets/js/42.61fe8caf.js"><link rel="prefetch" href="/assets/js/43.a9b01c27.js"><link rel="prefetch" href="/assets/js/44.d0b30ba2.js"><link rel="prefetch" href="/assets/js/45.c503c388.js"><link rel="prefetch" href="/assets/js/46.7206f25e.js"><link rel="prefetch" href="/assets/js/47.f3038db2.js"><link rel="prefetch" href="/assets/js/48.5cb39349.js"><link rel="prefetch" href="/assets/js/49.f05e5dfa.js"><link rel="prefetch" href="/assets/js/5.7098d77a.js"><link rel="prefetch" href="/assets/js/50.f4051900.js"><link rel="prefetch" href="/assets/js/51.140718cc.js"><link rel="prefetch" href="/assets/js/52.df8cb15f.js"><link rel="prefetch" href="/assets/js/53.9322d2fd.js"><link rel="prefetch" href="/assets/js/54.083c2849.js"><link rel="prefetch" href="/assets/js/55.0db6b109.js"><link rel="prefetch" href="/assets/js/56.e36d9f94.js"><link rel="prefetch" href="/assets/js/57.aadb73ac.js"><link rel="prefetch" href="/assets/js/58.e0181ca8.js"><link rel="prefetch" href="/assets/js/59.71fa8395.js"><link rel="prefetch" href="/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/assets/js/60.ccbd5c67.js"><link rel="prefetch" href="/assets/js/61.b29ac4b8.js"><link rel="prefetch" href="/assets/js/62.2c041d9f.js"><link rel="prefetch" href="/assets/js/63.02e68290.js"><link rel="prefetch" href="/assets/js/64.52025364.js"><link rel="prefetch" href="/assets/js/65.821d4920.js"><link rel="prefetch" href="/assets/js/66.b01a2e1f.js"><link rel="prefetch" href="/assets/js/67.49786e78.js"><link rel="prefetch" href="/assets/js/68.c6418f35.js"><link rel="prefetch" href="/assets/js/69.7bd0a0e3.js"><link rel="prefetch" href="/assets/js/7.6a854e57.js"><link rel="prefetch" href="/assets/js/70.6bacad63.js"><link rel="prefetch" href="/assets/js/71.2d2f55cb.js"><link rel="prefetch" href="/assets/js/72.385a2106.js"><link rel="prefetch" href="/assets/js/73.3567215b.js"><link rel="prefetch" href="/assets/js/74.66d5e54d.js"><link rel="prefetch" href="/assets/js/75.e9939676.js"><link rel="prefetch" href="/assets/js/76.ef329155.js"><link rel="prefetch" href="/assets/js/77.704b996e.js"><link rel="prefetch" href="/assets/js/78.6a6ccbbc.js"><link rel="prefetch" href="/assets/js/79.a908ba71.js"><link rel="prefetch" href="/assets/js/80.a6cc65ef.js"><link rel="prefetch" href="/assets/js/81.55fd7628.js"><link rel="prefetch" href="/assets/js/82.9fd118ce.js"><link rel="prefetch" href="/assets/js/83.25043008.js"><link rel="prefetch" href="/assets/js/84.ec86d293.js"><link rel="prefetch" href="/assets/js/85.b4faa1bb.js"><link rel="prefetch" href="/assets/js/86.beade549.js"><link rel="prefetch" href="/assets/js/87.c816be2a.js"><link rel="prefetch" href="/assets/js/88.453dd1c1.js"><link rel="prefetch" href="/assets/js/89.eae28977.js"><link rel="prefetch" href="/assets/js/90.05307532.js"><link rel="prefetch" href="/assets/js/91.fd8bd853.js"><link rel="prefetch" href="/assets/js/92.14aed080.js"><link rel="prefetch" href="/assets/js/93.f1b00b72.js"><link rel="prefetch" href="/assets/js/94.debf50a7.js"><link rel="prefetch" href="/assets/js/95.f9a158ae.js"><link rel="prefetch" href="/assets/js/96.2833401e.js"><link rel="prefetch" href="/assets/js/97.957e0ee5.js"><link rel="prefetch" href="/assets/js/98.9c305f09.js"><link rel="prefetch" href="/assets/js/99.c8981936.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="思源笔记" class="logo"> <span class="site-name can-hide">思源笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/Python/" class="sidebar-heading clickable router-link-active open"><span>Python</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/CPython源码剖析/" class="sidebar-heading clickable"><span>CPython源码剖析</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python常用模块/" class="sidebar-heading clickable"><span>Python常用模块</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python常见问题.html" class="sidebar-link">Python常见问题</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python编程核心/" class="sidebar-heading clickable open"><span>Python编程核心</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/内存管理、垃圾回收/" class="sidebar-heading clickable"><span>内存管理、垃圾回收</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/函数/" class="sidebar-heading clickable"><span>函数</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/多语言混合开发/" class="sidebar-heading clickable"><span>多语言混合开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/并发编程/" class="sidebar-heading clickable"><span>并发编程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/杂/" class="sidebar-heading clickable"><span>杂</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/模块化、私有化/" class="sidebar-heading clickable"><span>模块化、私有化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/测试加密打包部署/" class="sidebar-heading clickable"><span>测试加密打包部署</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/环境配置/" class="sidebar-heading clickable"><span>环境配置</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/语法基础/" class="sidebar-heading clickable"><span>语法基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/调试优化dump分析/" class="sidebar-heading clickable open"><span>调试优化dump分析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/debug/" class="sidebar-heading clickable"><span>debug</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/dump分析#TODO#/" class="sidebar-heading clickable"><span>dump分析#TODO#</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/profile/" class="sidebar-heading clickable"><span>profile</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/typing：静态类型检查/" class="sidebar-heading clickable"><span>typing：静态类型检查</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python编程核心/调试优化dump分析/其他线上调试工具.html" class="sidebar-link">其他线上调试工具</a></li><li><a href="/Python/Python编程核心/调试优化dump分析/奇奇怪怪的python优化点.html" class="sidebar-link">奇奇怪怪的python优化点</a></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/" class="sidebar-heading clickable open"><span>所谓性能优化</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html" class="active sidebar-link">Python程序性能优化实战2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#reference" class="sidebar-link">Reference</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#the-floyd-steinberg-dithering-algorithm" class="sidebar-link">The Floyd-Steinberg dithering algorithm</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#a-naive-implementation" class="sidebar-link">A naive implementation</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#some-concepts-you-should-know" class="sidebar-link">Some concepts you should know</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#considering-what-to-optimize" class="sidebar-link">Considering what to optimize</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#optimizing-rounding" class="sidebar-link">Optimizing rounding</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#optimizing-memory-usage" class="sidebar-link">Optimizing memory usage</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#gaining-back-some-performance" class="sidebar-link">Gaining back some performance</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#going-even-faster" class="sidebar-link">Going even faster</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#reducing-memory-reads-and-writes" class="sidebar-link">Reducing memory reads and writes</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html#relaxing-our-accuracy-requirements" class="sidebar-link">Relaxing our accuracy requirements</a></li></ul></li><li><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html" class="sidebar-link">python程序性能优化实战1</a></li><li><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/四类优化方案.html" class="sidebar-link">四类优化方案</a></li></ul></section></li><li><a href="/Python/Python编程核心/调试优化dump分析/概述.html" class="sidebar-link">概述</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/面向对象/" class="sidebar-heading clickable"><span>面向对象</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/鸭子类型/" class="sidebar-heading clickable"><span>鸭子类型</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="python程序性能优化实战2"><a href="#python程序性能优化实战2" class="header-anchor">#</a> Python程序性能优化实战2</h1> <h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <ul><li><a href="https://pythonspeed.com/articles/optimizing-dithering/" target="_blank" rel="noopener noreferrer">https://pythonspeed.com/articles/optimizing-dithering/ - Python⇒Speed<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>‍</p> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>The common advice when Python is too slow is to switch to a low-level compiled language like Cython or Rust. But what do you do if <em>that</em> code is too slow? At that point you might start thinking about parallelism: using multi-threading or multi-processing so you can take advantage of multiple CPU cores.</p> <p>But parallelism comes with its own set of complexities; at the very least, some algorithms can only really work in a single-threaded way. So what can you do?</p> <p><strong>As it turns out, there’s often still plenty of performance improvements you can get just by tweaking your low-level code.</strong>  As a real-world example, in this article we’ll go about optimizing Floyd-Steinberg error diffusion dithering. The specific variant of the algorithm that we will implement converts a grayscale image with values of 0 to 255 into an image with just two colors, black and white.</p> <p>Because of the specifics of this algorithm, it’s quite difficult or perhaps even impossible to parallelize with threading. But you can still make it run faster.</p> <blockquote><p>**This article is an excerpt from a book I’m working on that will help **​****​ <strong>, the kind of code you’d write with C, Cython, or Rust.</strong>  The goal is to help data scientists and scientists who normally write Python to understand how to make their compiled code faster.</p></blockquote> <p>‍</p> <h2 id="the-floyd-steinberg-dithering-algorithm"><a href="#the-floyd-steinberg-dithering-algorithm" class="header-anchor">#</a> The Floyd-Steinberg dithering algorithm</h2> <p>As explained in the <a href="https://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering" target="_blank" rel="noopener noreferrer">Wikipedia article<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, we can use this algorithm to convert a grayscale image into just two colors, black and white. The algorithm rounds a pixel’s value to the nearest of the two extremes (0 for black or 255 for white). The difference between the original value and the rounded value, known as the error, is added to neighboring pixels, with the following distribution:</p> <div class="language- extra-class"><pre class="language-text"><code>[ ...            , current pixel (rounded)   , + 7/16 of error, ... ]
[ + 3/16 of error, + 5/16 of error           , + 1/16 of error, ... ]
</code></pre></div><p>So the next pixel on the row gets 7/16th of the error, and the pixel one row down gets 5/16th of the error, and so on. Once the current pixel is processed, the algorithm moves on to the next pixel, which now includes some of the error from the previous pixel.</p> <p>One key issue with optimizing this algorithm is that it’s likely impossible to process pixels in parallel: each pixel’s final value is impacted by the calculations done on previous pixels. This suggests that using multiple threads for parallelism might be difficult or impossible; using SIMD may also be difficult (see below for a quick explanation of SIMD). Still, given a naive implementation there are some ways to speed things up.</p> <p>Let’s load the libraries we’ll be using, as well as a test image, a 400×400 NumPy array of <code>uint8</code>​s.</p> <p>Like <a href="https://pythonspeed.com/producs/lowlevelcode/" target="_blank" rel="noopener noreferrer">the book<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, the examples in this article all use <a href="https://pythonspeed.com/articles/numba-faster-python/" target="_blank" rel="noopener noreferrer">Numba<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, so you only need to understand Python syntax. If you decorate a function with <code>@numba.njit</code>​, Numba will compile it into low-level machine code, at runtime. Even if you’re not using Numba, the same basic optimizations techniques and concepts will apply to C++, Rust, or other low-level compiled languages.</p> <div class="language- extra-class"><pre class="language-text"><code>from numba import njit
import numpy as np
from skimage import io

image = io.imread(&quot;images/hallway.jpg&quot;)
</code></pre></div><p>Here’s what it looks like:</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/cell-2-output-2-20231107143557-7cwwik0.png" alt="The original image">​</p> <p>If this was more than an example, we’d want to benchmark the code with a variety of images and sizes, matching the variety of inputs we expect to encounter. For simplicity’s sake, however, we’ll stick to this single image.</p> <p>In the following section you’ll follow along as I start with a naive implementation, make it faster, reduce memory usage, and then optimize it some more. Some intermediate steps and failed experiments were omitted for clarity. Nonetheless, this is a real optimization exercise: these are all optimization ideas I came up with as I went along, as I had never optimized this algorithm before.</p> <h2 id="a-naive-implementation"><a href="#a-naive-implementation" class="header-anchor">#</a> A naive implementation</h2> <p>Here’s the first version I implemented. I didn’t try to make it slow or fast: I just tried to implement the algorithm.</p> <p>The code stores temporary results in 16-bit integers, because adding the error might make some pixels either negative or bigger than 255. Both those cases won’t fit in an unsigned 8-bit integer. At the end I turn the result into an 8-bit image, which is what the function is supposed to return.</p> <div class="language- extra-class"><pre class="language-text"><code># Code that is decorated with numba.njit looks like Python code, but is
# actually compiled into machine code, at runtime. This is fast, low-level
# code!
@njit
def dither(img):
    # Allow negative values and wider range than a uint8 has:
    result = img.astype(np.int16)
    y_size = img.shape[0]
    x_size = img.shape[1]
    last_y = y_size - 1
    last_x = x_size - 1
    for y in range(y_size):
        for x in range(x_size):
            old_value = result[y, x]
            if old_value &lt; 0:
                new_value = 0
            elif old_value &gt; 255:
                new_value = 255
            else:
                new_value = np.uint8(np.round(old_value / 255.0)) * 255
            result[y, x] = new_value
            # We might get a negative value for the error:
            error = np.int16(old_value) - new_value
            if x &lt; last_x:
                result[y, x + 1] += error * 7 // 16
            if y &lt; last_y and x &gt; 0:
                result[y + 1, x - 1] += error * 3 // 16
            if y &lt; last_y:
                result[y + 1, x] += error * 5 // 16
            if y &lt; last_y and x &lt; last_x:
                result[y + 1, x + 1] += error // 16

    return result.astype(np.uint8)

baseline_result = dither(image)
</code></pre></div><p>Here’s what it looks like:</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/cell-4-output-2-20231107143557-7zqwzz1.png" alt="The dithered image">​</p> <p>And here’s how long it takes to run:</p> <table><thead><tr><th>Code</th> <th>Time to run (milliseconds)</th></tr></thead> <tbody><tr><td>​<code>dither(image)</code>​</td> <td>2.3</td></tr></tbody></table> <h2 id="some-concepts-you-should-know"><a href="#some-concepts-you-should-know" class="header-anchor">#</a> Some concepts you should know</h2> <p>The optimizations we’ll use below rely on concepts that are covered in much more detail in <a href="https://pythonspeed.com/products/lowlevelcode/" target="_blank" rel="noopener noreferrer">the book it’s based on<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. To help you understand this article on its own, however, here are some quick explanations:</p> <ul><li><strong>Instruction-level parallelism (ILP):</strong>  Your CPU can transparently run multiple operations in parallel, on a single CPU core, so long as they don’t depend on each other. In other words, ILP makes your code faster without any work on your part, at least when it’s possible.</li> <li><strong>Branch prediction:</strong>  To help with ILP, your CPU will try to predict whether or not branches—<code>if</code>​ statements and the like—will be taken. If the prediction is wrong, your code will get a lot slower as the CPU needs to undo the speculative work it did.</li> <li><strong>SIMD (Single Instruction, Multiple Data):</strong>  If the compiler emits the right CPU instructions, the CPU can do the same operation, for example adding a number, to multiple numbers at the same time with a single instruction.</li> <li>**Memory hierarchy:**​<a href="https://pythonspeed.com/articles/performance-memory-locality/" target="_blank" rel="noopener noreferrer">Reading and writing from memory is slow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, so your CPU has caches (L1, L2, L3) to speed up access. Your CPU also has a small number of extra-fast “registers”, locations where it can keep small values like 64-bit numbers and run operations directly on the values.</li></ul> <p>All these concepts and how they can help you speed up your code will be covered in far more detail in <a href="https://pythonspeed.com/products/lowlevelcode/" target="_blank" rel="noopener noreferrer">the upcoming book<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="considering-what-to-optimize"><a href="#considering-what-to-optimize" class="header-anchor">#</a> Considering what to optimize</h2> <p>In general, we want to make the inner part of the loop as fast as possible. Looking at the error diffusion part of the part of the code, instruction-level parallelism ought to help speed up running the code, given that each calculation is independent:</p> <div class="language- extra-class"><pre class="language-text"><code>if x &lt; last_x:
    result[y, x + 1] += error * 7 // 16
if y &lt; last_y and x &gt; 0:
    result[y + 1, x - 1] += error * 3 // 16
if y &lt; last_y:
    result[y + 1, x] += error * 5 // 16
if y &lt; last_y and x &lt; last_x:
    result[y + 1, x + 1] += error // 16
</code></pre></div><p>What about all those branches—will branch misprediction make them slow? A little thought suggests that these branches are very predictable because they depend only on the pixel location. Consider a 6×6 image: depending on the location of a pixel in the image, different combinations of branches will be taken.</p> <div class="language- extra-class"><pre class="language-text"><code>1 2 2 2 2 3
1 2 2 2 2 3
1 2 2 2 2 3
1 2 2 2 2 3
1 2 2 2 2 3
4 5 5 5 5 6
</code></pre></div><p>For example, pixels in zones 1 and 4 won’t be able to diffuse the error to the previous column, because there is no previous column. Therefore the relevant branch (<code>if y &lt; last_y and x &gt; 0</code>​) won’t be taken.</p> <p>In larger images, virtually all the pixels will be in zone 2, with the exact same branches taken, so the CPU ought to be able to reliably predict those branches. Thus a reasonable assumption is that the diffusion part of the code is running at a decent speed even in its current state.</p> <p>In contrast, the calculation of the error itself seems potentially slow:</p> <div class="language- extra-class"><pre class="language-text"><code>if old_value &lt; 0:
    new_value = 0
elif old_value &gt; 255:
    new_value = 255
else:
    new_value = np.uint8(np.round(old_value / 255.0)) * 255
</code></pre></div><p>First, the branches depend on the values of the pixels, so they may be hard for the CPU to predict, and it’s not clear whether the compiler will generate branchless code. Second, there’s some relatively complex math going on: rounding a float seems like it would be slow.</p> <h2 id="optimizing-rounding"><a href="#optimizing-rounding" class="header-anchor">#</a> Optimizing rounding</h2> <p>The naive rounding implementation addresses three possible cases for intermediate pixel values:</p> <ol><li>Negative numbers should be rounded to 0 (black).</li> <li>Numbers larger than 255 should be rounded 255 (white).</li> <li>Numbers in between should be rounded to the closest of 0 to 255.</li></ol> <p>All of this can be simplified into a single simple check: measuring whether the pixel value is smaller or bigger than the middle point. In Python: <code>new_value = 0 if old_value &lt; 128 else 255</code>​. Since <code>new_value</code>​ gets a value set in either case, the hope is that the compiler will turn this into branchless code, so we don’t have to worry about the cost of branch misprediction.</p> <div class="language- extra-class"><pre class="language-text"><code>@njit
def dither2(img):
    result = img.astype(np.int16)
    y_size = img.shape[0]
    x_size = img.shape[1]
    last_y = y_size - 1
    last_x = x_size - 1
    for y in range(y_size):
        for x in range(x_size):
            old_value = result[y, x]
            # Branchless, simple rounding:
            new_value = 0 if old_value &lt; 128 else 255
            result[y, x] = new_value
            error = old_value - new_value
            if x &lt; last_x:
                result[y, x + 1] += error * 7 // 16
            if y &lt; last_y and x &gt; 0:
                result[y + 1, x - 1] += error * 3 // 16
            if y &lt; last_y:
                result[y + 1, x] += error * 5 // 16
            if y &lt; last_y and x &lt; last_x:
                result[y + 1, x + 1] += error // 16
    return result.astype(np.uint8)

assert np.array_equal(dither2(image), baseline_result)
</code></pre></div><p>Here’s how long it takes to run:</p> <table><thead><tr><th>Code</th> <th>Time to run (microseconds)</th></tr></thead> <tbody><tr><td>​<code>dither2(image)</code>​</td> <td>830.7</td></tr></tbody></table> <p>That’s a lot better! Remember, 1000 microseconds is 1 millisecond.</p> <h2 id="optimizing-memory-usage"><a href="#optimizing-memory-usage" class="header-anchor">#</a> Optimizing memory usage</h2> <p>While the code is now a lot faster, there’s another problem to consider: it’s using quite a lot of memory. The input image uses N bytes of memory, one <code>uint8</code>​ per pixel. <code>dither()</code>​ and <code>dither2()</code>​ both allocate 3N bytes: an <code>int16</code>​ array costs 2 bytes per pixel, and the final <code>uint8</code>​ result array is an additional byte per pixel.</p> <p>We can improve this by noticing that intermediate error accumulation only happens on the current row and the next row. And once we’re done with a row it always fits in 8 bits and never changes again. So we really only need to keep 2 rows worth of memory as <code>int16</code>​, and we can reuse the same memory as we traverse the image:</p> <div class="language- extra-class"><pre class="language-text"><code>@njit
def dither3(img):
    result = np.empty(img.shape, dtype=np.uint8)
    # Temporary storage of current and next row's intermediate values:
    staging = img[0:2].astype(np.int16)
    y_size = img.shape[0]
    x_size = img.shape[1]
    last_x = x_size - 1
    for y in range(y_size):
        for x in range(x_size):
            old_value = staging[0, x]
            new_value = 0 if old_value &lt; 128 else 255
            staging[0, x] = new_value
            error = old_value - new_value
            if x &lt; last_x:
                staging[0, x + 1] += error * 7 // 16
            if x &gt; 0:
                staging[1, x - 1] += error * 3 // 16
            staging[1, x] += error * 5 // 16
            if x &lt; last_x:
                staging[1, x + 1] += error // 16

        # Copy current row of staging into result:
        result[y,:] = staging[0,:]
        # Prepare staging area for next iteration:
        staging[0,:] = staging[1,:]
        if y &lt; y_size - 2:
            staging[1,:] = img[y + 2,:]
    return result

assert np.array_equal(dither3(image), baseline_result)
</code></pre></div><p>Here’s how long it takes to run:</p> <table><thead><tr><th>Code</th> <th>Time to run (microseconds)</th></tr></thead> <tbody><tr><td>​<code>dither3(image)</code>​</td> <td>909.6</td></tr></tbody></table> <p>That’s a little slower than <code>dither2()</code>​, but still a lot faster than the original naive implementation. And now peak memory allocation is approximately N bytes, since the staging array doesn’t use much memory. Put another way, this version cuts memory usage by two-thirds.</p> <h2 id="gaining-back-some-performance"><a href="#gaining-back-some-performance" class="header-anchor">#</a> Gaining back some performance</h2> <p>The new version is probably slower because it does a bunch of copying. Once processing the current row is done, the contents of the next row (<code>staging[1]</code>​) has to be copied into the current row (<code>staging[0]</code>​), in order to preserve the errors diffused to the next row. If we split our staging array into two, one for the current row and one for the next row, we can just swap those two arrays instead of copying the data.</p> <div class="language- extra-class"><pre class="language-text"><code>@njit
def dither4(img):
    result = np.empty(img.shape, dtype=np.uint8)
    # Two arrays, one for staging the current row and one for the next:
    staging_current = img[0].astype(np.int16)
    staging_next = img[1].astype(np.int16)
    y_size = img.shape[0]
    x_size = img.shape[1]
    last_x = x_size - 1
    for y in range(y_size):
        for x in range(x_size):
            old_value = staging_current[x]
            new_value = 0 if old_value &lt; 128 else 255
            staging_current[x] = new_value
            error = old_value - new_value
            if x &lt; last_x:
                staging_current[x + 1] += error * 7 // 16
            if x &gt; 0:
                staging_next[x - 1] += error * 3 // 16
            staging_next[x] += error * 5 // 16
            if x &lt; last_x:
                staging_next[x + 1] += error // 16

        # Copy current row of staging into result:
        result[y,:] = staging_current[:]
        # Switch the next row to be the current one, and copy in the next row's
        # initial data from the original image:
        staging_current, staging_next = staging_next, staging_current
        if y &lt; y_size - 2:
            staging_next[:] = img[y + 2,:]

    return result

assert np.array_equal(dither4(image), baseline_result)
</code></pre></div><p>Here’s how long it takes to run:</p> <table><thead><tr><th>Code</th> <th>Time to run (microseconds)</th></tr></thead> <tbody><tr><td>​<code>dither4(image)</code>​</td> <td>876.6</td></tr></tbody></table> <p>That’s slightly better.</p> <h2 id="going-even-faster"><a href="#going-even-faster" class="header-anchor">#</a> Going even faster</h2> <p>We still have all those annoying <code>if</code>​ statements in the main loop, which are used to handle edge pixels. For example, if you’re in the first column, it’s not possible to diffuse the errors to the previous column.</p> <p>We can get rid of those conditionals, though. The code currently has temporary staging arrays for accumulating errors, and there’s no reason they have to be the same size as the input or the result. We can just add an extra item at the start and end. As a result edge pixels can behave the same way as non-edge pixels, and we can get rid of the conditionals.</p> <p>As an additional optimization, notice that copying <code>staging_current</code>​ into the <code>result</code>​ array isn’t actually necessary. Once a pixel is finalized, it won’t change, so we can just write directly to <code>result</code>​ and skip updating <code>staging_current</code>​.</p> <div class="language- extra-class"><pre class="language-text"><code>@njit
def dither5(img):
    result = np.empty(img.shape, dtype=np.uint8)
    y_size = img.shape[0]
    x_size = img.shape[1]
    # The staging arrays have an extra entry at the start and at the end, so
    # that we don't need conditionals to handle edge pixels.
    staging_current = np.zeros(x_size + 2, np.int16)
    staging_current[1:-1] = img[0]
    staging_next = np.zeros(x_size + 2, np.int16)

    for y in range(y_size):
        # Copy in the next row's data:
        if y &lt; y_size - 1:
            staging_next[1:-1] = img[y + 1,:]

        for x in range(x_size):
            old_value = staging_current[x + 1]
            new_value = 0 if old_value &lt; 128 else 255
            # This is the final result, so we can store it directly in the
            # result:
            result[y, x] = new_value
            error = old_value - new_value
            staging_current[x + 2] += error * 7 // 16
            staging_next[x] += error * 3 // 16
            staging_next[x + 1] += error * 5 // 16
            staging_next[x + 2] += error // 16

        # Switch the next row to be the current one:
        staging_current, staging_next = staging_next, staging_current

    return result

assert np.array_equal(dither5(image), baseline_result)
</code></pre></div><p>Here’s how long it takes to run:</p> <table><thead><tr><th>Code</th> <th>Time to run (microseconds)</th></tr></thead> <tbody><tr><td>​<code>dither5(image)</code>​</td> <td>816</td></tr></tbody></table> <h2 id="reducing-memory-reads-and-writes"><a href="#reducing-memory-reads-and-writes" class="header-anchor">#</a> Reducing memory reads and writes</h2> <p>We can do even better! We’re doing a lot of reading and writing from <code>staging_current</code>​ and <code>staging_next</code>​, and this isn’t strictly necessary. If we can move some of the temporary integer values we’re accumulating to variables on the stack, they will likely end up being stored in CPU registers. Reading and writing from registers is faster than reading and writing memory, even when the CPU is using a fast cache to speed up the latter.</p> <div class="language- extra-class"><pre class="language-text"><code>@njit
def dither6(img):
    result = np.empty(img.shape, dtype=np.uint8)
    y_size = img.shape[0]
    x_size = img.shape[1]
    staging_current = np.zeros(x_size + 2, np.int16)
    staging_current[1:-1] = img[0]
    staging_next = np.zeros(x_size + 2, np.int16)

    for y in range(y_size):
        right_pixel_error = 0
        downleft_prev_error = 0
        downleft_prevprev_error = 0
        for x in range(x_size):
            old_value = staging_current[x + 1] + right_pixel_error
            new_value = 0 if old_value &lt; 128 else 255
            result[y, x] = new_value
            error = old_value - new_value
            right_pixel_error = error * 7 // 16
            # Now that we have all three sets of errors accumulated, store
            # them:
            staging_next[x] = (
                img[y + 1, x - 1] + downleft_prev_error + error * 3 // 16
            )
            # Accumulate errors for the next iteration:
            downleft_prev_error = downleft_prevprev_error + error * 5 // 16
            downleft_prevprev_error = error // 16

        # Update the final pixel in the next row; it only gets two diffused
        # errors, not three, so it doesn't get updated in the inner loop.
        staging_next[x_size] = img[y + 1, x_size - 1] + downleft_prev_error

        staging_current, staging_next = staging_next, staging_current

    return result

assert np.array_equal(dither6(image), baseline_result)
</code></pre></div><p>Comparing our updated code to the previous version:</p> <ul><li>Previously we read twice and wrote once to <code>staging_current</code>​ in every inner loop iteration. Now we only read once, and don’t write at all.</li> <li>Previously we read and wrote to <code>staging_next</code>​ three times in every inner loop iteration, and overwrote it once per outer loop. Now we only write once in every inner loop iteration, and don’t read at all.</li></ul> <p>Here’s how long it takes to run:</p> <table><thead><tr><th>Code</th> <th>Time to run (microseconds)</th></tr></thead> <tbody><tr><td>​<code>dither6(image)</code>​</td> <td>602.7</td></tr></tbody></table> <p>This version of the code is slightly harder to understand, but hopefully it’s not too bad.</p> <h2 id="relaxing-our-accuracy-requirements"><a href="#relaxing-our-accuracy-requirements" class="header-anchor">#</a> Relaxing our accuracy requirements</h2> <p>So far each optimized version made sure the results exactly matched the original version. This was helpful for catching bugs, but it’s not necessary. Dithering is a visual effect; most of the time, as long as it looks right, that’s all that matters.</p> <p>If we’re willing to accept slightly different results, we can centralize the division by 16. Since rounding the fractions happens slightly differently, the results are slightly different, but that’s fine.</p> <div class="language- extra-class"><pre class="language-text"><code>@njit
def dither7(img):
    result = np.empty(img.shape, dtype=np.uint8)
    y_size = img.shape[0]
    x_size = img.shape[1]
    staging_current = np.zeros(x_size + 2, np.int16)
    staging_current[1:-1] = img[0]
    staging_next = np.zeros(x_size + 2, np.int16)

    for y in range(y_size):
        right_pixel_error = 0
        downleft_prev_error = 0
        downleft_prevprev_error = 0
        for x in range(x_size):
            old_value = staging_current[x + 1] + right_pixel_error
            new_value = 0 if old_value &lt; 128 else 255
            result[y, x] = new_value
            error = old_value - new_value
            right_pixel_error = error * 7 // 16
            staging_next[x] = (
                img[y + 1, x - 1] + (downleft_prev_error + error * 3) // 16
            )
            # Don't divide by 16 yet, only do that when we store final version
            # in staging_next:
            downleft_prev_error = downleft_prevprev_error + error * 5
            downleft_prevprev_error = error

        staging_next[x_size] = (
            img[y + 1, x_size - 1] + downleft_prev_error // 16
        )

        staging_current, staging_next = staging_next, staging_current

    return result
</code></pre></div><p>Here’s what it looks like:</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/cell-18-output-2-20231107143557-w94ginj.png" alt="The dithered image">​</p> <p>And here’s a comparison to previous versions:</p> <table><thead><tr><th>Code</th> <th>Time to run (microseconds)</th></tr></thead> <tbody><tr><td>​<code>dither(image)</code>​</td> <td>2,339.5</td></tr> <tr><td>​<code>dither2(image)</code>​</td> <td>827.9</td></tr> <tr><td>​<code>dither3(image) # Bit slower, but reduces memory usage by 2/3rds</code>​</td> <td>909.7</td></tr> <tr><td>​<code>dither4(image)</code>​</td> <td>875.3</td></tr> <tr><td>​<code>dither5(image)</code>​</td> <td>814.3</td></tr> <tr><td>​<code>dither6(image)</code>​</td> <td>601.7</td></tr> <tr><td>​<code>dither7(image)</code>​</td> <td>553.9</td></tr></tbody></table> <p>Can <em>you</em> make this code even faster? If you give it a try and find some additional tricks, <a href="mailto:itamar@pythonspeed.com">let me know</a>. Note that some optimizations may be easier to identify and try if you go back and start from an earlier version of the code.</p> <p>And if you’d like to understand the concepts these optimizations rely on—ILP, branch prediction, SIMD, and more—<a href="https://pythonspeed.com/products/lowlevelcode/" target="_blank" rel="noopener noreferrer">sign up to get notified when the book is released<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/Python编程核心/调试优化dump分析/奇奇怪怪的python优化点.html" class="prev">
        奇奇怪怪的python优化点
      </a></span> <span class="next"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html">
        python程序性能优化实战1
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d3c0dc77.js" defer></script><script src="/assets/js/2.5fbe0391.js" defer></script><script src="/assets/js/1.dc7adba2.js" defer></script><script src="/assets/js/355.70321476.js" defer></script>
  </body>
</html>
