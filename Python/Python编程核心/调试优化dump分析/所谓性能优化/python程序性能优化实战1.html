<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>python程序性能优化实战1 | 思源笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link href="/images/logo.png" rel="icon">
    <meta name="description" content="来自思源笔记的内容">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.d3c0dc77.js" as="script"><link rel="preload" href="/assets/js/2.5fbe0391.js" as="script"><link rel="preload" href="/assets/js/1.dc7adba2.js" as="script"><link rel="preload" href="/assets/js/357.ec546a74.js" as="script"><link rel="prefetch" href="/assets/js/10.a9ace829.js"><link rel="prefetch" href="/assets/js/100.1ffa901d.js"><link rel="prefetch" href="/assets/js/101.37fdabbb.js"><link rel="prefetch" href="/assets/js/102.9c0f99bd.js"><link rel="prefetch" href="/assets/js/103.571daa23.js"><link rel="prefetch" href="/assets/js/104.88901889.js"><link rel="prefetch" href="/assets/js/105.e1c7fc4a.js"><link rel="prefetch" href="/assets/js/106.366c43d3.js"><link rel="prefetch" href="/assets/js/107.077c5081.js"><link rel="prefetch" href="/assets/js/108.c7d4e1fb.js"><link rel="prefetch" href="/assets/js/109.e7b7cb8f.js"><link rel="prefetch" href="/assets/js/11.32adc493.js"><link rel="prefetch" href="/assets/js/110.86cb08fa.js"><link rel="prefetch" href="/assets/js/111.b725586a.js"><link rel="prefetch" href="/assets/js/112.9f3b9f75.js"><link rel="prefetch" href="/assets/js/113.4a5023eb.js"><link rel="prefetch" href="/assets/js/114.6556c4e7.js"><link rel="prefetch" href="/assets/js/115.72cdb14c.js"><link rel="prefetch" href="/assets/js/116.6d5b51c2.js"><link rel="prefetch" href="/assets/js/117.65ec9b76.js"><link rel="prefetch" href="/assets/js/118.7f4861c9.js"><link rel="prefetch" href="/assets/js/119.650ac25d.js"><link rel="prefetch" href="/assets/js/12.92b47e85.js"><link rel="prefetch" href="/assets/js/120.8e7250e1.js"><link rel="prefetch" href="/assets/js/121.c5a06028.js"><link rel="prefetch" href="/assets/js/122.29f4e7bd.js"><link rel="prefetch" href="/assets/js/123.5e449baf.js"><link rel="prefetch" href="/assets/js/124.a44b0134.js"><link rel="prefetch" href="/assets/js/125.df3fe3e7.js"><link rel="prefetch" href="/assets/js/126.6974e54f.js"><link rel="prefetch" href="/assets/js/127.f2454306.js"><link rel="prefetch" href="/assets/js/128.b900fa7e.js"><link rel="prefetch" href="/assets/js/129.15864c0a.js"><link rel="prefetch" href="/assets/js/13.ebfb1f42.js"><link rel="prefetch" href="/assets/js/130.cc6853ea.js"><link rel="prefetch" href="/assets/js/131.5bb214da.js"><link rel="prefetch" href="/assets/js/132.1a83e445.js"><link rel="prefetch" href="/assets/js/133.da4547b9.js"><link rel="prefetch" href="/assets/js/134.0aeb00a9.js"><link rel="prefetch" href="/assets/js/135.16eb5d31.js"><link rel="prefetch" href="/assets/js/136.67396e70.js"><link rel="prefetch" href="/assets/js/137.afeb5d96.js"><link rel="prefetch" href="/assets/js/138.36e805ef.js"><link rel="prefetch" href="/assets/js/139.7d8c0405.js"><link rel="prefetch" href="/assets/js/14.3e65117c.js"><link rel="prefetch" href="/assets/js/140.6df70824.js"><link rel="prefetch" href="/assets/js/141.f642dacf.js"><link rel="prefetch" href="/assets/js/142.10230571.js"><link rel="prefetch" href="/assets/js/143.d599ee24.js"><link rel="prefetch" href="/assets/js/144.e1a88c20.js"><link rel="prefetch" href="/assets/js/145.eb357101.js"><link rel="prefetch" href="/assets/js/146.b3fe7f16.js"><link rel="prefetch" href="/assets/js/147.dbfb2f7d.js"><link rel="prefetch" href="/assets/js/148.8ed5bf1d.js"><link rel="prefetch" href="/assets/js/149.2c73c82d.js"><link rel="prefetch" href="/assets/js/15.5304afab.js"><link rel="prefetch" href="/assets/js/150.78115158.js"><link rel="prefetch" href="/assets/js/151.22badb82.js"><link rel="prefetch" href="/assets/js/152.a99d0f22.js"><link rel="prefetch" href="/assets/js/153.6a863a43.js"><link rel="prefetch" href="/assets/js/154.c6a0b3dc.js"><link rel="prefetch" href="/assets/js/155.b8591455.js"><link rel="prefetch" href="/assets/js/156.dd9eeca0.js"><link rel="prefetch" href="/assets/js/157.48909220.js"><link rel="prefetch" href="/assets/js/158.99fac6bc.js"><link rel="prefetch" href="/assets/js/159.3bcae7d0.js"><link rel="prefetch" href="/assets/js/16.9ca9aae8.js"><link rel="prefetch" href="/assets/js/160.7c8a9be5.js"><link rel="prefetch" href="/assets/js/161.30bee0bb.js"><link rel="prefetch" href="/assets/js/162.0dde5818.js"><link rel="prefetch" href="/assets/js/163.d4de9cde.js"><link rel="prefetch" href="/assets/js/164.1aa26354.js"><link rel="prefetch" href="/assets/js/165.67d8c450.js"><link rel="prefetch" href="/assets/js/166.81d14b26.js"><link rel="prefetch" href="/assets/js/167.ae715f9a.js"><link rel="prefetch" href="/assets/js/168.f2998afb.js"><link rel="prefetch" href="/assets/js/169.fd39ee46.js"><link rel="prefetch" href="/assets/js/17.3dbcb51f.js"><link rel="prefetch" href="/assets/js/170.147fd31a.js"><link rel="prefetch" href="/assets/js/171.35f8ce60.js"><link rel="prefetch" href="/assets/js/172.10db3085.js"><link rel="prefetch" href="/assets/js/173.11a8ff33.js"><link rel="prefetch" href="/assets/js/174.e196a1f6.js"><link rel="prefetch" href="/assets/js/175.0157f18d.js"><link rel="prefetch" href="/assets/js/176.6d3d456c.js"><link rel="prefetch" href="/assets/js/177.9c40b853.js"><link rel="prefetch" href="/assets/js/178.8dd00920.js"><link rel="prefetch" href="/assets/js/179.f7f4c661.js"><link rel="prefetch" href="/assets/js/18.4c170722.js"><link rel="prefetch" href="/assets/js/180.d02b4575.js"><link rel="prefetch" href="/assets/js/181.be3c0f7a.js"><link rel="prefetch" href="/assets/js/182.ae4673f8.js"><link rel="prefetch" href="/assets/js/183.ed56a865.js"><link rel="prefetch" href="/assets/js/184.43db12b1.js"><link rel="prefetch" href="/assets/js/185.3a09c20e.js"><link rel="prefetch" href="/assets/js/186.77240fee.js"><link rel="prefetch" href="/assets/js/187.c544cb6a.js"><link rel="prefetch" href="/assets/js/188.682782b1.js"><link rel="prefetch" href="/assets/js/189.1e81f7d7.js"><link rel="prefetch" href="/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/assets/js/190.c60243cc.js"><link rel="prefetch" href="/assets/js/191.841c59cf.js"><link rel="prefetch" href="/assets/js/192.6b3c14f5.js"><link rel="prefetch" href="/assets/js/193.47319c1f.js"><link rel="prefetch" href="/assets/js/194.95c798e0.js"><link rel="prefetch" href="/assets/js/195.258b0234.js"><link rel="prefetch" href="/assets/js/196.c5e95bf4.js"><link rel="prefetch" href="/assets/js/197.0a40131d.js"><link rel="prefetch" href="/assets/js/198.6ae77026.js"><link rel="prefetch" href="/assets/js/199.be929f6f.js"><link rel="prefetch" href="/assets/js/20.0d880388.js"><link rel="prefetch" href="/assets/js/200.6fdb4cde.js"><link rel="prefetch" href="/assets/js/201.2db1075b.js"><link rel="prefetch" href="/assets/js/202.6989c482.js"><link rel="prefetch" href="/assets/js/203.fed5be3d.js"><link rel="prefetch" href="/assets/js/204.2e2bd97a.js"><link rel="prefetch" href="/assets/js/205.919ad25d.js"><link rel="prefetch" href="/assets/js/206.caf46f82.js"><link rel="prefetch" href="/assets/js/207.b2786542.js"><link rel="prefetch" href="/assets/js/208.3ff31c7c.js"><link rel="prefetch" href="/assets/js/209.1ff1e0ba.js"><link rel="prefetch" href="/assets/js/21.0ad1d6a3.js"><link rel="prefetch" href="/assets/js/210.5673535d.js"><link rel="prefetch" href="/assets/js/211.07da8ae4.js"><link rel="prefetch" href="/assets/js/212.9a0d098d.js"><link rel="prefetch" href="/assets/js/213.289228c1.js"><link rel="prefetch" href="/assets/js/214.a9e3f658.js"><link rel="prefetch" href="/assets/js/215.2c849138.js"><link rel="prefetch" href="/assets/js/216.0b799039.js"><link rel="prefetch" href="/assets/js/217.248fa9ab.js"><link rel="prefetch" href="/assets/js/218.77bc5089.js"><link rel="prefetch" href="/assets/js/219.d0bcdf70.js"><link rel="prefetch" href="/assets/js/22.288b4852.js"><link rel="prefetch" href="/assets/js/220.abb5d7d1.js"><link rel="prefetch" href="/assets/js/221.39a29724.js"><link rel="prefetch" href="/assets/js/222.c8f848c5.js"><link rel="prefetch" href="/assets/js/223.3ea7fe96.js"><link rel="prefetch" href="/assets/js/224.afb1f423.js"><link rel="prefetch" href="/assets/js/225.cdd67273.js"><link rel="prefetch" href="/assets/js/226.89d69b6c.js"><link rel="prefetch" href="/assets/js/227.f5305f39.js"><link rel="prefetch" href="/assets/js/228.3276d530.js"><link rel="prefetch" href="/assets/js/229.ca4a013c.js"><link rel="prefetch" href="/assets/js/23.730038ee.js"><link rel="prefetch" href="/assets/js/230.19be1bec.js"><link rel="prefetch" href="/assets/js/231.940832b4.js"><link rel="prefetch" href="/assets/js/232.18dbe9c8.js"><link rel="prefetch" href="/assets/js/233.03187181.js"><link rel="prefetch" href="/assets/js/234.ed91cd88.js"><link rel="prefetch" href="/assets/js/235.277f96ac.js"><link rel="prefetch" href="/assets/js/236.8dee6d1a.js"><link rel="prefetch" href="/assets/js/237.6feb0534.js"><link rel="prefetch" href="/assets/js/238.57e64c14.js"><link rel="prefetch" href="/assets/js/239.8aeba238.js"><link rel="prefetch" href="/assets/js/24.933fffa9.js"><link rel="prefetch" href="/assets/js/240.864cffac.js"><link rel="prefetch" href="/assets/js/241.a1c6f45e.js"><link rel="prefetch" href="/assets/js/242.14475f90.js"><link rel="prefetch" href="/assets/js/243.fc4f7920.js"><link rel="prefetch" href="/assets/js/244.89f0d9fc.js"><link rel="prefetch" href="/assets/js/245.4836bb38.js"><link rel="prefetch" href="/assets/js/246.c3e0d73b.js"><link rel="prefetch" href="/assets/js/247.19eaf435.js"><link rel="prefetch" href="/assets/js/248.681c16e7.js"><link rel="prefetch" href="/assets/js/249.91c7786c.js"><link rel="prefetch" href="/assets/js/25.5a3957e2.js"><link rel="prefetch" href="/assets/js/250.999d9d17.js"><link rel="prefetch" href="/assets/js/251.758471d1.js"><link rel="prefetch" href="/assets/js/252.69b6befe.js"><link rel="prefetch" href="/assets/js/253.dd46a3dd.js"><link rel="prefetch" href="/assets/js/254.be5da0c1.js"><link rel="prefetch" href="/assets/js/255.d817ce68.js"><link rel="prefetch" href="/assets/js/256.2c7be7d4.js"><link rel="prefetch" href="/assets/js/257.a6b2fbe0.js"><link rel="prefetch" href="/assets/js/258.a5554c78.js"><link rel="prefetch" href="/assets/js/259.5a99fba0.js"><link rel="prefetch" href="/assets/js/26.fe1a83b5.js"><link rel="prefetch" href="/assets/js/260.41f4e520.js"><link rel="prefetch" href="/assets/js/261.0f73b7e7.js"><link rel="prefetch" href="/assets/js/262.28fa19f9.js"><link rel="prefetch" href="/assets/js/263.4bfbecf4.js"><link rel="prefetch" href="/assets/js/264.e0c89f62.js"><link rel="prefetch" href="/assets/js/265.e9e1d674.js"><link rel="prefetch" href="/assets/js/266.a63b71fb.js"><link rel="prefetch" href="/assets/js/267.420cd7e6.js"><link rel="prefetch" href="/assets/js/268.51e0f667.js"><link rel="prefetch" href="/assets/js/269.3f0d4774.js"><link rel="prefetch" href="/assets/js/27.916eabeb.js"><link rel="prefetch" href="/assets/js/270.c644f9d3.js"><link rel="prefetch" href="/assets/js/271.35387f6e.js"><link rel="prefetch" href="/assets/js/272.a776fe07.js"><link rel="prefetch" href="/assets/js/273.6e463c6b.js"><link rel="prefetch" href="/assets/js/274.8ef8b8e6.js"><link rel="prefetch" href="/assets/js/275.aa2e316d.js"><link rel="prefetch" href="/assets/js/276.9d603319.js"><link rel="prefetch" href="/assets/js/277.d428f5d6.js"><link rel="prefetch" href="/assets/js/278.f702bcfc.js"><link rel="prefetch" href="/assets/js/279.e1449e30.js"><link rel="prefetch" href="/assets/js/28.1116b232.js"><link rel="prefetch" href="/assets/js/280.7601eaee.js"><link rel="prefetch" href="/assets/js/281.84cdb64a.js"><link rel="prefetch" href="/assets/js/282.a6f561ff.js"><link rel="prefetch" href="/assets/js/283.c55742fa.js"><link rel="prefetch" href="/assets/js/284.924e0d7d.js"><link rel="prefetch" href="/assets/js/285.a997b1fb.js"><link rel="prefetch" href="/assets/js/286.cdb934a7.js"><link rel="prefetch" href="/assets/js/287.6f03d7f1.js"><link rel="prefetch" href="/assets/js/288.79e9f811.js"><link rel="prefetch" href="/assets/js/289.4861ef8b.js"><link rel="prefetch" href="/assets/js/29.6bff2814.js"><link rel="prefetch" href="/assets/js/290.e5a58a2f.js"><link rel="prefetch" href="/assets/js/291.9fee54ed.js"><link rel="prefetch" href="/assets/js/292.f8550342.js"><link rel="prefetch" href="/assets/js/293.5f22eb00.js"><link rel="prefetch" href="/assets/js/294.0a21c523.js"><link rel="prefetch" href="/assets/js/295.278a632b.js"><link rel="prefetch" href="/assets/js/296.ffc317e3.js"><link rel="prefetch" href="/assets/js/297.239cab1c.js"><link rel="prefetch" href="/assets/js/298.9f79e196.js"><link rel="prefetch" href="/assets/js/299.5f334485.js"><link rel="prefetch" href="/assets/js/3.bc6bba9e.js"><link rel="prefetch" href="/assets/js/30.218767d4.js"><link rel="prefetch" href="/assets/js/300.0ba14677.js"><link rel="prefetch" href="/assets/js/301.e8f27c97.js"><link rel="prefetch" href="/assets/js/302.c122edfe.js"><link rel="prefetch" href="/assets/js/303.da637783.js"><link rel="prefetch" href="/assets/js/304.4ec1b29e.js"><link rel="prefetch" href="/assets/js/305.3c00ea1f.js"><link rel="prefetch" href="/assets/js/306.b20e9815.js"><link rel="prefetch" href="/assets/js/307.6b91424e.js"><link rel="prefetch" href="/assets/js/308.dc89c12c.js"><link rel="prefetch" href="/assets/js/309.cc9c859e.js"><link rel="prefetch" href="/assets/js/31.2759a7a8.js"><link rel="prefetch" href="/assets/js/310.a9d45b6b.js"><link rel="prefetch" href="/assets/js/311.2054a97f.js"><link rel="prefetch" href="/assets/js/312.4bbc87ce.js"><link rel="prefetch" href="/assets/js/313.6bfffef1.js"><link rel="prefetch" href="/assets/js/314.80c7873d.js"><link rel="prefetch" href="/assets/js/315.e2b4b0eb.js"><link rel="prefetch" href="/assets/js/316.3e4bf82f.js"><link rel="prefetch" href="/assets/js/317.67d43206.js"><link rel="prefetch" href="/assets/js/318.29c1cdea.js"><link rel="prefetch" href="/assets/js/319.902203c8.js"><link rel="prefetch" href="/assets/js/32.49c74da8.js"><link rel="prefetch" href="/assets/js/320.9f322f6c.js"><link rel="prefetch" href="/assets/js/321.9ec16835.js"><link rel="prefetch" href="/assets/js/322.3afb0458.js"><link rel="prefetch" href="/assets/js/323.7c17fa0a.js"><link rel="prefetch" href="/assets/js/324.99ba59d2.js"><link rel="prefetch" href="/assets/js/325.6317221b.js"><link rel="prefetch" href="/assets/js/326.05691f3e.js"><link rel="prefetch" href="/assets/js/327.57a0752b.js"><link rel="prefetch" href="/assets/js/328.bd689f6c.js"><link rel="prefetch" href="/assets/js/329.9d95b288.js"><link rel="prefetch" href="/assets/js/33.da97d900.js"><link rel="prefetch" href="/assets/js/330.3f1aabde.js"><link rel="prefetch" href="/assets/js/331.4d2b6bf2.js"><link rel="prefetch" href="/assets/js/332.3d04f06d.js"><link rel="prefetch" href="/assets/js/333.f76ff221.js"><link rel="prefetch" href="/assets/js/334.cd2fc1ea.js"><link rel="prefetch" href="/assets/js/335.03d03979.js"><link rel="prefetch" href="/assets/js/336.4190f1ee.js"><link rel="prefetch" href="/assets/js/337.fdb48b71.js"><link rel="prefetch" href="/assets/js/338.7db8c869.js"><link rel="prefetch" href="/assets/js/339.90cdb7f0.js"><link rel="prefetch" href="/assets/js/34.42f8b6ab.js"><link rel="prefetch" href="/assets/js/340.4ba3bbd5.js"><link rel="prefetch" href="/assets/js/341.697b02a9.js"><link rel="prefetch" href="/assets/js/342.4af3bc4a.js"><link rel="prefetch" href="/assets/js/343.ba3f5e26.js"><link rel="prefetch" href="/assets/js/344.a3cf4ad3.js"><link rel="prefetch" href="/assets/js/345.d00eb266.js"><link rel="prefetch" href="/assets/js/346.74f1e6d3.js"><link rel="prefetch" href="/assets/js/347.cc3995b9.js"><link rel="prefetch" href="/assets/js/348.37774278.js"><link rel="prefetch" href="/assets/js/349.94d05b9c.js"><link rel="prefetch" href="/assets/js/35.42c35a21.js"><link rel="prefetch" href="/assets/js/350.47f1df55.js"><link rel="prefetch" href="/assets/js/351.1627936d.js"><link rel="prefetch" href="/assets/js/352.277ab034.js"><link rel="prefetch" href="/assets/js/353.c11e8bb5.js"><link rel="prefetch" href="/assets/js/354.ba01078c.js"><link rel="prefetch" href="/assets/js/355.70321476.js"><link rel="prefetch" href="/assets/js/356.94f404af.js"><link rel="prefetch" href="/assets/js/358.d72741b2.js"><link rel="prefetch" href="/assets/js/359.31c31ceb.js"><link rel="prefetch" href="/assets/js/36.c3767d58.js"><link rel="prefetch" href="/assets/js/360.a654dc23.js"><link rel="prefetch" href="/assets/js/361.46441143.js"><link rel="prefetch" href="/assets/js/362.0aa22356.js"><link rel="prefetch" href="/assets/js/363.355f7781.js"><link rel="prefetch" href="/assets/js/364.7e5168cd.js"><link rel="prefetch" href="/assets/js/365.b5f9bbf4.js"><link rel="prefetch" href="/assets/js/366.35422147.js"><link rel="prefetch" href="/assets/js/367.17af4dd9.js"><link rel="prefetch" href="/assets/js/368.99c04015.js"><link rel="prefetch" href="/assets/js/369.6e269202.js"><link rel="prefetch" href="/assets/js/37.b8f739e7.js"><link rel="prefetch" href="/assets/js/370.4c9fc0f9.js"><link rel="prefetch" href="/assets/js/371.fe9ddc42.js"><link rel="prefetch" href="/assets/js/372.a1a19937.js"><link rel="prefetch" href="/assets/js/373.8244356e.js"><link rel="prefetch" href="/assets/js/374.046bb182.js"><link rel="prefetch" href="/assets/js/375.95079f01.js"><link rel="prefetch" href="/assets/js/376.cb4cbf85.js"><link rel="prefetch" href="/assets/js/377.7f9dcc45.js"><link rel="prefetch" href="/assets/js/378.8396aba6.js"><link rel="prefetch" href="/assets/js/379.78f55713.js"><link rel="prefetch" href="/assets/js/38.cfd18851.js"><link rel="prefetch" href="/assets/js/380.9df95a65.js"><link rel="prefetch" href="/assets/js/381.db02d710.js"><link rel="prefetch" href="/assets/js/382.f5f01bd1.js"><link rel="prefetch" href="/assets/js/383.551a9e39.js"><link rel="prefetch" href="/assets/js/384.521cbf24.js"><link rel="prefetch" href="/assets/js/385.ce4ea212.js"><link rel="prefetch" href="/assets/js/386.3f4d7458.js"><link rel="prefetch" href="/assets/js/387.70a5c9bc.js"><link rel="prefetch" href="/assets/js/388.6d8e6a12.js"><link rel="prefetch" href="/assets/js/389.0088e683.js"><link rel="prefetch" href="/assets/js/39.af3d4c88.js"><link rel="prefetch" href="/assets/js/390.ac189a90.js"><link rel="prefetch" href="/assets/js/391.77894ec3.js"><link rel="prefetch" href="/assets/js/392.94725ec9.js"><link rel="prefetch" href="/assets/js/393.0d91a9e5.js"><link rel="prefetch" href="/assets/js/394.035a8e79.js"><link rel="prefetch" href="/assets/js/395.6dfbee1b.js"><link rel="prefetch" href="/assets/js/396.beb18051.js"><link rel="prefetch" href="/assets/js/397.5326e3a9.js"><link rel="prefetch" href="/assets/js/398.02a3983e.js"><link rel="prefetch" href="/assets/js/399.59d68b2b.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.feab1c20.js"><link rel="prefetch" href="/assets/js/400.f8253cec.js"><link rel="prefetch" href="/assets/js/401.fe8992b6.js"><link rel="prefetch" href="/assets/js/402.c0f7e134.js"><link rel="prefetch" href="/assets/js/403.48996262.js"><link rel="prefetch" href="/assets/js/41.e39d4dc8.js"><link rel="prefetch" href="/assets/js/42.61fe8caf.js"><link rel="prefetch" href="/assets/js/43.a9b01c27.js"><link rel="prefetch" href="/assets/js/44.d0b30ba2.js"><link rel="prefetch" href="/assets/js/45.c503c388.js"><link rel="prefetch" href="/assets/js/46.7206f25e.js"><link rel="prefetch" href="/assets/js/47.f3038db2.js"><link rel="prefetch" href="/assets/js/48.5cb39349.js"><link rel="prefetch" href="/assets/js/49.f05e5dfa.js"><link rel="prefetch" href="/assets/js/5.7098d77a.js"><link rel="prefetch" href="/assets/js/50.f4051900.js"><link rel="prefetch" href="/assets/js/51.140718cc.js"><link rel="prefetch" href="/assets/js/52.df8cb15f.js"><link rel="prefetch" href="/assets/js/53.9322d2fd.js"><link rel="prefetch" href="/assets/js/54.083c2849.js"><link rel="prefetch" href="/assets/js/55.0db6b109.js"><link rel="prefetch" href="/assets/js/56.e36d9f94.js"><link rel="prefetch" href="/assets/js/57.aadb73ac.js"><link rel="prefetch" href="/assets/js/58.e0181ca8.js"><link rel="prefetch" href="/assets/js/59.71fa8395.js"><link rel="prefetch" href="/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/assets/js/60.ccbd5c67.js"><link rel="prefetch" href="/assets/js/61.b29ac4b8.js"><link rel="prefetch" href="/assets/js/62.2c041d9f.js"><link rel="prefetch" href="/assets/js/63.02e68290.js"><link rel="prefetch" href="/assets/js/64.52025364.js"><link rel="prefetch" href="/assets/js/65.821d4920.js"><link rel="prefetch" href="/assets/js/66.b01a2e1f.js"><link rel="prefetch" href="/assets/js/67.49786e78.js"><link rel="prefetch" href="/assets/js/68.c6418f35.js"><link rel="prefetch" href="/assets/js/69.7bd0a0e3.js"><link rel="prefetch" href="/assets/js/7.6a854e57.js"><link rel="prefetch" href="/assets/js/70.6bacad63.js"><link rel="prefetch" href="/assets/js/71.2d2f55cb.js"><link rel="prefetch" href="/assets/js/72.385a2106.js"><link rel="prefetch" href="/assets/js/73.3567215b.js"><link rel="prefetch" href="/assets/js/74.66d5e54d.js"><link rel="prefetch" href="/assets/js/75.e9939676.js"><link rel="prefetch" href="/assets/js/76.ef329155.js"><link rel="prefetch" href="/assets/js/77.704b996e.js"><link rel="prefetch" href="/assets/js/78.6a6ccbbc.js"><link rel="prefetch" href="/assets/js/79.a908ba71.js"><link rel="prefetch" href="/assets/js/80.a6cc65ef.js"><link rel="prefetch" href="/assets/js/81.55fd7628.js"><link rel="prefetch" href="/assets/js/82.9fd118ce.js"><link rel="prefetch" href="/assets/js/83.25043008.js"><link rel="prefetch" href="/assets/js/84.ec86d293.js"><link rel="prefetch" href="/assets/js/85.b4faa1bb.js"><link rel="prefetch" href="/assets/js/86.beade549.js"><link rel="prefetch" href="/assets/js/87.c816be2a.js"><link rel="prefetch" href="/assets/js/88.453dd1c1.js"><link rel="prefetch" href="/assets/js/89.eae28977.js"><link rel="prefetch" href="/assets/js/90.05307532.js"><link rel="prefetch" href="/assets/js/91.fd8bd853.js"><link rel="prefetch" href="/assets/js/92.14aed080.js"><link rel="prefetch" href="/assets/js/93.f1b00b72.js"><link rel="prefetch" href="/assets/js/94.debf50a7.js"><link rel="prefetch" href="/assets/js/95.f9a158ae.js"><link rel="prefetch" href="/assets/js/96.2833401e.js"><link rel="prefetch" href="/assets/js/97.957e0ee5.js"><link rel="prefetch" href="/assets/js/98.9c305f09.js"><link rel="prefetch" href="/assets/js/99.c8981936.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="思源笔记" class="logo"> <span class="site-name can-hide">思源笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/Python/" class="sidebar-heading clickable router-link-active open"><span>Python</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/CPython源码剖析/" class="sidebar-heading clickable"><span>CPython源码剖析</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python常用模块/" class="sidebar-heading clickable"><span>Python常用模块</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python常见问题.html" class="sidebar-link">Python常见问题</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python编程核心/" class="sidebar-heading clickable open"><span>Python编程核心</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/内存管理、垃圾回收/" class="sidebar-heading clickable"><span>内存管理、垃圾回收</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/函数/" class="sidebar-heading clickable"><span>函数</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/多语言混合开发/" class="sidebar-heading clickable"><span>多语言混合开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/并发编程/" class="sidebar-heading clickable"><span>并发编程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/杂/" class="sidebar-heading clickable"><span>杂</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/模块化、私有化/" class="sidebar-heading clickable"><span>模块化、私有化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/测试加密打包部署/" class="sidebar-heading clickable"><span>测试加密打包部署</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/环境配置/" class="sidebar-heading clickable"><span>环境配置</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/语法基础/" class="sidebar-heading clickable"><span>语法基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/调试优化dump分析/" class="sidebar-heading clickable open"><span>调试优化dump分析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/debug/" class="sidebar-heading clickable"><span>debug</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/dump分析#TODO#/" class="sidebar-heading clickable"><span>dump分析#TODO#</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/profile/" class="sidebar-heading clickable"><span>profile</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/typing：静态类型检查/" class="sidebar-heading clickable"><span>typing：静态类型检查</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python编程核心/调试优化dump分析/其他线上调试工具.html" class="sidebar-link">其他线上调试工具</a></li><li><a href="/Python/Python编程核心/调试优化dump分析/奇奇怪怪的python优化点.html" class="sidebar-link">奇奇怪怪的python优化点</a></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/" class="sidebar-heading clickable open"><span>所谓性能优化</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html" class="sidebar-link">Python程序性能优化实战2</a></li><li><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html" class="active sidebar-link">python程序性能优化实战1</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#参考" class="sidebar-link">参考</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#对应用的io和计算负载进行度量" class="sidebar-link">对应用的IO和计算负载进行度量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#下载数据并计算最低温度" class="sidebar-link">下载数据并计算最低温度</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#python内置的度量工具" class="sidebar-link">Python内置的度量工具</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#使用本地缓存来减少网络使用" class="sidebar-link">使用本地缓存来减少网络使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#度量代码以寻找性能瓶颈" class="sidebar-link">度量代码以寻找性能瓶颈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#将度量信息可视化" class="sidebar-link">将度量信息可视化</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#逐行度量" class="sidebar-link">逐行度量</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#心得-度量代码性能" class="sidebar-link">心得：度量代码性能</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#优化基础数据结构的速度-列表、集合、字典" class="sidebar-link">优化基础数据结构的速度：列表、集合、字典</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#列表搜索的性能" class="sidebar-link">列表搜索的性能</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#使用集合搜索" class="sidebar-link">使用集合搜索</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#python中的列表、集合、字典的复杂度" class="sidebar-link">Python中的列表、集合、字典的复杂度</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#寻找过度的内存分配" class="sidebar-link">寻找过度的内存分配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#查看python内存预测中的坑" class="sidebar-link">查看Python内存预测中的坑</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#其它展示形式的内存占用" class="sidebar-link">其它展示形式的内存占用</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#使用数组作为一种紧凑表示以取代列表" class="sidebar-link">使用数组作为一种紧凑表示以取代列表</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#将我们的所学系统化-估算python对象的内存消耗" class="sidebar-link">将我们的所学系统化，估算Python对象的内存消耗</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#心得-估算python对象的内存使用" class="sidebar-link">心得：估算Python对象的内存使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#为大数据流水线应用延迟求值和生成器" class="sidebar-link">为大数据流水线应用延迟求值和生成器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#使用生成器取代标准函数" class="sidebar-link">使用生成器取代标准函数</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/python程序性能优化实战1.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/四类优化方案.html" class="sidebar-link">四类优化方案</a></li></ul></section></li><li><a href="/Python/Python编程核心/调试优化dump分析/概述.html" class="sidebar-link">概述</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/面向对象/" class="sidebar-heading clickable"><span>面向对象</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/鸭子类型/" class="sidebar-heading clickable"><span>鸭子类型</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="python程序性能优化实战1"><a href="#python程序性能优化实战1" class="header-anchor">#</a> python程序性能优化实战1</h1> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://zhuanlan.zhihu.com/p/631924233" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/631924233 - 知乎专栏<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>‍</p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>有许多工具和库可以帮助我们写出更加高效的Python代码。但是在我们深入这些第三方方案之前，先来看一看如何编写更加高效的纯Python代码，无论是在计算方面还是IO方面。虽然不能说所有，但确实有许多问题可以通过对Python能力与局限的理解来规避。</p> <p>为了展示Python自己的性能优化工具，我们假设一些问题来作演示。假设你是一名数据工程师，准备对全球气候数据进行分析。数据来源是<a href="http://mng.bz/ydge" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，归属美国国家海洋与大气管理局。时间很紧，而且只能用标准Python，受限于预算，也没法购买更多的计算资源。数据一个月之后就能就绪，你要利用这段时间来提升代码性能。你的任务是寻找最需要优化的地方，提升它们的性能。</p> <p>你的第一个任务是度量现有的数据处理代码性能。尽管已经知道代码比较慢，但还是需要为性能瓶颈找到响应的依据。度量的步骤是十分重要的，让你能够以严格系统化的方式来定位代码中瓶颈的所在。而大家平时最常见的拍脑袋方法反而不行，许多性能问题点都是反直觉的。</p> <p>对于纯Python代码的优化是最直接的，而这个领域也是问题比较多的，所以在这个领域的优化收益颇丰。本篇中，我们会看到Python自带的开箱即用的工具如何帮助我们开发性能更好的代码。我们从代码度量开始，使用集中不同的工具来检测问题区域。然后我们聚焦Python的基础数据结构：列表、集合和字典。我们的目标是提升这些数据结构的效率，优化内存分配的性能。最后，我们会看到现代Python的延迟求值技术是如何改善数据处理流程的性能的。</p> <p>本篇中只看纯Python代码，不涉及第三方库，但会用到一些外部工具来优化性能和访问数据。我们会使用Snakeviz对度量结果可视化，还会用到line_profiler来逐行测量性能。最后使用request库来下载数据。</p> <p>如果你使用Docker，直接用默认的镜像即可。</p> <p>‍</p> <h2 id="对应用的io和计算负载进行度量"><a href="#对应用的io和计算负载进行度量" class="header-anchor">#</a> 对应用的IO和计算负载进行度量</h2> <p>我们的第一个目标是从气象站下载数据，计算某个年份的最低温度。NOAA网站上有CSV格式的数据，按照年份与气象站切分。比如<a href="https://www.ncei.noaa.gov/data/global-hourly/access/2021/01494099999.csv" target="_blank" rel="noopener noreferrer">al-hourly/access/2021/01494099999.csv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这个文件包含了2021年01494099999气象站的所有记录。这些记录中有温度、气压等信息，而且一天可能有多条记录。</p> <p>让我们写一个脚本来下载一段时间内某一批气象站的数据，然后计算每个气象站的最低温度。</p> <h3 id="下载数据并计算最低温度"><a href="#下载数据并计算最低温度" class="header-anchor">#</a> 下载数据并计算最低温度</h3> <p>我们的脚本通过命令行运行，接受一个站点列表，开始和结束的年份。这里是处理输入的代码：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>import collections
import csv
import datetime
import sys
import requests

stations = sys.argv[1].split(&quot;,&quot;)
years = [int(year) for year in sys.argv[2].split(&quot;-&quot;)]
start_year = years[0]
end_year = years[1]
</code></pre></div><p>我们使用requests库来获取文件，如下：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>TEMPLATE_URL = &quot;https://www.ncei.noaa.gov/data/global-hourly/access/{year}/{station}.csv&quot;
TEMPLATE_FILE = &quot;station_{station}_{year}.csv&quot;

def download_data(station, year):
  my_url = TEMPLATE_URL.format(station=station, year=year)
  req = requests.get(my_url)
  if req.status_code != 200:
    return # not found
  w = open(TEMPLATE_FILE.format(station=station, year=year), &quot;wt&quot;)
  w.write(req.text)
  w.close()

def download_all_data(stations, start_year, end_year):
  for station in stations:
    for year in range(start_year, end_year + 1):
      download_data(station, year)
</code></pre></div><p>这部分代码会将每个文件都写入本地磁盘。接下来我们获取单个文件中的所有温度：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>def get_file_temperatures(file_name):
    with open(file_name, &quot;rt&quot;) as f:
        reader = csv.reader(f)
        header = next(reader)
        for row in reader:
            station = row[header.index(&quot;STATION&quot;)]
            # date = datetime.datetime.fromisoformat(row[header.index('DATE')])
            tmp = row[header.index(&quot;TMP&quot;)]
            temperature, status = tmp.split(&quot;,&quot;)
            if status != &quot;1&quot;:
                continue
            temperature = int(temperature) / 10
            yield temperature
</code></pre></div><p>接下来获取每个站点的所有温度，得到最小值：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>def get_all_temperatures(stations, start_year, end_year):
    temperatures = collections.defaultdict(list)
    for station in stations:
        for year in range(start_year, end_year + 1):
            for temperature in get_file_temperatures(TEMPLATE_FILE.format(station=station, year=year)):
                temperatures[station].append(temperature)
    return temperatures


def get_min_temperatures(all_temperatures):
    return {station: min(temperatures) for station, temperatures in all_temperatures.items()}
</code></pre></div><p>最后把所有的部分组合起来：下载数据、获取温度、计算最小值和输出结果。</p> <div class="language-text extra-class"><pre class="language-text"><code>python load.py 01044099999,02293099999 2021-2021
</code></pre></div><p>输出的结果是：{'01044099999': -10.0, '02293099999': -27.6}</p> <p>现在好戏才刚刚开始。我们的目标是继续下载更多站点在更多年份的更多数据。为了处理这么多的数据，我们需要让代码尽可能地高效。而提升代码效率的第一步便是度量其效率，找到性能的瓶颈。为此我们会用到Python内置的度量机制。</p> <p>‍</p> <h3 id="python内置的度量工具"><a href="#python内置的度量工具" class="header-anchor">#</a> Python内置的度量工具</h3> <p>我们的第一步是对代码进行度量，检查每个函数的时间消耗。为此，我们需要通过Python的cProfile模块来运行代码。这个模块内置于Python之中，帮助我们从代码中获取执行信息。这里要注意，我们用的不是profile模块，这货要慢几个数量级，除非你要开发自己的测量工具时才用得上。</p> <p>我们可以通过下面的命令来运行：</p> <div class="language-text extra-class"><pre class="language-text"><code>python -m cProfile -s cumulative load.py 01044099999,02293099999 2021-2021 &gt; profile.txt
</code></pre></div><p>这里我们通过-m参数运行Python，执行cProfile模块。Python官方推荐使用这个模块来收集运行信息。我们根据累计执行时间对数据进行排序。执行的结果部分展示如下：</p> <p>​<img src="assets/v2-6257ddd85fc1fe2935f1f761d182b87b_b-20231122114018-9flsfp0.jpg" alt="">​</p> <p>这里的结果是根据在函数上累计执行的时间来排序的。另一种方式是根据每个函数的调用次数来排序。可以看到，这里只调用了1次download_all_data，但是其累计执行时间却和整个脚本差不多。这里有两列名字都叫做percall，第一列代表的是排除子调用之后的时间开销，第二列代表的是包含子调用之后的时间开销。这里download_all_data的时间明显都花在了子调用上。</p> <p>在许多IO密集的场景中，比如现在这个例子，很有可能是IO占据了主要的时间开销。在我们的例子中，既有网络IO（下载数据），又有磁盘IO（写入文件）。网络开销差异巨大，收到许多因素的影响，一般是最大的时间消耗所在，让我们尝试来缓解这个问题。</p> <p>‍</p> <h3 id="使用本地缓存来减少网络使用"><a href="#使用本地缓存来减少网络使用" class="header-anchor">#</a> 使用本地缓存来减少网络使用</h3> <p>为了减少网络通信，我们可以在首次下载文件的时候保存一个副本给未来使用。我们会构建一个本地数据缓存。我们使用和之前一样的代码，但是会检查文件是否存在，存在的话就不会重复下载。</p> <div class="language-python3 extra-class"><pre class="language-text"><code>def download_all_data(stations, start_year, end_year):
    for station in stations:
        for year in range(start_year, end_year + 1):
            if not os.path.exists(TEMPLATE_FILE.format(station=station, year=year)):
                download_data(station, year)
</code></pre></div><p>第一次运行的时候还是和之前一样慢，但是第二次就不需要进行网络访问了。当前这个例子中有数量级的优化。可以通过下面的命令执行：</p> <div class="language-text extra-class"><pre class="language-text"><code>python -m cProfile -s cumulative load_cache.py 01044099999,02293099999 2021-2021 &gt; profile_cache.txt
</code></pre></div><p>结果如下：</p> <p>​<img src="assets/v2-a541b307471f0e768243cc83f49b9689_b-20231122114018-gt3gj31.jpg" alt="">​</p> <p>尽管时间下降了一个数量级，IO仍然名列前茅。现在问题不在网络，而在于磁盘访问了，当然也是因为计算量相对较小。</p> <blockquote><p>注意：本例中展示的缓存虽然可以将速度提升一个数量级，但是缓存的管理是很难的，也是常见的bug来源。本例中的文件不会随着时间而变化，但大部分情况不是这样的，缓存管理代码需要识别这个问题。我们也会在后续的内容中回头再看这个问题。</p></blockquote> <p>接下来我们看看CPU是限制因素的话怎么办。</p> <p>‍</p> <h2 id="度量代码以寻找性能瓶颈"><a href="#度量代码以寻找性能瓶颈" class="header-anchor">#</a> 度量代码以寻找性能瓶颈</h2> <p>这里我们用同样的数据但是换一个任务，主要考验CPU。我们使用NOAA所有的站点，计算站点之间的距离，复杂度位N²。</p> <p>我们提前准备好了数据，下面的计算的代码。</p> <div class="language-python3 extra-class"><pre class="language-text"><code>def get_locations():
    with open(&quot;locations.csv&quot;, &quot;rt&quot;) as f:
        reader = csv.reader(f)
        header = next(reader)
        for row in reader:
            station = row[header.index(&quot;STATION&quot;)]
            lat = float(row[header.index(&quot;LATITUDE&quot;)])
            lon = float(row[header.index(&quot;LONGITUDE&quot;)])
            yield station, (lat, lon)


def get_distance(p1, p2):
    lat1, lon1 = p1
    lat2, lon2 = p2

    lat_dist = math.radians(lat2 - lat1)
    lon_dist = math.radians(lon2 - lon1)
    a = (
        math.sin(lat_dist / 2) * math.sin(lat_dist / 2) +
        math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) *
        math.sin(lon_dist / 2) * math.sin(lon_dist / 2)
    )
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    earth_radius = 6371
    dist = earth_radius * c

    return dist


def get_distances(stations, locations):
    distances = {}
    for first_i in range(len(stations) - 1):
        first_station = stations[first_i]
        first_location = locations[first_station]      
        for second_i in range(first_i, len(stations)):
            second_station = stations[second_i]
            second_location = locations[second_station]
            distances[(first_station, second_station)] = get_distance(
                first_location, second_location)
    return distances


locations = {station: (lat, lon) for station, (lat, lon) in get_locations()}
stations = sorted(locations.keys())
distances = get_distances(stations, locations)
</code></pre></div><p>这段代码跑起来要花不少时间，还会消耗不少内存。如果你内存不够，可以少处理一些站点。接下来我们使用Python的工具来看看大部分时间花在了哪里。</p> <h3 id="将度量信息可视化"><a href="#将度量信息可视化" class="header-anchor">#</a> 将度量信息可视化</h3> <p>我们再一次使用度量工具来寻找影响执行速度的代码。为了更好地理解跟踪情况，我们会使用一个外部的工具，<a href="https://link.zhihu.com/?target=https%3A//jiffyclub.github.io/snakeviz/" target="_blank" rel="noopener noreferrer">SnakeViz<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>我们先保存一个度量文件：</p> <div class="language-text extra-class"><pre class="language-text"><code>python -m cProfile -o distance_cache.prof distance_cache.py
</code></pre></div><p>这里的-o参数会指定度量数据保存的位置，其它的调用照旧。</p> <blockquote><p>注意：Python提供了pstats模块来分析写入了磁盘的跟踪记录。你可以用python -m pstats distance_cache.prof命令来分析程序的执行成本。你可以在文档中找到更多的细节，第五篇也会涉及。</p></blockquote> <p>为了分析这些信息，我们会使用基于web的可视化工具，直接通过snakeviz distance_cache.prof即可，会跳出一个交互式浏览器界面（图2.1）</p> <p>​<img src="assets/v2-d33efb85eda69b2e1a577a2b232f0af0_b-20231122114018-ixd8kz9.jpg" alt="">​</p> <p>大部分时间都花在了get_distance上，但究竟是哪里呢？我们可以看到部分数学函数的开销，但是Python的度量工具没法提供函数内部更细粒度的视角。我们看到的只是聚合视角。是的，math.sin确实花了不少时间，但是我们在好多地方都用到了，到底是哪里有问题呢？为此我们需要引入逐行度量的工具。</p> <h3 id="逐行度量"><a href="#逐行度量" class="header-anchor">#</a> 逐行度量</h3> <p>尽管内置的度量工具可以帮我们找到哪一段代码引起的性能问题，但是局限也不少。这里我们会讨论这些局限，并引入逐行度量工具来进一步寻找性能瓶颈。</p> <p>##为了了解get_distance函数中每一行代码的代价，我们会使用<a href="https://link.zhihu.com/?target=https%3A//github.com/pyutils/line_profiler" target="_blank" rel="noopener noreferrer">line_profiler库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。具体用法很简单，只需要加个标注就行了：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>@profile
def get_distance(p1, p2):
</code></pre></div><p>你可能会发现，我们并没有从任何地方导入profile注解。这是因为我们将使用line_profile包中的便捷脚本kernprof来处理。让我们用下面的方式来进行逐行测量：</p> <div class="language-text extra-class"><pre class="language-text"><code>kernprof -l lprofile_distance_cache.py
</code></pre></div><p>逐行度量会让执行速度慢几个数量级，完整跑完可能要几个小时。执行完毕之后可以使用下面的命令来查看结果。</p> <div class="language-text extra-class"><pre class="language-text"><code>python -m line_profiler lprofile_distance_cache.py.lprof
</code></pre></div><p>如果你看看图2.2中的结果就会发现去多调用的耗时都不少，也是我们可能需要优化的地方。现阶段我们度量完毕之后就此打住，但后续第六篇中我们还会进行优化。</p> <p>​<img src="assets/v2-4c89b53d216ae6840250d8ca3b3080e5_b-20231122114018-oznnb5i.jpg" alt="">​</p> <p>图2.2</p> <p>可以看到，逐行度量的结果比内置的工具更容易让人看明白。</p> <h3 id="心得-度量代码性能"><a href="#心得-度量代码性能" class="header-anchor">#</a> 心得：度量代码性能</h3> <p>我们一开始尝试的内置度量工具也帮了不少忙，而且运行起来要比逐行度量工具更快。但是逐行度量工具深入函数内部，提供的信息量更多。相反，Python内置的工具只提供函数的累计值，以及在子调用上花费的时间。某些场景中可能会知道子调用是什么，但是一般情况下是不清楚的。一个完整的度量策略需要把这些都考虑在内。</p> <p>我们在这里采取的是一种比较理性的策略：先尝试内置的cProfile模块，因为它跑的快，还能提供一些概要信息。如果这些不够，那就使用逐行度量，信息更多，运行也更慢。我们这里的主要目标是寻找性能瓶颈；后续的篇章中 会进行优化。有时候仅仅对现有方案做局部调整还不够，甚至需要整体重新架构。</p> <blockquote><p>其它度量工具<br>
度量代码的时候，有一个工具不得不提，那就是timeit模块。这可能是新手用的最多的模块，网上的例子也很多。结合使用最简单的是IPython和Jupyter Notebook的场景，只要加上%timeit%标记，就可以对任何东西进行度量。比如在IPython中：<br>
In [1]: %timeit list(range(1000000))<br>
27.4 ms ± 72.5 μs per loop (mean ± std. dev. of 7 runs, 10 loops each)<br>
你可以在timeit的文档中找到更多细节，但是一般来说上面这种用法就够了。</p></blockquote> <p>到这里你应该已经熟悉度量的代码和工具了，下一步我们看看如何优化Python数据结构的使用。</p> <p>‍</p> <h2 id="优化基础数据结构的速度-列表、集合、字典"><a href="#优化基础数据结构的速度-列表、集合、字典" class="header-anchor">#</a> 优化基础数据结构的速度：列表、集合、字典</h2> <p>接下来我们要寻找基础数据结构用的不好的地方，用更加高效的方式重写。这里我们还是使用NOAA的例子，但任务变成了一个站点在特定周期内是否出现过某些气温。下面的代码会读取站点01044099999在2005到2021年间的数据：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>stations = ['01044099999']
start_year = 2005
end_year = 2021
download_all_data(stations, start_year, end_year)
all_temperatures = get_all_temperatures(stations, start_year, end_year)

first_all_temperatures = all_temperatures[stations[0]]
</code></pre></div><p>first_all_temperatures中保存了站点观测到的所有气温。通过print(len(first_all_temperatures)、max(first_all_temperatures)、min(first_all_temperatures)))等方法，我们知道这里一共有141082条记录，最高气温27℃，最低-16℃。</p> <h3 id="列表搜索的性能"><a href="#列表搜索的性能" class="header-anchor">#</a> 列表搜索的性能</h3> <p>我们要检查某个温度是否存在于first_all_temperatures列表中。让我们通过下面的方法来粗略估计这个过程要花多少时间：</p> <div class="language-text extra-class"><pre class="language-text"><code>%timeit (-10.7 in first_all_temperatures)
</code></pre></div><p>我电脑上的结果如下：</p> <p>313 μs ± 6.39 μs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)</p> <p>如果我们查询一个不在列表中的值：</p> <div class="language-text extra-class"><pre class="language-text"><code>%timeit (-100 in first_all_temperatures)
</code></pre></div><p>结果变成了：</p> <p>2.87 ms ± 20.3 μs per loop (mean ± std. dev. of 7 runs, 100 loops each)</p> <p>几乎比前面的结果高了一个数量级。</p> <p>为什么第二次搜索的性能如此之差呢？因为这里的搜索中，in操作符需要从头开始顺序扫描整个列表。这意味着，在最差的情况下，也就是目标不存在于列表中的时候，我们需要遍历整个列表。对于小列表尚且影响不大。但是随着数据规模扩大，这种额外增加的开销就很可观了。</p> <p>这里我们没有绝对的数字可供参考，但是从毫秒到微妙的变化肯定是不理想的，至少应该降低一个数量级。</p> <h3 id="使用集合搜索"><a href="#使用集合搜索" class="header-anchor">#</a> 使用集合搜索</h3> <p>让我们看看将列表转换为集合之后表现是否有所改善。</p> <div class="language-python3 extra-class"><pre class="language-text"><code>set_first_all_temperatures = set(first_all_temperatures)
print(len(set_first_all_temperatures))

%timeit (-10.7 in set_first_all_temperatures)
%timeit (-100 in set_first_all_temperatures)
</code></pre></div><p>结果如下：</p> <p>62.1 ns ± 3.27 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)<br>
26.6 ns ± 0.115 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)</p> <p>比之前的版本快了几个数量级！为什么呢？原因有两个：其一是集合的大小，其二是复杂度。</p> <p>复杂度我们晚点再说，先看体积。还记得吗，原始的列表中有14万个元素，但是在集合中，所有雷同的元素都缩减为了一个元素，对列表实现了去重，最终只剩下400个元素，差不多是350倍的差距。体积变小了，搜索速度也就变快了。</p> <p>这里的心得是关注列表中的重复元素，使用集合去重之后可以在更小的数据集上执行搜索。但是Python中列表和集合还有一个深刻的区别。</p> <h3 id="python中的列表、集合、字典的复杂度"><a href="#python中的列表、集合、字典的复杂度" class="header-anchor">#</a> Python中的列表、集合、字典的复杂度</h3> <p>前面的性能提升很大程度上来源于数据结构体积的缩小。那么如果列表数据中没有重复值，转换成集合之后体积不就一样了吗？让我们用下面的代码模拟一下这种情况：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>a_list_range = list(range(100000))
a_set_range = set(a_list_range)
%timeit 50000 in a_list_range
%timeit 50000 in a_set_range
%timeit 500000 in a_list_range
%timeit 500000 in a_set_range
</code></pre></div><p>我们在列表与集合中都保存了0到99999的数字，从中寻找50000和500000，记时结果如下：</p> <p>621 µs ± 23.3 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)<br>
54.4 ns ± 1.86 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)<br>
1.24 ms ± 23.4 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)<br>
40.8 ns ± 1.44 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)</p> <p>集合的表现仍然好于列表。在Python（准确地说是CPython）中，集合是通过哈希实现的。搜索一个元素的代价就是哈希搜索的代价。哈希函数有许多有点，也有许多设计问题。当我们拿列表和集合对比的时候，我们一般可以假设集合的查询是常量复杂度，体积从10到1000万都一样。虽然不够准确，但是可以用这种直观的方式来理解集合查询为什么比列表查询要快。</p> <p>集合一般是以类似字典的方式实现的，不过没有值而已。当你搜索字典中的键时，效率和搜索集合是一样的。不过，字典与集合也不是万能的。比如，当你要搜索一个区间的时候，列表可能效率更高。在有序列表中，你可以先找到区间中的低位元素，然后再遍历找到第一个大于区间高位的元素，结束搜索。而在集合或字典中，你需要为区间中的每个元素进行检索。所以，如果你知道要搜索的确切值，那么字典更快；如果要搜索的是区间，那么用二分法来搜索有序列表效果更好。</p> <p>考虑到列表在Python代码中到处都是，一定有许多场合中可以替换为更加合适的数据结构。不过列表本身作为一种基础数据结构，也有许多不错的使用场景。这里的点在于激发你的思想，而不是简单的禁用列表。</p> <blockquote><p>提示：在大型列表中使用in操作符一定要谨慎。Python代码中有大量这样的用法，对于小型列表可能问题不大，但是列表规模大了之后问题就严重了。<br>
从软件工程实践的角度出发，in操作符的使用，很可能从开发阶段不起眼的小问题，演变为生产环境中的大问题。程序员一般只用小数据集进行测试，将大数据集用于单元测试也不太实际。而真正的数据规模可能很大，一旦引入，甚至会把整个系统卡死。<br>
更加系统性的方案是，时不时地用大数据集进行测试。这不用每次都做，也不是专门针对in操作符而做，而是提醒注意开发环境和生产环境之间由数据规模带来的性能差异。</p></blockquote> <p>顺便说下，对于大部分搜索操作，有一类比列表和集合更好的数据结构：树。但本篇我们主要看Python内置的数据结构，暂时不包含树。</p> <p>完整地介绍如何选择合适的算法与数据结构超出了本书的范围，而且通常也是计算机课程中最难的一门课。所以这里的点不在于穷尽这个话题，而是让你了解Python中常见的选择。如果你觉得Python中现有的数据结构不满足需求，可能需要考虑别的数据结构，可以参考别的专门介绍数据结构与算法的书籍。</p> <p>另一个有用的资源是Python自己的<a href="https://link.zhihu.com/?target=https%3A//wiki.python.org/moin/TimeComplexity%2520" target="_blank" rel="noopener noreferrer">TimeComplexity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，包含了Python中许多数据结构上的各种操作的时间复杂度。</p> <p>本篇到这里关注的都是时间上的表现，但这不是大数据集性能的唯一影响因素，接下来我们要看看另一个重要的因素，内存占用。</p> <p>‍</p> <h2 id="寻找过度的内存分配"><a href="#寻找过度的内存分配" class="header-anchor">#</a> 寻找过度的内存分配</h2> <p>内存消耗对于性能影响也很关键。有效的内存分配可以让更多进程并行运行于同一个机器上。</p> <p>让我们回到熟悉的NOAA数据库，让我们看看如何减少数据对磁盘的占用。为此，我们从调研数据文件的内容开始。此处的目标是加载一部分文件，对特征分布做一些统计。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">download_all_data</span><span class="token punctuation">(</span>stations<span class="token punctuation">,</span> start_year<span class="token punctuation">,</span> end_year<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> station <span class="token keyword">in</span> stations<span class="token punctuation">:</span>
        <span class="token keyword">for</span> year <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start_year<span class="token punctuation">,</span> end_year <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>TEMPLATE_FILE<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>station<span class="token operator">=</span>station<span class="token punctuation">,</span> year<span class="token operator">=</span>year<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                download_data<span class="token punctuation">(</span>station<span class="token punctuation">,</span> year<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_all_files</span><span class="token punctuation">(</span>stations<span class="token punctuation">,</span> start_year<span class="token punctuation">,</span> end_year<span class="token punctuation">)</span><span class="token punctuation">:</span>
    all_files <span class="token operator">=</span> collections<span class="token punctuation">.</span>defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> station <span class="token keyword">in</span> stations<span class="token punctuation">:</span>
        <span class="token keyword">for</span> year <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start_year<span class="token punctuation">,</span> end_year <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>TEMPLATE_FILE<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>station<span class="token operator">=</span>station<span class="token punctuation">,</span> year<span class="token operator">=</span>year<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
            content <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            all_files<span class="token punctuation">[</span>station<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> all_files


stations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'01044099999'</span><span class="token punctuation">]</span>
start_year <span class="token operator">=</span> <span class="token number">2005</span>
end_year <span class="token operator">=</span> <span class="token number">2021</span>
download_all_data<span class="token punctuation">(</span>stations<span class="token punctuation">,</span> start_year<span class="token punctuation">,</span> end_year<span class="token punctuation">)</span>
all_files <span class="token operator">=</span> get_all_files<span class="token punctuation">(</span>stations<span class="token punctuation">,</span> start_year<span class="token punctuation">,</span> end_year<span class="token punctuation">)</span>
</code></pre></div><p>这里的all_files是一个字典，其中每个条目都包含了某一个站点的全部内容。让我们来研究一下其内存开销。</p> <h3 id="查看python内存预测中的坑"><a href="#查看python内存预测中的坑" class="header-anchor">#</a> 查看Python内存预测中的坑</h3> <p>Python在sys模块中提供了一个函数，getsizeof，返回的是一个对象所占据的内存空间。我们可以通过下面的代码来理解字典对象占据的内存空间：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>print(sys.getsizeof(all_files))
print(sys.getsizeof(all_files.values()))
print(sys.getsizeof(list(all_files.values())))
</code></pre></div><p>结果分别是：240、40、60。</p> <p>这里getsizeof返回的结果未必如你所想象，因为磁盘上的文件是以MB为单位的，这里返回的大小在1KB以下不免让人疑惑。这里getsizeof返回的是容器大小（第一个是字典，第二个是迭代器，第三个是列表），不包含其中的内容。所以我们要考虑的两种不同的东西对内存的占用：容器中的内容，还有容器本身。</p> <blockquote><p>注意，这里getsizeof的实现本身是没有问题的，只是和用户的预期不太一致，一般用户期待其能够囊括对象中引用到的全部内容。如果你阅读官方文档，你会找到一种递归式的实现指令来解决这个问题。对我们来说，这个小插曲正好是深入理解CPython内存分配的不错的起点。</p></blockquote> <p>接下来获取一些关于站点数据的信息：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>station_content = all_files[stations[0]]
print(len(station_content))
print(sys.getsizeof(station_content))
</code></pre></div><p>返回的结果分别是17和248，字典中只有一个条目，这个条目对应的是一个列表，列表中有17个对象。列表本身是248字节，但是不包含其中的内容。接下来看看列表中第一个对象的大小。</p> <div class="language-python3 extra-class"><pre class="language-text"><code>print(len(station_content[0]))
print(sys.getsizeof(station_content[0]))
print(type(station_content[0]))
</code></pre></div><p>这里的长度是1303981，对应文件的大小。getsizeof的结果是10431904，差不多是前者的8倍，为什么呢？每个元素是一个指针，指向一个字符，每个指针是8字节。这里看起来很不妙，数据结构很大，我们没有很好的处理。接下来再看看单个的字符：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>print(sys.getsizeof(station_content[0][0]))
print(type(station_content[0][0]))
</code></pre></div><p>这在体积上是巨大的。输出是28，类型是int。每个字符，即便只需要1个字节，这里都花费了28字节来表示。因此我们的列表花费了10431904加上28x1303981，总计46943372，大约是原始文件的36倍大。幸运的是，我们还有办法优化，CPython在内存分配方面还是挺聪明的。</p> <p>CPython可以用一种更加精妙的方式来分配对象，远不像我们这种算法那样原始。让我们来计算内部内容的大小，不过不再是遍历矩阵中所有的数字，我们要确保不会重复计算。在Python中，如果一个对象被重复使用，那么这个对象会有相同的id。如果我们多次看见相同的id，我们应该只记录一次内存分配。</p> <div class="language-python3 extra-class"><pre class="language-text"><code>single_file_data = station_content[0]
all_ids = set()
for entry in single_file_data:
    all_ids.add(id(entry))
print(len(all_ids))
</code></pre></div><p>前面的代码获取了我们所有数字的唯一标识符。在CPython中，这会在内存分配的时候发生。CPython很明智地看到了相同的字符串内容会被反复使用，ASCII字符是由0到127之间的数字表示的，而上面的代码返回的结果是46。</p> <p>所以，CPython在内存分配方面还是挺聪明的。这里的内存消耗就是列表的开销（10431904），加上46个不同的字符，几乎可以忽略。虽然Python在内存分配方面表现不错，但是不要指望每次都有最佳效果，因为这取决于数据的模式。</p> <blockquote><p>Python中的对象缓存和重用<br>
Python会尽可能重用对象，但我们对这个预期要慎重。一方面这个特性取决于具体的实现，CPython和其它Python版本的行为是不一样的。另一方面，即便CPython也不保证每个版本的行为都一样。最后，即便是同一个版本，其工作细节也未必是一目了然。</p></blockquote> <p>这里我们使用数字列表的形式来展示文件内容，那么其它的表示方式如何呢？</p> <h3 id="其它展示形式的内存占用"><a href="#其它展示形式的内存占用" class="header-anchor">#</a> 其它展示形式的内存占用</h3> <p>接下来我们看看用别的方式来表示文件中的内容，有时候可能更好，有时候可能更差。这里主要是理解每种机制背后的代价。相比于使用整数来表示每个字符，我们可以使用长度为1的字符串：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>single_file_str_list = [chr(i) for i in single_file_data]
</code></pre></div><p>这种方式比之前的还要糟糕，可以看看每个长度为1的字符串要占据多少空间：</p> <div class="language-text extra-class"><pre class="language-text"><code>print(sys.getsizeof(single_file_str_list[0]))
</code></pre></div><p>返回的是50，而之前用整数表示的时候还只需要28，我们不会采用这种方案。</p> <p>​<img src="assets/v2-a1cb8e323a147376612361cbc76ad615_b-20231122114018-u29ucei.jpg" alt="">​</p> <p>图2.3</p> <p>Python在处理许多小对象的时候开销是蛮大的。为什么整数需要28字节，而字符串需要50字节呢？每个Python对象需要24字节的开销，另外根据类型不同，还要加上额外的开销。如图2.3所示，字符串的开销比字节数组要更大。</p> <p>我们还可以用另一种更加直观的方式来表示文件内容：相比于一个个字符， 我们使用一个字符串来容纳整个文件。</p> <div class="language-python3 extra-class"><pre class="language-text"><code>single_file_str = ''.join(single_file_str_list)
print(sys.getsizeof(single_file_str))
</code></pre></div><p>这里的大小是1304030，也就是文件大小加上字符串对象的开销。尽管这种方法简单又直观，但我们还是会沿用容器和字节序列，因为这些方法还有提升的空间。</p> <h3 id="使用数组作为一种紧凑表示以取代列表"><a href="#使用数组作为一种紧凑表示以取代列表" class="header-anchor">#</a> 使用数组作为一种紧凑表示以取代列表</h3> <p>这里我们来看看另一种元素容器，数组，是如何提升内存使用效率的。让我们回顾以下get_all_files函数的实现：</p> <div class="language-python3 extra-class"><pre class="language-text"><code>def get_all_files_clean(stations, start_year, end_year):
    all_files = collections.defaultdict(list)
    for station in stations:
        for year in range(start_year, end_year + 1):
            f = open(TEMPLATE_FILE.format(station=station, year=year), 'rb')
            content = f.read()
            all_files[station].append(content)
            f.close()
    return all_files
</code></pre></div><p>这里原先是content = list(<a href="https://link.zhihu.com/?target=http%3A//f.read/" target="_blank" rel="noopener noreferrer">f.read<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>())，将read函数返回的内容转换为列表。现在不再转成列表，而是直接返回字节数组，让我们看看对象的体积：</p> <div class="language-text extra-class"><pre class="language-text"><code>print(type(single_file_data))
print(sys.getsizeof(single_file_data))
</code></pre></div><p>这里的类型是bytes，包含数据在内的大小是1304014。</p> <p>数组是固定大小的，只能容纳相同类型的数据，因此对数据表示可以更加紧凑。</p> <blockquote><p>列表中的内存占用<br>
当你分配一个列表，Python会将来可能添加的内容分配额外的空间，因此列表实际占据的空间比你想象的大。这也让数据插入更方便，不用每次都另外分配内存，除非之前分配的空间耗尽。当然这里的代价就是内存损耗，这种损耗也不大，除非你有许许多多小列表。</p></blockquote> <p>许多和数组管理相关的代码都在array模块中。不过在本篇之外我们就不会用array模块了，我们会使用NumPy，全面优于前者。不过这里的点在于理解和消除对象的内存损耗。</p> <p>在这个阶段，你应该洞察Python对象在内存使用中的代价和陷阱。最后，我们会理解如何计算Python对象的内存使用。</p> <h3 id="将我们的所学系统化-估算python对象的内存消耗"><a href="#将我们的所学系统化-估算python对象的内存消耗" class="header-anchor">#</a> 将我们的所学系统化，估算Python对象的内存消耗</h3> <p>现在你已经对内存分配有了基本的理解，掌握了底层的原则，我们会通过代码将之前的知识融合进一个功能函数，对内存的消耗给出一个较好的评估。</p> <p>我们要汇聚本篇中所有的知识点，在下面的函数中计算不仅包含对象的大小，还有容器带来的开销。如果你查阅下面的代码，你会发现ID跟踪、容器计数、字符串和数组管理。</p> <p>针对通用对象计算体积是名副其实的雷区（原则上说，只用Python的方法是不太可能完成的）。下面的代码会尽可能避免重复计算对象、容器和迭代器。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> array <span class="token keyword">import</span> array
<span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterable<span class="token punctuation">,</span> Mapping
<span class="token keyword">from</span> sys <span class="token keyword">import</span> getsizeof
<span class="token keyword">from</span> types <span class="token keyword">import</span> GeneratorType


<span class="token keyword">def</span> <span class="token function">compute_allocation</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    my_ids <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    to_compute <span class="token operator">=</span> <span class="token punctuation">[</span>obj<span class="token punctuation">]</span>
    allocation_size <span class="token operator">=</span> <span class="token number">0</span>
    container_allocation <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>to_compute<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        obj_to_check <span class="token operator">=</span> to_compute<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        allocation_size <span class="token operator">+=</span> getsizeof<span class="token punctuation">(</span>obj_to_check<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>obj_to_check<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>obj_to_check<span class="token punctuation">)</span> <span class="token operator">==</span> array<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj_to_check<span class="token punctuation">,</span> GeneratorType<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj_to_check<span class="token punctuation">,</span> Mapping<span class="token punctuation">)</span><span class="token punctuation">:</span>
            container_allocation <span class="token operator">+=</span> getsizeof<span class="token punctuation">(</span>obj_to_check<span class="token punctuation">)</span>
            <span class="token keyword">for</span> ikey<span class="token punctuation">,</span> ivalue <span class="token keyword">in</span> obj_to_check<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">id</span><span class="token punctuation">(</span>ikey<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> my_ids<span class="token punctuation">:</span>
                    my_ids<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>ikey<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    to_compute<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>ikey<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token builtin">id</span><span class="token punctuation">(</span>ivalue<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> my_ids<span class="token punctuation">:</span>
                    my_ids<span class="token punctuation">.</span>add<span class="token punctuation">(</span>ivalue<span class="token punctuation">)</span>
                    to_compute<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>ivalue<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj_to_check<span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span><span class="token punctuation">:</span>
            container_allocation <span class="token operator">+=</span> getsizeof<span class="token punctuation">(</span>obj_to_check<span class="token punctuation">)</span>
            <span class="token keyword">for</span> inner <span class="token keyword">in</span> obj_to_check<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">id</span><span class="token punctuation">(</span>inner<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> my_ids<span class="token punctuation">:</span>
                    my_ids<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>inner<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    to_compute<span class="token punctuation">.</span>append<span class="token punctuation">(</span>inner<span class="token punctuation">)</span>
    <span class="token keyword">return</span> allocation_size<span class="token punctuation">,</span> allocation_size <span class="token operator">-</span> container_allocation
</code></pre></div><p>这里我们使用了迭代式的方法来计算内存分配。这种方法有利于递归式的实现，但是由于Python对递归实现和尾递归优化支持不理想，我们这里使用了迭代式的实现。</p> <p>通过C或Rust的第三方库来计算对象的大小，更多是依赖于Python实现来以某种形式提供一些信息。对于这些库，要查阅文档获取更多细节。</p> <blockquote><p>警告，你可以使用一些Python的内存度量库。我曾经用过一些这类工具，效果一般，毕竟Python中的内存估计有许多坑。如果你用的话，一定要小心。<br>
还有一些更加底层的方式来检查Python中的内存分配，我们会在后续谈到NumPy的时候再说。本篇中我们只看Python本身，不涉及外部库。</p></blockquote> <h3 id="心得-估算python对象的内存使用"><a href="#心得-估算python对象的内存使用" class="header-anchor">#</a> 心得：估算Python对象的内存使用</h3> <p>总结一下，估算内存对象的大小远比想象的要困难。sys.getsizeof不会汇报整个对象的大小，因此需要额外的工作来准确计算对象的大小。一般情况下，这个问题不好解决：有些用底层语言编写的库可能不会报告它们分配的内存大小。</p> <p>精炼的内存分配有许多好处。其一是在内存受限的情况下，允许更多进程并行运行。其二是为许多内存算法提供了工作的空间，不再像其它算法那样需要缓慢的磁盘访问了。</p> <p>‍</p> <h2 id="为大数据流水线应用延迟求值和生成器"><a href="#为大数据流水线应用延迟求值和生成器" class="header-anchor">#</a> 为大数据流水线应用延迟求值和生成器</h2> <p>现在我们要将注意力转向Python 3中广泛引入的延迟求值语法。它会任何计算推迟到实际需要使用结果数据的时候再进行，而不是在这之前进行。这对于处理大规模数据极为有用，因为有时候这些计算要花很多时间，甚至不可能完成。如果你使用生成器，你就已经用上了延迟求值。Python 3远比Python 2更“懒”，因为range、map和zip这些函数都延迟化了。这种方式可以让你处理更多的数据，使用更少的内存，更简单地创建数据流水线。</p> <h3 id="使用生成器取代标准函数"><a href="#使用生成器取代标准函数" class="header-anchor">#</a> 使用生成器取代标准函数</h3> <p>让我们回顾本篇第一节中的代码：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_file_temperatures</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token string">&quot;rt&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        reader <span class="token operator">=</span> csv<span class="token punctuation">.</span>reader<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        header <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span>
        <span class="token keyword">for</span> row <span class="token keyword">in</span> reader<span class="token punctuation">:</span>
            station <span class="token operator">=</span> row<span class="token punctuation">[</span>header<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">&quot;STATION&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token comment"># date = datetime.datetime.fromisoformat(row[header.index('DATE')])</span>
            tmp <span class="token operator">=</span> row<span class="token punctuation">[</span>header<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">&quot;TMP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            temperature<span class="token punctuation">,</span> status <span class="token operator">=</span> tmp<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> status <span class="token operator">!=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            temperature <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>temperature<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span>
            <span class="token keyword">yield</span> temperature
</code></pre></div><p>get_file_temperatures就是一个生成器（注意最后的yield）。让我们运行这个生成器。</p> <div class="language-python3 extra-class"><pre class="language-text"><code>temperatures = get_file_temperatures(TEMPLATE_FILE.format(station=&quot;01044099999&quot;, year=2021))
print(type(temperatures))
print(sys.getsizeof(temperatures))
</code></pre></div><p>这里返回的类型是generator，结构的大小是112。平时这个生成器不会做什么，只有你开始遍历的时候才会开始按需执行：</p> <div class="language-text extra-class"><pre class="language-text"><code>for temperature in temperatures:
    print(temperature)
</code></pre></div><p>这种方法有许多好处。首先也是最大的好处，不用一次性为所有的温度数据分配内存，因为它们是一个个处理的。而列表的话就需要内存来同时维护所有的温度数据。这一点非常重要，尤其是函数返回的数据结构有很多元素的情况下，直接关系到我们是否有足够的内存来执行代码。</p> <p>第二，有时候我们不需要获取全部的结果，提前计算的话会把时间浪费在无效的计算上。假设，你要写一个函数来看是否存在低于0℃的情况，你就不需要所有的结果，只要出现一个0℃以下的值就能停了。</p> <p>想要触发计算也很简单：</p> <div class="language-text extra-class"><pre class="language-text"><code>temperatures = list(temperatures)
</code></pre></div><p>这样你就失去了生成器的优势，但是有时候这也是有用的。比如，在计算时间和内存消耗可行的情况下，如果需要多次访问结果，及时求值的方式更加合理。</p> <blockquote><p>注意：Python 2和Python 3最大的区别之一是许多内置的工具进行了延迟化改造，这里说到的zip、map、filter等在Python 2中的行为是完全不同的。</p></blockquote> <p>生成器可以用来减少内存开销，甚至是计算时间。所以当你写代码返回数据序列的时候，问问自己能否将其转换成生成器。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>检测性能瓶颈要比直觉想象的要难。性能度量是寻找性能缺陷的第一步。直觉一般是错的，实证的方法才是定位性能问题的可靠方法。</li> <li>Python内部的度量工具挺有用，就是理解起来有点困难。类似SnakeViz的可视化工具可能帮我们更好地理解度量信息。</li> <li>Python内部的度量系统在帮我们定位瓶颈的时候还是有局限。line_profiler这样的工具更加精确，当然代价是运行耗时较长。</li> <li>尽管CPU性能是我们做性能优化时候第一步要考虑的，内存消耗也是同等重要，有许多间接的好处。比如，内存优化很差的应用，如果能够优化为完全内存算法，将产生可观的时间收益。</li> <li>Python提供的基础数据结构如果用的不好也会有性能影响。比如，在未排序的列表中搜索元素代价是很大的。我们要考虑Python基础数据结构上的操作复杂度。这些数据结构在Python程序中无处不在，优化的效果立竿见影。</li> <li>如果对计算复杂度有基础的理解，对编写高效代码是十分关键的。要时不时检查Python版本的变化，有时候底层的实现变了，算法的性能也会改变。</li> <li>延迟计算技术让我们使用更少的内存，甚至规避一大部分计算。</li> <li>本篇中所有的内容的适用性都很广泛，而且是其它所有技术的前置步骤。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/Python程序性能优化实战2.html" class="prev">
        Python程序性能优化实战2
      </a></span> <span class="next"><a href="/Python/Python编程核心/调试优化dump分析/所谓性能优化/四类优化方案.html">
        四类优化方案
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d3c0dc77.js" defer></script><script src="/assets/js/2.5fbe0391.js" defer></script><script src="/assets/js/1.dc7adba2.js" defer></script><script src="/assets/js/357.ec546a74.js" defer></script>
  </body>
</html>
