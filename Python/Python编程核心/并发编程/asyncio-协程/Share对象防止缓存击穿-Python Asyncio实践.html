<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Share对象防止缓存击穿-Python Asyncio实践 | 思源笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link href="/images/logo.png" rel="icon">
    <meta name="description" content="来自思源笔记的内容">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.d3c0dc77.js" as="script"><link rel="preload" href="/assets/js/2.5fbe0391.js" as="script"><link rel="preload" href="/assets/js/1.dc7adba2.js" as="script"><link rel="preload" href="/assets/js/247.19eaf435.js" as="script"><link rel="prefetch" href="/assets/js/10.a9ace829.js"><link rel="prefetch" href="/assets/js/100.1ffa901d.js"><link rel="prefetch" href="/assets/js/101.37fdabbb.js"><link rel="prefetch" href="/assets/js/102.9c0f99bd.js"><link rel="prefetch" href="/assets/js/103.571daa23.js"><link rel="prefetch" href="/assets/js/104.88901889.js"><link rel="prefetch" href="/assets/js/105.e1c7fc4a.js"><link rel="prefetch" href="/assets/js/106.366c43d3.js"><link rel="prefetch" href="/assets/js/107.077c5081.js"><link rel="prefetch" href="/assets/js/108.c7d4e1fb.js"><link rel="prefetch" href="/assets/js/109.e7b7cb8f.js"><link rel="prefetch" href="/assets/js/11.32adc493.js"><link rel="prefetch" href="/assets/js/110.86cb08fa.js"><link rel="prefetch" href="/assets/js/111.b725586a.js"><link rel="prefetch" href="/assets/js/112.9f3b9f75.js"><link rel="prefetch" href="/assets/js/113.4a5023eb.js"><link rel="prefetch" href="/assets/js/114.6556c4e7.js"><link rel="prefetch" href="/assets/js/115.72cdb14c.js"><link rel="prefetch" href="/assets/js/116.6d5b51c2.js"><link rel="prefetch" href="/assets/js/117.65ec9b76.js"><link rel="prefetch" href="/assets/js/118.7f4861c9.js"><link rel="prefetch" href="/assets/js/119.650ac25d.js"><link rel="prefetch" href="/assets/js/12.92b47e85.js"><link rel="prefetch" href="/assets/js/120.8e7250e1.js"><link rel="prefetch" href="/assets/js/121.c5a06028.js"><link rel="prefetch" href="/assets/js/122.29f4e7bd.js"><link rel="prefetch" href="/assets/js/123.5e449baf.js"><link rel="prefetch" href="/assets/js/124.a44b0134.js"><link rel="prefetch" href="/assets/js/125.df3fe3e7.js"><link rel="prefetch" href="/assets/js/126.6974e54f.js"><link rel="prefetch" href="/assets/js/127.f2454306.js"><link rel="prefetch" href="/assets/js/128.b900fa7e.js"><link rel="prefetch" href="/assets/js/129.15864c0a.js"><link rel="prefetch" href="/assets/js/13.ebfb1f42.js"><link rel="prefetch" href="/assets/js/130.cc6853ea.js"><link rel="prefetch" href="/assets/js/131.5bb214da.js"><link rel="prefetch" href="/assets/js/132.1a83e445.js"><link rel="prefetch" href="/assets/js/133.da4547b9.js"><link rel="prefetch" href="/assets/js/134.0aeb00a9.js"><link rel="prefetch" href="/assets/js/135.16eb5d31.js"><link rel="prefetch" href="/assets/js/136.67396e70.js"><link rel="prefetch" href="/assets/js/137.afeb5d96.js"><link rel="prefetch" href="/assets/js/138.36e805ef.js"><link rel="prefetch" href="/assets/js/139.7d8c0405.js"><link rel="prefetch" href="/assets/js/14.3e65117c.js"><link rel="prefetch" href="/assets/js/140.6df70824.js"><link rel="prefetch" href="/assets/js/141.f642dacf.js"><link rel="prefetch" href="/assets/js/142.10230571.js"><link rel="prefetch" href="/assets/js/143.d599ee24.js"><link rel="prefetch" href="/assets/js/144.e1a88c20.js"><link rel="prefetch" href="/assets/js/145.eb357101.js"><link rel="prefetch" href="/assets/js/146.b3fe7f16.js"><link rel="prefetch" href="/assets/js/147.dbfb2f7d.js"><link rel="prefetch" href="/assets/js/148.8ed5bf1d.js"><link rel="prefetch" href="/assets/js/149.2c73c82d.js"><link rel="prefetch" href="/assets/js/15.5304afab.js"><link rel="prefetch" href="/assets/js/150.78115158.js"><link rel="prefetch" href="/assets/js/151.22badb82.js"><link rel="prefetch" href="/assets/js/152.a99d0f22.js"><link rel="prefetch" href="/assets/js/153.6a863a43.js"><link rel="prefetch" href="/assets/js/154.c6a0b3dc.js"><link rel="prefetch" href="/assets/js/155.b8591455.js"><link rel="prefetch" href="/assets/js/156.dd9eeca0.js"><link rel="prefetch" href="/assets/js/157.48909220.js"><link rel="prefetch" href="/assets/js/158.99fac6bc.js"><link rel="prefetch" href="/assets/js/159.3bcae7d0.js"><link rel="prefetch" href="/assets/js/16.9ca9aae8.js"><link rel="prefetch" href="/assets/js/160.7c8a9be5.js"><link rel="prefetch" href="/assets/js/161.30bee0bb.js"><link rel="prefetch" href="/assets/js/162.0dde5818.js"><link rel="prefetch" href="/assets/js/163.d4de9cde.js"><link rel="prefetch" href="/assets/js/164.1aa26354.js"><link rel="prefetch" href="/assets/js/165.67d8c450.js"><link rel="prefetch" href="/assets/js/166.81d14b26.js"><link rel="prefetch" href="/assets/js/167.ae715f9a.js"><link rel="prefetch" href="/assets/js/168.f2998afb.js"><link rel="prefetch" href="/assets/js/169.fd39ee46.js"><link rel="prefetch" href="/assets/js/17.3dbcb51f.js"><link rel="prefetch" href="/assets/js/170.147fd31a.js"><link rel="prefetch" href="/assets/js/171.35f8ce60.js"><link rel="prefetch" href="/assets/js/172.10db3085.js"><link rel="prefetch" href="/assets/js/173.11a8ff33.js"><link rel="prefetch" href="/assets/js/174.e196a1f6.js"><link rel="prefetch" href="/assets/js/175.0157f18d.js"><link rel="prefetch" href="/assets/js/176.6d3d456c.js"><link rel="prefetch" href="/assets/js/177.9c40b853.js"><link rel="prefetch" href="/assets/js/178.8dd00920.js"><link rel="prefetch" href="/assets/js/179.f7f4c661.js"><link rel="prefetch" href="/assets/js/18.4c170722.js"><link rel="prefetch" href="/assets/js/180.d02b4575.js"><link rel="prefetch" href="/assets/js/181.be3c0f7a.js"><link rel="prefetch" href="/assets/js/182.ae4673f8.js"><link rel="prefetch" href="/assets/js/183.ed56a865.js"><link rel="prefetch" href="/assets/js/184.43db12b1.js"><link rel="prefetch" href="/assets/js/185.3a09c20e.js"><link rel="prefetch" href="/assets/js/186.77240fee.js"><link rel="prefetch" href="/assets/js/187.c544cb6a.js"><link rel="prefetch" href="/assets/js/188.682782b1.js"><link rel="prefetch" href="/assets/js/189.1e81f7d7.js"><link rel="prefetch" href="/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/assets/js/190.c60243cc.js"><link rel="prefetch" href="/assets/js/191.841c59cf.js"><link rel="prefetch" href="/assets/js/192.6b3c14f5.js"><link rel="prefetch" href="/assets/js/193.47319c1f.js"><link rel="prefetch" href="/assets/js/194.95c798e0.js"><link rel="prefetch" href="/assets/js/195.258b0234.js"><link rel="prefetch" href="/assets/js/196.c5e95bf4.js"><link rel="prefetch" href="/assets/js/197.0a40131d.js"><link rel="prefetch" href="/assets/js/198.6ae77026.js"><link rel="prefetch" href="/assets/js/199.be929f6f.js"><link rel="prefetch" href="/assets/js/20.0d880388.js"><link rel="prefetch" href="/assets/js/200.6fdb4cde.js"><link rel="prefetch" href="/assets/js/201.2db1075b.js"><link rel="prefetch" href="/assets/js/202.6989c482.js"><link rel="prefetch" href="/assets/js/203.fed5be3d.js"><link rel="prefetch" href="/assets/js/204.2e2bd97a.js"><link rel="prefetch" href="/assets/js/205.919ad25d.js"><link rel="prefetch" href="/assets/js/206.caf46f82.js"><link rel="prefetch" href="/assets/js/207.b2786542.js"><link rel="prefetch" href="/assets/js/208.3ff31c7c.js"><link rel="prefetch" href="/assets/js/209.1ff1e0ba.js"><link rel="prefetch" href="/assets/js/21.0ad1d6a3.js"><link rel="prefetch" href="/assets/js/210.5673535d.js"><link rel="prefetch" href="/assets/js/211.07da8ae4.js"><link rel="prefetch" href="/assets/js/212.9a0d098d.js"><link rel="prefetch" href="/assets/js/213.289228c1.js"><link rel="prefetch" href="/assets/js/214.a9e3f658.js"><link rel="prefetch" href="/assets/js/215.2c849138.js"><link rel="prefetch" href="/assets/js/216.0b799039.js"><link rel="prefetch" href="/assets/js/217.248fa9ab.js"><link rel="prefetch" href="/assets/js/218.77bc5089.js"><link rel="prefetch" href="/assets/js/219.d0bcdf70.js"><link rel="prefetch" href="/assets/js/22.288b4852.js"><link rel="prefetch" href="/assets/js/220.abb5d7d1.js"><link rel="prefetch" href="/assets/js/221.39a29724.js"><link rel="prefetch" href="/assets/js/222.c8f848c5.js"><link rel="prefetch" href="/assets/js/223.3ea7fe96.js"><link rel="prefetch" href="/assets/js/224.afb1f423.js"><link rel="prefetch" href="/assets/js/225.cdd67273.js"><link rel="prefetch" href="/assets/js/226.89d69b6c.js"><link rel="prefetch" href="/assets/js/227.f5305f39.js"><link rel="prefetch" href="/assets/js/228.3276d530.js"><link rel="prefetch" href="/assets/js/229.ca4a013c.js"><link rel="prefetch" href="/assets/js/23.730038ee.js"><link rel="prefetch" href="/assets/js/230.19be1bec.js"><link rel="prefetch" href="/assets/js/231.940832b4.js"><link rel="prefetch" href="/assets/js/232.18dbe9c8.js"><link rel="prefetch" href="/assets/js/233.03187181.js"><link rel="prefetch" href="/assets/js/234.ed91cd88.js"><link rel="prefetch" href="/assets/js/235.277f96ac.js"><link rel="prefetch" href="/assets/js/236.8dee6d1a.js"><link rel="prefetch" href="/assets/js/237.6feb0534.js"><link rel="prefetch" href="/assets/js/238.57e64c14.js"><link rel="prefetch" href="/assets/js/239.8aeba238.js"><link rel="prefetch" href="/assets/js/24.933fffa9.js"><link rel="prefetch" href="/assets/js/240.864cffac.js"><link rel="prefetch" href="/assets/js/241.a1c6f45e.js"><link rel="prefetch" href="/assets/js/242.14475f90.js"><link rel="prefetch" href="/assets/js/243.fc4f7920.js"><link rel="prefetch" href="/assets/js/244.89f0d9fc.js"><link rel="prefetch" href="/assets/js/245.4836bb38.js"><link rel="prefetch" href="/assets/js/246.c3e0d73b.js"><link rel="prefetch" href="/assets/js/248.681c16e7.js"><link rel="prefetch" href="/assets/js/249.91c7786c.js"><link rel="prefetch" href="/assets/js/25.5a3957e2.js"><link rel="prefetch" href="/assets/js/250.999d9d17.js"><link rel="prefetch" href="/assets/js/251.758471d1.js"><link rel="prefetch" href="/assets/js/252.69b6befe.js"><link rel="prefetch" href="/assets/js/253.dd46a3dd.js"><link rel="prefetch" href="/assets/js/254.be5da0c1.js"><link rel="prefetch" href="/assets/js/255.d817ce68.js"><link rel="prefetch" href="/assets/js/256.2c7be7d4.js"><link rel="prefetch" href="/assets/js/257.a6b2fbe0.js"><link rel="prefetch" href="/assets/js/258.a5554c78.js"><link rel="prefetch" href="/assets/js/259.5a99fba0.js"><link rel="prefetch" href="/assets/js/26.fe1a83b5.js"><link rel="prefetch" href="/assets/js/260.41f4e520.js"><link rel="prefetch" href="/assets/js/261.0f73b7e7.js"><link rel="prefetch" href="/assets/js/262.28fa19f9.js"><link rel="prefetch" href="/assets/js/263.4bfbecf4.js"><link rel="prefetch" href="/assets/js/264.e0c89f62.js"><link rel="prefetch" href="/assets/js/265.e9e1d674.js"><link rel="prefetch" href="/assets/js/266.a63b71fb.js"><link rel="prefetch" href="/assets/js/267.420cd7e6.js"><link rel="prefetch" href="/assets/js/268.51e0f667.js"><link rel="prefetch" href="/assets/js/269.3f0d4774.js"><link rel="prefetch" href="/assets/js/27.916eabeb.js"><link rel="prefetch" href="/assets/js/270.c644f9d3.js"><link rel="prefetch" href="/assets/js/271.35387f6e.js"><link rel="prefetch" href="/assets/js/272.a776fe07.js"><link rel="prefetch" href="/assets/js/273.6e463c6b.js"><link rel="prefetch" href="/assets/js/274.8ef8b8e6.js"><link rel="prefetch" href="/assets/js/275.aa2e316d.js"><link rel="prefetch" href="/assets/js/276.9d603319.js"><link rel="prefetch" href="/assets/js/277.d428f5d6.js"><link rel="prefetch" href="/assets/js/278.f702bcfc.js"><link rel="prefetch" href="/assets/js/279.e1449e30.js"><link rel="prefetch" href="/assets/js/28.1116b232.js"><link rel="prefetch" href="/assets/js/280.7601eaee.js"><link rel="prefetch" href="/assets/js/281.84cdb64a.js"><link rel="prefetch" href="/assets/js/282.a6f561ff.js"><link rel="prefetch" href="/assets/js/283.c55742fa.js"><link rel="prefetch" href="/assets/js/284.924e0d7d.js"><link rel="prefetch" href="/assets/js/285.a997b1fb.js"><link rel="prefetch" href="/assets/js/286.cdb934a7.js"><link rel="prefetch" href="/assets/js/287.6f03d7f1.js"><link rel="prefetch" href="/assets/js/288.79e9f811.js"><link rel="prefetch" href="/assets/js/289.4861ef8b.js"><link rel="prefetch" href="/assets/js/29.6bff2814.js"><link rel="prefetch" href="/assets/js/290.e5a58a2f.js"><link rel="prefetch" href="/assets/js/291.9fee54ed.js"><link rel="prefetch" href="/assets/js/292.f8550342.js"><link rel="prefetch" href="/assets/js/293.5f22eb00.js"><link rel="prefetch" href="/assets/js/294.0a21c523.js"><link rel="prefetch" href="/assets/js/295.278a632b.js"><link rel="prefetch" href="/assets/js/296.ffc317e3.js"><link rel="prefetch" href="/assets/js/297.239cab1c.js"><link rel="prefetch" href="/assets/js/298.9f79e196.js"><link rel="prefetch" href="/assets/js/299.5f334485.js"><link rel="prefetch" href="/assets/js/3.bc6bba9e.js"><link rel="prefetch" href="/assets/js/30.218767d4.js"><link rel="prefetch" href="/assets/js/300.0ba14677.js"><link rel="prefetch" href="/assets/js/301.e8f27c97.js"><link rel="prefetch" href="/assets/js/302.c122edfe.js"><link rel="prefetch" href="/assets/js/303.da637783.js"><link rel="prefetch" href="/assets/js/304.4ec1b29e.js"><link rel="prefetch" href="/assets/js/305.3c00ea1f.js"><link rel="prefetch" href="/assets/js/306.b20e9815.js"><link rel="prefetch" href="/assets/js/307.6b91424e.js"><link rel="prefetch" href="/assets/js/308.dc89c12c.js"><link rel="prefetch" href="/assets/js/309.cc9c859e.js"><link rel="prefetch" href="/assets/js/31.2759a7a8.js"><link rel="prefetch" href="/assets/js/310.a9d45b6b.js"><link rel="prefetch" href="/assets/js/311.2054a97f.js"><link rel="prefetch" href="/assets/js/312.4bbc87ce.js"><link rel="prefetch" href="/assets/js/313.6bfffef1.js"><link rel="prefetch" href="/assets/js/314.80c7873d.js"><link rel="prefetch" href="/assets/js/315.e2b4b0eb.js"><link rel="prefetch" href="/assets/js/316.3e4bf82f.js"><link rel="prefetch" href="/assets/js/317.67d43206.js"><link rel="prefetch" href="/assets/js/318.29c1cdea.js"><link rel="prefetch" href="/assets/js/319.902203c8.js"><link rel="prefetch" href="/assets/js/32.49c74da8.js"><link rel="prefetch" href="/assets/js/320.9f322f6c.js"><link rel="prefetch" href="/assets/js/321.9ec16835.js"><link rel="prefetch" href="/assets/js/322.3afb0458.js"><link rel="prefetch" href="/assets/js/323.7c17fa0a.js"><link rel="prefetch" href="/assets/js/324.99ba59d2.js"><link rel="prefetch" href="/assets/js/325.6317221b.js"><link rel="prefetch" href="/assets/js/326.05691f3e.js"><link rel="prefetch" href="/assets/js/327.57a0752b.js"><link rel="prefetch" href="/assets/js/328.bd689f6c.js"><link rel="prefetch" href="/assets/js/329.9d95b288.js"><link rel="prefetch" href="/assets/js/33.da97d900.js"><link rel="prefetch" href="/assets/js/330.3f1aabde.js"><link rel="prefetch" href="/assets/js/331.4d2b6bf2.js"><link rel="prefetch" href="/assets/js/332.3d04f06d.js"><link rel="prefetch" href="/assets/js/333.f76ff221.js"><link rel="prefetch" href="/assets/js/334.cd2fc1ea.js"><link rel="prefetch" href="/assets/js/335.03d03979.js"><link rel="prefetch" href="/assets/js/336.4190f1ee.js"><link rel="prefetch" href="/assets/js/337.fdb48b71.js"><link rel="prefetch" href="/assets/js/338.7db8c869.js"><link rel="prefetch" href="/assets/js/339.90cdb7f0.js"><link rel="prefetch" href="/assets/js/34.42f8b6ab.js"><link rel="prefetch" href="/assets/js/340.4ba3bbd5.js"><link rel="prefetch" href="/assets/js/341.697b02a9.js"><link rel="prefetch" href="/assets/js/342.4af3bc4a.js"><link rel="prefetch" href="/assets/js/343.ba3f5e26.js"><link rel="prefetch" href="/assets/js/344.a3cf4ad3.js"><link rel="prefetch" href="/assets/js/345.d00eb266.js"><link rel="prefetch" href="/assets/js/346.74f1e6d3.js"><link rel="prefetch" href="/assets/js/347.cc3995b9.js"><link rel="prefetch" href="/assets/js/348.37774278.js"><link rel="prefetch" href="/assets/js/349.94d05b9c.js"><link rel="prefetch" href="/assets/js/35.42c35a21.js"><link rel="prefetch" href="/assets/js/350.47f1df55.js"><link rel="prefetch" href="/assets/js/351.1627936d.js"><link rel="prefetch" href="/assets/js/352.277ab034.js"><link rel="prefetch" href="/assets/js/353.c11e8bb5.js"><link rel="prefetch" href="/assets/js/354.ba01078c.js"><link rel="prefetch" href="/assets/js/355.70321476.js"><link rel="prefetch" href="/assets/js/356.94f404af.js"><link rel="prefetch" href="/assets/js/357.ec546a74.js"><link rel="prefetch" href="/assets/js/358.d72741b2.js"><link rel="prefetch" href="/assets/js/359.31c31ceb.js"><link rel="prefetch" href="/assets/js/36.c3767d58.js"><link rel="prefetch" href="/assets/js/360.a654dc23.js"><link rel="prefetch" href="/assets/js/361.46441143.js"><link rel="prefetch" href="/assets/js/362.0aa22356.js"><link rel="prefetch" href="/assets/js/363.355f7781.js"><link rel="prefetch" href="/assets/js/364.7e5168cd.js"><link rel="prefetch" href="/assets/js/365.b5f9bbf4.js"><link rel="prefetch" href="/assets/js/366.35422147.js"><link rel="prefetch" href="/assets/js/367.17af4dd9.js"><link rel="prefetch" href="/assets/js/368.99c04015.js"><link rel="prefetch" href="/assets/js/369.6e269202.js"><link rel="prefetch" href="/assets/js/37.b8f739e7.js"><link rel="prefetch" href="/assets/js/370.4c9fc0f9.js"><link rel="prefetch" href="/assets/js/371.fe9ddc42.js"><link rel="prefetch" href="/assets/js/372.a1a19937.js"><link rel="prefetch" href="/assets/js/373.8244356e.js"><link rel="prefetch" href="/assets/js/374.046bb182.js"><link rel="prefetch" href="/assets/js/375.95079f01.js"><link rel="prefetch" href="/assets/js/376.cb4cbf85.js"><link rel="prefetch" href="/assets/js/377.7f9dcc45.js"><link rel="prefetch" href="/assets/js/378.8396aba6.js"><link rel="prefetch" href="/assets/js/379.78f55713.js"><link rel="prefetch" href="/assets/js/38.cfd18851.js"><link rel="prefetch" href="/assets/js/380.9df95a65.js"><link rel="prefetch" href="/assets/js/381.db02d710.js"><link rel="prefetch" href="/assets/js/382.f5f01bd1.js"><link rel="prefetch" href="/assets/js/383.551a9e39.js"><link rel="prefetch" href="/assets/js/384.521cbf24.js"><link rel="prefetch" href="/assets/js/385.ce4ea212.js"><link rel="prefetch" href="/assets/js/386.3f4d7458.js"><link rel="prefetch" href="/assets/js/387.70a5c9bc.js"><link rel="prefetch" href="/assets/js/388.6d8e6a12.js"><link rel="prefetch" href="/assets/js/389.0088e683.js"><link rel="prefetch" href="/assets/js/39.af3d4c88.js"><link rel="prefetch" href="/assets/js/390.ac189a90.js"><link rel="prefetch" href="/assets/js/391.77894ec3.js"><link rel="prefetch" href="/assets/js/392.94725ec9.js"><link rel="prefetch" href="/assets/js/393.0d91a9e5.js"><link rel="prefetch" href="/assets/js/394.035a8e79.js"><link rel="prefetch" href="/assets/js/395.6dfbee1b.js"><link rel="prefetch" href="/assets/js/396.beb18051.js"><link rel="prefetch" href="/assets/js/397.5326e3a9.js"><link rel="prefetch" href="/assets/js/398.02a3983e.js"><link rel="prefetch" href="/assets/js/399.59d68b2b.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.feab1c20.js"><link rel="prefetch" href="/assets/js/400.f8253cec.js"><link rel="prefetch" href="/assets/js/401.fe8992b6.js"><link rel="prefetch" href="/assets/js/402.c0f7e134.js"><link rel="prefetch" href="/assets/js/403.48996262.js"><link rel="prefetch" href="/assets/js/41.e39d4dc8.js"><link rel="prefetch" href="/assets/js/42.61fe8caf.js"><link rel="prefetch" href="/assets/js/43.a9b01c27.js"><link rel="prefetch" href="/assets/js/44.d0b30ba2.js"><link rel="prefetch" href="/assets/js/45.c503c388.js"><link rel="prefetch" href="/assets/js/46.7206f25e.js"><link rel="prefetch" href="/assets/js/47.f3038db2.js"><link rel="prefetch" href="/assets/js/48.5cb39349.js"><link rel="prefetch" href="/assets/js/49.f05e5dfa.js"><link rel="prefetch" href="/assets/js/5.7098d77a.js"><link rel="prefetch" href="/assets/js/50.f4051900.js"><link rel="prefetch" href="/assets/js/51.140718cc.js"><link rel="prefetch" href="/assets/js/52.df8cb15f.js"><link rel="prefetch" href="/assets/js/53.9322d2fd.js"><link rel="prefetch" href="/assets/js/54.083c2849.js"><link rel="prefetch" href="/assets/js/55.0db6b109.js"><link rel="prefetch" href="/assets/js/56.e36d9f94.js"><link rel="prefetch" href="/assets/js/57.aadb73ac.js"><link rel="prefetch" href="/assets/js/58.e0181ca8.js"><link rel="prefetch" href="/assets/js/59.71fa8395.js"><link rel="prefetch" href="/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/assets/js/60.ccbd5c67.js"><link rel="prefetch" href="/assets/js/61.b29ac4b8.js"><link rel="prefetch" href="/assets/js/62.2c041d9f.js"><link rel="prefetch" href="/assets/js/63.02e68290.js"><link rel="prefetch" href="/assets/js/64.52025364.js"><link rel="prefetch" href="/assets/js/65.821d4920.js"><link rel="prefetch" href="/assets/js/66.b01a2e1f.js"><link rel="prefetch" href="/assets/js/67.49786e78.js"><link rel="prefetch" href="/assets/js/68.c6418f35.js"><link rel="prefetch" href="/assets/js/69.7bd0a0e3.js"><link rel="prefetch" href="/assets/js/7.6a854e57.js"><link rel="prefetch" href="/assets/js/70.6bacad63.js"><link rel="prefetch" href="/assets/js/71.2d2f55cb.js"><link rel="prefetch" href="/assets/js/72.385a2106.js"><link rel="prefetch" href="/assets/js/73.3567215b.js"><link rel="prefetch" href="/assets/js/74.66d5e54d.js"><link rel="prefetch" href="/assets/js/75.e9939676.js"><link rel="prefetch" href="/assets/js/76.ef329155.js"><link rel="prefetch" href="/assets/js/77.704b996e.js"><link rel="prefetch" href="/assets/js/78.6a6ccbbc.js"><link rel="prefetch" href="/assets/js/79.a908ba71.js"><link rel="prefetch" href="/assets/js/80.a6cc65ef.js"><link rel="prefetch" href="/assets/js/81.55fd7628.js"><link rel="prefetch" href="/assets/js/82.9fd118ce.js"><link rel="prefetch" href="/assets/js/83.25043008.js"><link rel="prefetch" href="/assets/js/84.ec86d293.js"><link rel="prefetch" href="/assets/js/85.b4faa1bb.js"><link rel="prefetch" href="/assets/js/86.beade549.js"><link rel="prefetch" href="/assets/js/87.c816be2a.js"><link rel="prefetch" href="/assets/js/88.453dd1c1.js"><link rel="prefetch" href="/assets/js/89.eae28977.js"><link rel="prefetch" href="/assets/js/90.05307532.js"><link rel="prefetch" href="/assets/js/91.fd8bd853.js"><link rel="prefetch" href="/assets/js/92.14aed080.js"><link rel="prefetch" href="/assets/js/93.f1b00b72.js"><link rel="prefetch" href="/assets/js/94.debf50a7.js"><link rel="prefetch" href="/assets/js/95.f9a158ae.js"><link rel="prefetch" href="/assets/js/96.2833401e.js"><link rel="prefetch" href="/assets/js/97.957e0ee5.js"><link rel="prefetch" href="/assets/js/98.9c305f09.js"><link rel="prefetch" href="/assets/js/99.c8981936.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="思源笔记" class="logo"> <span class="site-name can-hide">思源笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/Python/" class="sidebar-heading clickable router-link-active open"><span>Python</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/CPython源码剖析/" class="sidebar-heading clickable"><span>CPython源码剖析</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python常用模块/" class="sidebar-heading clickable"><span>Python常用模块</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python常见问题.html" class="sidebar-link">Python常见问题</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python编程核心/" class="sidebar-heading clickable open"><span>Python编程核心</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/内存管理、垃圾回收/" class="sidebar-heading clickable"><span>内存管理、垃圾回收</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/函数/" class="sidebar-heading clickable"><span>函数</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/多语言混合开发/" class="sidebar-heading clickable"><span>多语言混合开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/并发编程/" class="sidebar-heading clickable open"><span>并发编程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/Process-多进程/" class="sidebar-heading clickable"><span>Process-多进程</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python编程核心/并发编程/Python GIL - CPython.html" class="sidebar-link">Python GIL - CPython</a></li><li><a href="/Python/Python编程核心/并发编程/Python并发编程概述.html" class="sidebar-link">Python并发编程概述</a></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/Thread-多线程/" class="sidebar-heading clickable"><span>Thread-多线程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/asyncio-协程/" class="sidebar-heading clickable open"><span>asyncio-协程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html" class="active sidebar-link">Share对象防止缓存击穿-Python Asyncio实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#参考" class="sidebar-link">参考</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#前记" class="sidebar-link">前记</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#_1-缓存击穿" class="sidebar-link">1.缓存击穿</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#_2-语言级别的解决方案" class="sidebar-link">2.语言级别的解决方案</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#_4-高并发下的问题" class="sidebar-link">4.高并发下的问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#_4-1-放行指定比例的请求" class="sidebar-link">4.1.放行指定比例的请求</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#_4-2-取消被堵住的请求" class="sidebar-link">4.2.取消被堵住的请求</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#_4-3-忘记被堵住的请求" class="sidebar-link">4.3.忘记被堵住的请求</a></li></ul></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html#完整代码" class="sidebar-link">完整代码</a></li></ul></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/mini协程库.html" class="sidebar-link">mini协程库</a></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/从生成器看协程本质.html" class="sidebar-link">从生成器看协程本质</a></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/协程-Asyncio、Gevent.html" class="sidebar-link">协程-Asyncio、Gevent</a></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html" class="sidebar-link">理解Python协程的本质</a></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/迭代器到生成器.html" class="sidebar-link">迭代器到生成器</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/其他实现/" class="sidebar-heading clickable"><span>其他实现</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python编程核心/并发编程/并发编程性能对比.html" class="sidebar-link">并发编程性能对比</a></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/并发编程数据管理/" class="sidebar-heading clickable"><span>并发编程数据管理</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/杂/" class="sidebar-heading clickable"><span>杂</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/模块化、私有化/" class="sidebar-heading clickable"><span>模块化、私有化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/测试加密打包部署/" class="sidebar-heading clickable"><span>测试加密打包部署</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/环境配置/" class="sidebar-heading clickable"><span>环境配置</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/语法基础/" class="sidebar-heading clickable"><span>语法基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/调试优化dump分析/" class="sidebar-heading clickable"><span>调试优化dump分析</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/面向对象/" class="sidebar-heading clickable"><span>面向对象</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/鸭子类型/" class="sidebar-heading clickable"><span>鸭子类型</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="share对象防止缓存击穿-python-asyncio实践"><a href="#share对象防止缓存击穿-python-asyncio实践" class="header-anchor">#</a> Share对象防止缓存击穿-Python Asyncio实践</h1> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://so1n.me/2023/08/14/python_asyncio_concunrrency_result_share/" target="_blank" rel="noopener noreferrer">https://so1n.me/2023/08/14/python_asyncio_concunrrency_result_share/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>​<code>Share</code>​对应的实现方法见<a href="https://github.com/so1n/fast-tools/blob/master/fast_tools/share.py" target="_blank" rel="noopener noreferrer">源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>‍</p> <p>​<img src="assets/1692114894425%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E9%98%B2%E6%AD%A2%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F--%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F-20231128165326-4x5yly3.png" alt="">​</p> <p>‍</p> <h2 id="前记"><a href="#前记" class="header-anchor">#</a> 前记</h2> <p>本文描述的是如何基于<code>Asyncio.Future</code>​的特性编写一个语言级别的防缓存击穿的工具–<code>Share</code>​，并介绍它的使用和高并发下的处理方法。</p> <p>‍</p> <h2 id="_1-缓存击穿"><a href="#_1-缓存击穿" class="header-anchor">#</a> 1.缓存击穿</h2> <p>‍</p> <p>在后端服务中，大部分的系统瓶颈都集中在DB上，为了提升服务性能和减轻DB压力，一般会添加一层缓存层，然后每个请求都会先从缓存层获取数据，如果获取不到数据则先从DB系统中获取数据，获取到数据后才把数据放置在缓存层中再返回数据。<br>
不过缓存层缓存的数据是有过期时间的，当设置的值过期时会导致所有请求无法从缓存层获取到数据，进而蜂拥冲向DB系统获取数据，这就是缓存击穿。由于缓存击穿是瞬时性且量级很大，所以它容易快速的提升DB系统压力，甚至打崩DB系统，流程如图：</p> <p>​<img src="assets/1692114894425%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E9%98%B2%E6%AD%A2%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F--%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F-20231128165326-4x5yly3.png" alt="">​</p> <p>‍</p> <p>从图中可以看到，在缓存值失效后，所有请求会先后击穿缓存并请求到DB系统，DB系统从被击穿到缓存值被设置的这段时间会执行大量相同的查询，这些查询除了浪费系统资源外还会提升系统压力，为此，大部分业务会使用加锁来解决这个问题。</p> <p>‍</p> <p>在加锁后，整个请求的流程就会变为先访问缓存层，在发现缓存层没有对应数据时(缓存失效)，请求会先去请求锁，当请求到锁的请求才可以去DB系统查询，并在缓存系统设置缓存值，而获取不到锁的请求只能等待锁释放后从缓存系统中获取值并返回，如图：<br>
​<img src="assets/1692115661425%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E9%98%B2%E6%AD%A2%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F-%E4%BD%BF%E7%94%A8%E9%94%81-20231128165326-11d7336.png" alt="">​</p> <p>通过图可以看到，在加锁后，访问DB系统的同类请求只剩一个了，这样一来可以减轻DB系统的压力，但是在采用加锁逻辑后会把压力从DB系统转移给了负责锁的系统，只是锁系统能容忍的上限会比DB系统高很多。<br>
此外，如果这个锁系统是一个分布式锁，那么此时的锁系统也是一个热点值，后端服务与分布式锁系统之间会因为大量的请求获取锁而产生许多IO。</p> <p>‍</p> <h2 id="_2-语言级别的解决方案"><a href="#_2-语言级别的解决方案" class="header-anchor">#</a> 2.语言级别的解决方案</h2> <p>‍</p> <p>为了在解决缓存击穿的问题，同时减少缓存击穿时导致不同系统的IO交互次数变多的情况，新的解决方案必须是编程语言级别的，而不是一个单独的组件。同时，这个解决方案除了能兜住大量缓存击穿的请求外，还需要做到只让其中的第一个访问的请求能够命中DB系统获取值再返回且拿到的值又能跟其他请求共享。</p> <p>由于这个解决方案会在多个请求之间共享值，所以我取名为<code>Share</code>​，它在系统架构中的位置如图：</p> <p>​<img src="assets/1692116134425%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E9%98%B2%E6%AD%A2%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F-%E4%BD%BF%E7%94%A8Share-20231128165326-qgh7rkc.png" alt="">​</p> <p>通过图可以发现<code>Share</code>​的位置与锁一样，不过具体逻辑却会有不同，如果仔细研究它的逻辑，会发现它的逻辑与<code>Asyncio.Future</code>​类似。</p> <p>比如在<code>asyncio.Future</code>​的使用过程中，不同的协程可以通过<code>await asyncio.Future()</code>​方法获取到已经被设置的结果，同时，如果这个值还没设置，其他协程在调用<code>await asyncio.Future()</code>​时会一直被阻塞，直到其他协程通过<code>set_result</code>​设置结果。</p> <blockquote><p>Note: 在下面介绍<code>Share</code>​中将以某个协程调用代替请求的操作</p></blockquote> <p>有了<code>asyncio.Future</code>​​后，<code>Share</code>​​的实现会变得很轻松，只要再实现如何放行第一个协程的执行即可。<code>Share</code>​​实现的第一步是定义一个类似于如下的数据结构:</p> <div class="language-python extra-class"><pre class="language-python"><code>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">]</span>
</code></pre></div><p>这个数据结构是一个Dict，其中它的key是这类协程的标识，然后再根据这个数据结构添加对应的逻辑：</p> <ul><li>当协程通过<code>Share</code>​被调用时，根据key判断是否有同类协程</li> <li>如果没有则初始化一个<code>asyncio.Future</code>​，然后再执行这个协程，在协程执行完毕时把协程的返回值设置在<code>asyncio.Future</code>​中并从字典中删除这个key以及返回数据。</li> <li>如果有则调用<code>await asyncio.Future</code>​等待第一个共享协程的返回值。</li></ul> <p>具体代码如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Any<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Callable

<span class="token comment"># 创建一个全局的字典，用于存储 Future 对象</span>
future_dict<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># 定义一个函数 share，接受一个标识符 key、一个函数 fn 和一个参数 param（可选）</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">share</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Callable<span class="token punctuation">,</span> param<span class="token punctuation">:</span> Any <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Any<span class="token punctuation">:</span>
    <span class="token comment"># 如果 key 不在 future_dict 中，则执行以下代码</span>
    <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> future_dict<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 创建一个 asyncio.Future 对象</span>
            future <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 将该 Future 对象添加到 future_dict 中，以 key 作为标识符</span>
            future_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> future
            <span class="token comment"># 调用传入的函数 fn，并等待其执行完成，将结果设置为 Future 的结果</span>
            future<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token keyword">await</span> fn<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>param <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># 无论执行成功还是出现异常，都会在最后将 key 对应的 Future 从 future_dict 中移除</span>
            future_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 如果 key 已经在 future_dict 中存在，则直接获取对应的 Future 对象</span>
        future <span class="token operator">=</span> future_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  
    <span class="token comment"># 返回 Future 对象的结果</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> future

<span class="token comment"># 定义一个异步函数 delay_return，接受一个整数参数 duration</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delay_return</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token comment"># 等待指定的时间长度</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 返回传入的参数作为结果</span>
    <span class="token keyword">return</span> duration

<span class="token comment"># 定义一个异步函数 main，用于测试 share 函数是否能够正常运行</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建一个任务列表，包含了调用 share 函数的多个任务</span>
    task_list <span class="token operator">=</span> <span class="token punctuation">[</span>share<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> delay_return<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment"># 等待所有任务完成</span>
    done<span class="token punctuation">,</span> _ <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span>
    <span class="token comment"># 输出所有任务的结果</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> done<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 运行主函数</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>在运行后可以发现，不同协程的初始化参数虽然是不同的，但是他们的结果是一样的（结果取决于哪个协程先运行），比如我这次运行后它的所有结果都为3，如下:</p> <div class="language- extra-class"><pre class="language-text"><code>[3, 3, 3, 3, 3, 3, 3, 3, 3, 3]
</code></pre></div><p>这个结果意味着语言级别的兜底逻辑的没问题的，但是它还有一些问题仍然需要解决。</p> <p>在一开始时，我也是简单的实现了一个工具函数来解决缓存击穿的问题，但是在线上运行一段时间后，发现这个工具函数仍有一些小问题需要解决，于是对它进行了一些<code>复杂化处理</code>​，使其能够拓展并解决一些高并发的问题，同时也提升了易用性。</p> <p>​<code>Share</code>​整个实现分为两部分，第一部份是一个名为<code>Token</code>​的类，它的底层就是一个<code>asyncio.Future</code>​，而提供的方法都是基于<code>asyncio.Future</code>​的封装，代码如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Any<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Union<span class="token punctuation">,</span> TypeVar<span class="token punctuation">,</span> Generic

_Tp <span class="token operator">=</span> TypeVar<span class="token punctuation">(</span><span class="token string">'_Tp'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">(</span>Generic<span class="token punctuation">[</span>_Tp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> Any<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_key<span class="token punctuation">:</span> Any <span class="token operator">=</span> key
        self<span class="token punctuation">.</span>_future<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">[</span>_Tp<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
  
    <span class="token keyword">def</span> <span class="token function">can_do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化 future 并判断是否执行后续操作</span>
        <span class="token comment"># 这个逻辑可能有点怪，但是暂时没有想到更好的办法</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_future <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
  
    <span class="token keyword">def</span> <span class="token function">is_done</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token comment"># 判断是否执行完成</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_future <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span>
  
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">await_done</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> _Tp<span class="token punctuation">:</span>
        <span class="token comment"># 获取设置在 future 的结果</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;You should use Token&lt;</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_key<span class="token punctuation">}</span></span><span class="token string">&gt;.can_do() before Token&lt;</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_key<span class="token punctuation">}</span></span><span class="token string">&gt;.await_done()&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_future
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
  
    <span class="token keyword">def</span> <span class="token function">set_result</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> result<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>_Tp<span class="token punctuation">,</span> Exception<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token comment"># 设置结果到 future 中，需要注意的是，如果是异常，需要通过 `set_exception` 设置异常，否则在设置异常后调用 `await asyncio.Future` 时不会抛出错误。</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_future <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>set_exception<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
</code></pre></div><p>而第二部分就是<code>Share</code>​​的主体部分了，代码如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> typing <span class="token keyword">import</span> Any<span class="token punctuation">,</span> Callable<span class="token punctuation">,</span> Coroutine<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> TypeVar

<span class="token comment"># 定义一个类型别名 ShareKeyType，用于标识 token 的键类型</span>
_ShareKeyType <span class="token operator">=</span> TypeVar<span class="token punctuation">(</span><span class="token string">'_ShareKeyType'</span><span class="token punctuation">)</span>

<span class="token comment"># 定义一个类型别名 P，用于参数的类型标注</span>
P <span class="token operator">=</span> TypeVar<span class="token punctuation">(</span><span class="token string">'P'</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

<span class="token comment"># 定义一个类型别名 R_T，用于函数返回值的类型标注</span>
R_T <span class="token operator">=</span> TypeVar<span class="token punctuation">(</span><span class="token string">'R_T'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Share</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化存储 token 的容器</span>
        self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>_ShareKeyType<span class="token punctuation">,</span> Token<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_get_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Token<span class="token punctuation">:</span>
        <span class="token comment"># 获取 token 的简单封装</span>
        <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> Token<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_do_handle</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">,</span>
        func<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span>P<span class="token punctuation">,</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        args<span class="token punctuation">:</span> P <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        kwargs<span class="token punctuation">:</span> P <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> R_T<span class="token punctuation">:</span>
        token<span class="token punctuation">:</span> Token <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_token<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 判断是否可以执行操作</span>
            <span class="token keyword">if</span> token<span class="token punctuation">.</span>can_do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 如果可以则执行</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token comment"># 调用传入的函数 func，并将结果设置到 token 中</span>
                    token<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token keyword">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>args <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">(</span>kwargs <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    <span class="token comment"># 存储异常值到 token 中</span>
                    token<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token comment"># 通过 token 获取值并返回，没有值则会阻塞</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> token<span class="token punctuation">.</span>await_done<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># 使用完毕后删除 token</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">,</span>
        func<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span>P<span class="token punctuation">,</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        args<span class="token punctuation">:</span> P <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        kwargs<span class="token punctuation">:</span> P <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># 执行操作的入口，调用 _do_handle 处理函数调用和返回值</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_do_handle<span class="token punctuation">(</span>key<span class="token punctuation">,</span> func<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>
</code></pre></div><p>通过代码可以发现<code>Share</code>​的主体逻辑非常简单，其中<code>_do_handle</code>​的逻辑与第二节中的<code>share</code>​函数类似，而新增的<code>do</code>​方法只是<code>_do_handle</code>​的一层封装，它在采用了<code>PEP-612</code>​的类型标注后，使用者可以方便的从编辑器知道do的返回类型，接下来通过一段代码来检查<code>Share</code>​是否正常，如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delay_return</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> durationasync <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    share <span class="token operator">=</span> Share<span class="token punctuation">(</span><span class="token punctuation">)</span>
    task_list <span class="token operator">=</span> <span class="token punctuation">[</span>share<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> delay_return<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    done<span class="token punctuation">,</span> _ <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> done<span class="token punctuation">]</span><span class="token punctuation">)</span>asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>在运行代码后输出如下（值可能不同）:</p> <div class="language- extra-class"><pre class="language-text"><code>[3, 3, 3, 3, 3, 3, 3, 3, 3, 3] 
</code></pre></div><p>通过结果可以发现<code>Share</code>​运行正常，毕竟它的实现逻辑与<code>share</code>​函数类似，但是当把鼠标移动到<code>task_list</code>​上面可以发现，由于<code>do</code>​方法采用了<code>PEP-612</code>​的类型标注后，编辑器可以展示它的类型了，如下:</p> <p>​<img src="assets/16920949016431692094900746-20231128165326-zag34b6.png" alt="">​</p> <p>此外，基于<code>_do_handle</code>​可以开发出一个装饰器，这样用起来就非常方便了，使用方法如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    share <span class="token operator">=</span> Share<span class="token punctuation">(</span><span class="token punctuation">)</span>    @share<span class="token punctuation">.</span>wrapper_do<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delay_return</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> duration    task_list <span class="token operator">=</span> <span class="token punctuation">[</span>share<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> delay_return<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    done<span class="token punctuation">,</span> _ <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> done<span class="token punctuation">]</span><span class="token punctuation">)</span>asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>对应的实现方法见<a href="https://github.com/so1n/fast-tools/blob/master/fast_tools/share.py" target="_blank" rel="noopener noreferrer">源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>‍</p> <h2 id="_4-高并发下的问题"><a href="#_4-高并发下的问题" class="header-anchor">#</a> 4.高并发下的问题</h2> <p>现在通过<code>Share</code>​可以解决缓存击穿的问题了，但是与其他中间层一样，在引入<code>Share</code>​之后会产生其他的严重的问题。</p> <p>假设有这样一个场景，这个场景使用的DB系统有一个奇葩的Bug，这个Bug会导致每有1w次请求就有一个请求会被堵塞10秒，在未引入缓存击穿的保护逻辑之前，并不会有什么太大的影响，因为它的影响面很小，毕竟平均下来一个用户一天也就遇到几次，但是在引入缓存击穿保护的逻辑之后，就需要考虑这个问题对系统的影响了。<br>
因为缓存击穿保护逻辑放行的请求在通过DB获取数据时，刚好遇到了Bug而堵塞了10秒，导致这个请求被堵住10秒后才能获取到值，这样会导致所有经过<code>Share</code>​的请求在10秒内都被堵住，而这时影响面就非常大了。<br>
首先它会影响到使用这个功能的所有接口在这10秒内这些功能无法使用，其次是这些请求会占用文件描述符和内存等资源，在占用过多时会影响其它服务的使用进而造成服务雪崩，为此需要对<code>Share</code>​进行改进，防止单个请求异常而影响到其他地方的问题。</p> <blockquote><p>使用<code>asyncio.wait</code>​之类的带有超时异常机制的方法来执行也是可以的，因为<code>Python Asyncio</code>​的异常传递性，无论是<code>asyncio.wait(share.do(xxx), timeout=xxx)</code>​还是<code>share.do(asyncio.wait(xxx, timeout=xxx))</code>​，第一个被放行的协程在执行超时后抛出的异常会传递给其他协程。</p></blockquote> <h3 id="_4-1-放行指定比例的请求"><a href="#_4-1-放行指定比例的请求" class="header-anchor">#</a> 4.1.放行指定比例的请求</h3> <p>目前的<code>Share</code>​只会允许第一个协程能被真正的执行，如果可以按照一定的几率放行请求，那么就能在防止请求堵住与降低DB压力之间做到一个平衡。具体的代码实现如下（只列出变更的方法）:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Share</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rate<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># 当rate = (1, 100)时代表是百分之一</span>
        <span class="token comment"># 当rate = (1, 1000)时代表是千分之一</span>
        <span class="token keyword">if</span> rate <span class="token keyword">and</span> rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> rate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;rate[0] should less than rate[1], but </span><span class="token interpolation"><span class="token punctuation">{</span>rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> &gt; </span><span class="token interpolation"><span class="token punctuation">{</span>rate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_rate<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> rate
        self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>_ShareKeyType<span class="token punctuation">,</span> Token<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_do_handle</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">,</span> func<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span>P<span class="token punctuation">,</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">:</span> P<span class="token punctuation">.</span>args<span class="token punctuation">,</span> kwargs<span class="token punctuation">:</span> P<span class="token punctuation">.</span>args
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> R_T<span class="token punctuation">:</span>
        token<span class="token punctuation">:</span> Token <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_token<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            can_do <span class="token operator">=</span> token<span class="token punctuation">.</span>can_do<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> can_do <span class="token keyword">and</span> self<span class="token punctuation">.</span>_rate<span class="token punctuation">:</span>
                can_do <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_rate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>_rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> can_do<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token comment"># 多个请求也无所谓，Token会确保只有一个请求执行</span>
                    token<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token keyword">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>args <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">(</span>kwargs <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    token<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> token<span class="token punctuation">.</span>await_done<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre></div><p>代码中<code>Share</code>​在<code>__init__</code>​方法添加了一个新的参数<code>rate</code>​，并在<code>_do_handle</code>​方法中使用到，新的<code>_do_handle</code>​方法除了会放行第一个协程外，其他的协程会通过<code>rate</code>​来决定是否放行，具体的逻辑是调用者在通过<code>Share</code>​的<code>_do_handle</code>​执行协程时，<code>_do_handle</code>​在判断不允许放行后会使用<code>random</code>​模块根据<code>rate</code>​生成一个随机数，如果生成的随机数与<code>rate[0]</code>​相等时就会放行请求，现在改进第三节的测试代码以便验证<code>rate</code>​的效果，具体代码如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delay_return</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token comment"># 由于结果只有一个，所以需要打印出来才能判断是否有多个协程被放行</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;I go it, </span><span class="token interpolation"><span class="token punctuation">{</span>duration<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> durationasync <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token comment"># 设置有1/3的放行概率</span>
    share <span class="token operator">=</span> Share<span class="token punctuation">(</span>rate<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task_list <span class="token operator">=</span> <span class="token punctuation">[</span>share<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> delay_return<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    done<span class="token punctuation">,</span> _ <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> done<span class="token punctuation">]</span><span class="token punctuation">)</span>asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>在运行程序后一般会看到有多条<code>I go it, xxx</code>​的文本输出，如下:</p> <div class="language- extra-class"><pre class="language-text"><code>I go it, 2
I go it, 1
I go it, 6
I go it, 3
[2, 2, 2, 2, 2, 2, 2, 2, 2, 2]
</code></pre></div><p>通过输出也可以看到经过<code>Share</code>​的处理后，所有协程获取到的结果还是取决于第一个协程执行的结果，但是确实有4个协程得到了执行了，这样一来即使有第个协程被堵住，其他协程也能够正常执行。</p> <p>除了自动的按照一定比例放行协程的执行外，<code>Share</code>​还有两个方法可以手动放行协程的执行，调用者只需要自己根据业务场景在恰当的时间调用对应的方法也可以解决高并发下由于引入<code>Share</code>​而引发的问题。</p> <blockquote><p>比如每隔n秒钟执行一次。</p></blockquote> <p>‍</p> <h3 id="_4-2-取消被堵住的请求"><a href="#_4-2-取消被堵住的请求" class="header-anchor">#</a> 4.2.取消被堵住的请求</h3> <p>​<code>Token</code>​底层的<code>asyncio.Future</code>​拥有一个<code>cancel</code>​的方法，通过调用<code>cancel</code>​方法后不仅可以取消<code>Future</code>​还可以把取消异常传递给<code>Future</code>​对应的协程，进而中断协程的运行。</p> <blockquote><p>对于取消机制和<code>asyncio.Future</code>​可以参考:</p> <ul><li><a href="https://so1n.me/2023/03/25/python_asyncio_lib_cancel" target="_blank" rel="noopener noreferrer">Python Asyncio 库之从ChatGPT Bug了解Cancel机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://so1n.me/2022/04/11/python's_waitable_objects_in_asyncio/" target="_blank" rel="noopener noreferrer">Python的可等待对象在Asyncio的作用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <p>于是可以通过这个方法使<code>Share</code>​拥有取消被堵住的请求功能， 具体的改进逻辑是先在<code>Token</code>​暴露出一个<code>cancel</code>​的方法，这个方法会尽最大的能力取消可以被取消的<code>Future</code>​:</p> <div class="language- extra-class"><pre class="language-text"><code>class Token(Generic[_Tp]):
    ...    def cancel(self) -&gt; bool:
        # 如果future可以被取消，则尽最大的努力取消future
        if self._future is not None and not self._future.done():
            if self._future.cancelled():
                self._future.cancel()
            else:
                self.set_result(asyncio.CancelledError())
            return True
        return False
</code></pre></div><p>不过<code>Token</code>​只是<code>Future</code>​的封装，调用者无法接触到<code>Token</code>​，所以需要在<code>Share</code>​添加一个<code>cancel</code>​方法使调用者可以通过这个方法取消因<code>Share</code>​影响的协程，从而释放资源占用，具体修改代码如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Share</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">cancel</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>_ShareKeyType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> key<span class="token punctuation">:</span>
            <span class="token comment"># 如果key为空，则取消所有相关token</span>
            <span class="token keyword">for</span> token <span class="token keyword">in</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                token<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 不为空则按照Key取消指定的token</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>修改完毕后编写一段代码进行验证：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token comment"># 定义一个协程来模拟延迟打印操作</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delay_print</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> duration

<span class="token comment"># 定义一个用于取消共享的协程</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">cancel_in_aio</span><span class="token punctuation">(</span>share<span class="token punctuation">:</span> <span class="token string">&quot;Share&quot;</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    share<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 定义一个Share类（代码片段中未提供实现）</span>
<span class="token keyword">class</span> <span class="token class-name">Share</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于管理/取消的令牌或任务的占位符</span>
  
    <span class="token keyword">def</span> <span class="token function">cancel</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 取消与此共享关联的令牌或任务的逻辑</span>
        <span class="token keyword">pass</span>

<span class="token comment"># 主函数用于协调异步任务</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    share <span class="token operator">=</span> Share<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建一个Share实例</span>
    task_list<span class="token punctuation">:</span> <span class="token string">&quot;List[Coroutine]&quot;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        share<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token string">&quot;test_cancel_in_aio&quot;</span><span class="token punctuation">,</span> delay_print<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
    <span class="token comment"># 添加一个任务来取消与共享相关的所有令牌</span>
    task_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cancel_in_aio<span class="token punctuation">(</span>share<span class="token punctuation">)</span><span class="token punctuation">)</span>
  
    t_list <span class="token operator">=</span> <span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> task_list<span class="token punctuation">]</span>  <span class="token comment"># 为每个协程创建任务</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 等待一段时间</span>
  
    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> t <span class="token keyword">in</span> t_list<span class="token punctuation">:</span>
        <span class="token comment"># 跳过对'cancel_in_aio'协程的计数</span>
        <span class="token keyword">if</span> t<span class="token punctuation">.</span>_coro<span class="token punctuation">.</span>__name__ <span class="token operator">==</span> <span class="token string">&quot;cancel_in_aio&quot;</span><span class="token punctuation">:</span>  <span class="token comment"># type: ignore</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> t  <span class="token comment"># 等待每个任务完成</span>
            result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 对成功完成的任务追加1</span>
        <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>CancelledError<span class="token punctuation">:</span>
            result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 对被取消的任务追加0</span>
  
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>  <span class="token comment"># 打印结果</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 在asyncio事件循环中运行主函数</span>
</code></pre></div><p>运行代码后可以看到输出结果如下，通过输出结果可以知道所有协程都被取消了:</p> <div class="language- extra-class"><pre class="language-text"><code>1
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>[0, 0, 0, 0, 0, 0, 0, 0, 0]
</code></pre></div><p>‍</p> <h3 id="_4-3-忘记被堵住的请求"><a href="#_4-3-忘记被堵住的请求" class="header-anchor">#</a> 4.3.忘记被堵住的请求</h3> <p>直接取消同一类请求也可能太狠了，它属于一个应急的方法，在业务场景中该操作可能导致多数用户在同一时间内都收到异常响应，为此<code>Share</code>​还引入一个<code>forget</code>​的功能，使<code>Share</code>​能忘掉当前托管的<code>Token</code>​，使后续的请求访问<code>Share</code>​时，<code>Share</code>​能够另起炉灶一个新的<code>Token</code>​，这样一来新的请求被会之前的<code>Token</code>​影响到。这个功能对应的改造很简单，只需要动到<code>Share</code>​类，如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Share</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">forget</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Token </span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> not found&quot;</span></span><span class="token punctuation">)</span>
        token <span class="token operator">=</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>is_done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>token<span class="token punctuation">}</span></span><span class="token string"> is done&quot;</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre></div><p>接着在修改对应的老朋友–验证代码，如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delay_return</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> durationasync <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    share <span class="token operator">=</span> Share<span class="token punctuation">(</span><span class="token punctuation">)</span>
    a_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Task<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">[</span>share<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> delay_return<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>
    share<span class="token punctuation">.</span>forget<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">)</span>
    b_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Task<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">[</span>share<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> delay_return<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">{</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token keyword">await</span> a_task<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">{</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token keyword">await</span> b_task<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这段代码会执行两批协程，第一批返回的值只有可能是0-9,而第二批的值只有可能是10-19，它们的运行间隔只有0.01秒，但是运行时长是一样的。<br>
此外，在执行第二批之前会先调用<code>share.forget(&quot;demo&quot;)</code>​，使<code>Share</code>​忘记了自己托管过第一批协程，在运行代码后可以看到如下输出:</p> <div class="language- extra-class"><pre class="language-text"><code>{4}
{15}
</code></pre></div><p>通过输出可以发现，第一批协程执行时间与第二批协程执行的时间虽然是一样的，但是他们共享的是不同的结果，<code>Share</code>​会正常的忘记掉第一批协程。</p> <p>不过这个功能还是有点缺陷，假设第二批协程都能正常执行，但第一批协程还是因为被放行的协程在执行时被堵住而全都堵塞了，这是一种糟糕的情况。<br>
大部分场景下都希望第二批协程执行完毕后，第一批协程也能共享到第一批协程的执行结果(被卡住的协程除外)，于是需要对<code>forget</code>​的功能进行升级。<br>
首先是<code>Token</code>​的改造，<code>Token</code>​需要在被<code>forget</code>​后又能在下个协程调用时重新被<code>记</code>​起来，改造的代码如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">(</span>Generic<span class="token punctuation">[</span>_Tp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> Any<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 标记Token是否处于被忘记</span>
        self<span class="token punctuation">.</span>is_forget <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>_key<span class="token punctuation">:</span> Any <span class="token operator">=</span> key
        self<span class="token punctuation">.</span>_future<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">[</span>_Tp<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>    <span class="token keyword">def</span> <span class="token function">can_do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_future <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_forget<span class="token punctuation">:</span>
            <span class="token comment"># 如果该Token被忘记了，但是future还存在，那就重新记得Token，并放行该协程</span>
            self<span class="token punctuation">.</span>is_forget <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>接着就是<code>Share</code>​的改造，主要是添加一个参数用于判断在调用<code>forget</code>​时是否为强制<code>忘记</code>​，代码如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Share</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">forget</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">,</span> force<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># 添加一个参数用于是否强制忘记</span>
        <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Token </span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> not found&quot;</span></span><span class="token punctuation">)</span>
        token <span class="token operator">=</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>is_done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>token<span class="token punctuation">}</span></span><span class="token string"> is done&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> force<span class="token punctuation">:</span>
            <span class="token comment"># 如果是强制忘记则像之前一样移除Token</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 不是强制忘记则只标记Token的属性为忘记，等待重新被记起来</span>
            token<span class="token punctuation">.</span>is_forget <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre></div><p>接着运行如下测试代码:</p> <div class="language-python extra-class"><pre class="language-python"><code>_is_first<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delay_return</span><span class="token punctuation">(</span>duration<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> _is_first
    <span class="token keyword">if</span> _is_first<span class="token punctuation">:</span>
        <span class="token comment"># 第一个执行的协程耗费的时间会比较久一点</span>
        _is_first <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>duration<span class="token punctuation">}</span></span><span class="token string"> is first&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> durationasync <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    share <span class="token operator">=</span> Share<span class="token punctuation">(</span><span class="token punctuation">)</span>
    a_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Task<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">[</span>share<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> delay_return<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>
    share<span class="token punctuation">.</span>forget<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> force<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    b_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Task<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">[</span>share<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> delay_return<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token comment"># a_task会执行比较久，所以先打印b_task</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">{</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token keyword">await</span> b_task<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">{</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token keyword">await</span> a_task<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>然后可以在终端中看到如下输出：</p> <div class="language- extra-class"><pre class="language-text"><code>1
2
3
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>4 is first
{12} 291267.247258633
{12} 291269.238582831
</code></pre></div><p>通过输出可以发现，4是最先执行的，但是最后<code>a</code>​​和<code>b</code>​​任务的结果都是12（第二批的值），同时第一批执行完毕的时间是比第二批晚了3秒钟。</p> <p>‍</p> <h2 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> random
<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Any<span class="token punctuation">,</span> Callable<span class="token punctuation">,</span> Coroutine<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Generic<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Tuple<span class="token punctuation">,</span> TypeVar<span class="token punctuation">,</span> Union

<span class="token keyword">from</span> typing_extensions <span class="token keyword">import</span> ParamSpec

__all__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;Share&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Token&quot;</span><span class="token punctuation">)</span>
_Tp <span class="token operator">=</span> TypeVar<span class="token punctuation">(</span><span class="token string">&quot;_Tp&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">(</span>Generic<span class="token punctuation">[</span>_Tp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Result and status of managed actions&quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> Any<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>is_forget <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>_key<span class="token punctuation">:</span> Any <span class="token operator">=</span> key
        self<span class="token punctuation">.</span>_future<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">[</span>_Tp<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">can_do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Determine whether there is a future, if not, create a new future and return true, otherwise return false&quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_future <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_forget<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>is_forget <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">is_done</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Determine whether the execution is completed&quot;&quot;&quot;</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_future <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">cancel</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Cancel the execution of the current action&quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_future <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>cancelled<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>CancelledError<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">await_done</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> _Tp<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Wait for execution to end and return data&quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;You should use Token&lt;</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_key<span class="token punctuation">}</span></span><span class="token string">&gt;.can_do() before Token&lt;</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_key<span class="token punctuation">}</span></span><span class="token string">&gt;.await_done()&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_future
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">set_result</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> result<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>_Tp<span class="token punctuation">,</span> Exception<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;set data or exception&quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_future <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>set_exception<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_future<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


_ShareKeyType <span class="token operator">=</span> Union<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span>
P <span class="token operator">=</span> ParamSpec<span class="token punctuation">(</span><span class="token string">&quot;P&quot;</span><span class="token punctuation">)</span>
R_T <span class="token operator">=</span> TypeVar<span class="token punctuation">(</span><span class="token string">&quot;R_T&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Share</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rate<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> rate <span class="token keyword">and</span> rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> rate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;rate[0] should less than rate[1], but </span><span class="token interpolation"><span class="token punctuation">{</span>rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> &gt; </span><span class="token interpolation"><span class="token punctuation">{</span>rate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_rate<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> rate
        self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span>_ShareKeyType<span class="token punctuation">,</span> Token<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_get_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Token<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Get the token (if not, create a new one and return)&quot;&quot;&quot;</span>
        <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> Token<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">cancel</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>_ShareKeyType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Cancel the execution of the specified action, if the key is empty, cancel all&quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> key<span class="token punctuation">:</span>
            <span class="token keyword">for</span> token <span class="token keyword">in</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                token<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forget</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">,</span> force<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Token </span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> not found&quot;</span></span><span class="token punctuation">)</span>
        token <span class="token operator">=</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>is_done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>token<span class="token punctuation">}</span></span><span class="token string"> is done&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> force<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            token<span class="token punctuation">.</span>is_forget <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_do_handle</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">,</span> func<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span>P<span class="token punctuation">,</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">:</span> P<span class="token punctuation">.</span>args<span class="token punctuation">,</span> kwargs<span class="token punctuation">:</span> P<span class="token punctuation">.</span>args
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> R_T<span class="token punctuation">:</span>
        token<span class="token punctuation">:</span> Token <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_token<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            can_do <span class="token operator">=</span> token<span class="token punctuation">.</span>can_do<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> can_do <span class="token keyword">and</span> self<span class="token punctuation">.</span>_rate<span class="token punctuation">:</span>
                can_do <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_rate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>_rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> can_do<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token comment"># It doesn't matter if you have multiple requests,</span>
                    <span class="token comment"># Token will ensure that only one request is executed</span>
                    token<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token keyword">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>args <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">(</span>kwargs <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    token<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> token<span class="token punctuation">.</span>await_done<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        key<span class="token punctuation">:</span> _ShareKeyType<span class="token punctuation">,</span>
        func<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span>P<span class="token punctuation">,</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        args<span class="token punctuation">:</span> P<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        kwargs<span class="token punctuation">:</span> P<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_do_handle<span class="token punctuation">(</span>key<span class="token punctuation">,</span> func<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">wrapper_do</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> only_include_class_param<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> include_param<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Callable<span class="token punctuation">:</span>
        <span class="token keyword">if</span> only_include_class_param <span class="token keyword">and</span> include_param<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;only_include_class_param and include_param can't be True at the same time&quot;</span><span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>func<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span>P<span class="token punctuation">,</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Callable<span class="token punctuation">[</span>P<span class="token punctuation">,</span> Coroutine<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> Any<span class="token punctuation">,</span> R_T<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            key_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> func<span class="token punctuation">.</span>__qualname__ <span class="token keyword">if</span> key <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> key

            <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
            <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">wrapper_func</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">:</span> P<span class="token punctuation">.</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">:</span> P<span class="token punctuation">.</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> R_T<span class="token punctuation">:</span>
                <span class="token keyword">if</span> include_param<span class="token punctuation">:</span>
                    real_key<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span>Any<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>key_name<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>kwargs<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> only_include_class_param <span class="token keyword">and</span> args <span class="token keyword">and</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__ <span class="token keyword">in</span> func<span class="token punctuation">.</span>__qualname__<span class="token punctuation">:</span>
                        real_key <span class="token operator">=</span> <span class="token punctuation">(</span>key_name <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f&quot;:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">id</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        real_key <span class="token operator">=</span> <span class="token punctuation">(</span>key_name<span class="token punctuation">,</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>_do_handle<span class="token punctuation">(</span>real_key<span class="token punctuation">,</span> func<span class="token punctuation">,</span> args<span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>

            <span class="token keyword">return</span> wrapper_func

        <span class="token keyword">return</span> wrapper

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_token_dict<span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/Python编程核心/并发编程/Thread-多线程/线程间通信.html" class="prev">
        线程间通信
      </a></span> <span class="next"><a href="/Python/Python编程核心/并发编程/asyncio-协程/mini协程库.html">
        mini协程库
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d3c0dc77.js" defer></script><script src="/assets/js/2.5fbe0391.js" defer></script><script src="/assets/js/1.dc7adba2.js" defer></script><script src="/assets/js/247.19eaf435.js" defer></script>
  </body>
</html>
