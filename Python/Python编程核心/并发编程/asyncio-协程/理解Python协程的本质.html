<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>理解Python协程的本质 | 思源笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link href="/images/logo.png" rel="icon">
    <meta name="description" content="来自思源笔记的内容">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.d3c0dc77.js" as="script"><link rel="preload" href="/assets/js/2.5fbe0391.js" as="script"><link rel="preload" href="/assets/js/1.dc7adba2.js" as="script"><link rel="preload" href="/assets/js/251.758471d1.js" as="script"><link rel="prefetch" href="/assets/js/10.a9ace829.js"><link rel="prefetch" href="/assets/js/100.1ffa901d.js"><link rel="prefetch" href="/assets/js/101.37fdabbb.js"><link rel="prefetch" href="/assets/js/102.9c0f99bd.js"><link rel="prefetch" href="/assets/js/103.571daa23.js"><link rel="prefetch" href="/assets/js/104.88901889.js"><link rel="prefetch" href="/assets/js/105.e1c7fc4a.js"><link rel="prefetch" href="/assets/js/106.366c43d3.js"><link rel="prefetch" href="/assets/js/107.077c5081.js"><link rel="prefetch" href="/assets/js/108.c7d4e1fb.js"><link rel="prefetch" href="/assets/js/109.e7b7cb8f.js"><link rel="prefetch" href="/assets/js/11.32adc493.js"><link rel="prefetch" href="/assets/js/110.86cb08fa.js"><link rel="prefetch" href="/assets/js/111.b725586a.js"><link rel="prefetch" href="/assets/js/112.9f3b9f75.js"><link rel="prefetch" href="/assets/js/113.4a5023eb.js"><link rel="prefetch" href="/assets/js/114.6556c4e7.js"><link rel="prefetch" href="/assets/js/115.72cdb14c.js"><link rel="prefetch" href="/assets/js/116.6d5b51c2.js"><link rel="prefetch" href="/assets/js/117.65ec9b76.js"><link rel="prefetch" href="/assets/js/118.7f4861c9.js"><link rel="prefetch" href="/assets/js/119.650ac25d.js"><link rel="prefetch" href="/assets/js/12.92b47e85.js"><link rel="prefetch" href="/assets/js/120.8e7250e1.js"><link rel="prefetch" href="/assets/js/121.c5a06028.js"><link rel="prefetch" href="/assets/js/122.29f4e7bd.js"><link rel="prefetch" href="/assets/js/123.5e449baf.js"><link rel="prefetch" href="/assets/js/124.a44b0134.js"><link rel="prefetch" href="/assets/js/125.df3fe3e7.js"><link rel="prefetch" href="/assets/js/126.6974e54f.js"><link rel="prefetch" href="/assets/js/127.f2454306.js"><link rel="prefetch" href="/assets/js/128.b900fa7e.js"><link rel="prefetch" href="/assets/js/129.15864c0a.js"><link rel="prefetch" href="/assets/js/13.ebfb1f42.js"><link rel="prefetch" href="/assets/js/130.cc6853ea.js"><link rel="prefetch" href="/assets/js/131.5bb214da.js"><link rel="prefetch" href="/assets/js/132.1a83e445.js"><link rel="prefetch" href="/assets/js/133.da4547b9.js"><link rel="prefetch" href="/assets/js/134.0aeb00a9.js"><link rel="prefetch" href="/assets/js/135.16eb5d31.js"><link rel="prefetch" href="/assets/js/136.67396e70.js"><link rel="prefetch" href="/assets/js/137.afeb5d96.js"><link rel="prefetch" href="/assets/js/138.36e805ef.js"><link rel="prefetch" href="/assets/js/139.7d8c0405.js"><link rel="prefetch" href="/assets/js/14.3e65117c.js"><link rel="prefetch" href="/assets/js/140.6df70824.js"><link rel="prefetch" href="/assets/js/141.f642dacf.js"><link rel="prefetch" href="/assets/js/142.10230571.js"><link rel="prefetch" href="/assets/js/143.d599ee24.js"><link rel="prefetch" href="/assets/js/144.e1a88c20.js"><link rel="prefetch" href="/assets/js/145.eb357101.js"><link rel="prefetch" href="/assets/js/146.b3fe7f16.js"><link rel="prefetch" href="/assets/js/147.dbfb2f7d.js"><link rel="prefetch" href="/assets/js/148.8ed5bf1d.js"><link rel="prefetch" href="/assets/js/149.2c73c82d.js"><link rel="prefetch" href="/assets/js/15.5304afab.js"><link rel="prefetch" href="/assets/js/150.78115158.js"><link rel="prefetch" href="/assets/js/151.22badb82.js"><link rel="prefetch" href="/assets/js/152.a99d0f22.js"><link rel="prefetch" href="/assets/js/153.6a863a43.js"><link rel="prefetch" href="/assets/js/154.c6a0b3dc.js"><link rel="prefetch" href="/assets/js/155.b8591455.js"><link rel="prefetch" href="/assets/js/156.dd9eeca0.js"><link rel="prefetch" href="/assets/js/157.48909220.js"><link rel="prefetch" href="/assets/js/158.99fac6bc.js"><link rel="prefetch" href="/assets/js/159.3bcae7d0.js"><link rel="prefetch" href="/assets/js/16.9ca9aae8.js"><link rel="prefetch" href="/assets/js/160.7c8a9be5.js"><link rel="prefetch" href="/assets/js/161.30bee0bb.js"><link rel="prefetch" href="/assets/js/162.0dde5818.js"><link rel="prefetch" href="/assets/js/163.d4de9cde.js"><link rel="prefetch" href="/assets/js/164.1aa26354.js"><link rel="prefetch" href="/assets/js/165.67d8c450.js"><link rel="prefetch" href="/assets/js/166.81d14b26.js"><link rel="prefetch" href="/assets/js/167.ae715f9a.js"><link rel="prefetch" href="/assets/js/168.f2998afb.js"><link rel="prefetch" href="/assets/js/169.fd39ee46.js"><link rel="prefetch" href="/assets/js/17.3dbcb51f.js"><link rel="prefetch" href="/assets/js/170.147fd31a.js"><link rel="prefetch" href="/assets/js/171.35f8ce60.js"><link rel="prefetch" href="/assets/js/172.10db3085.js"><link rel="prefetch" href="/assets/js/173.11a8ff33.js"><link rel="prefetch" href="/assets/js/174.e196a1f6.js"><link rel="prefetch" href="/assets/js/175.0157f18d.js"><link rel="prefetch" href="/assets/js/176.6d3d456c.js"><link rel="prefetch" href="/assets/js/177.9c40b853.js"><link rel="prefetch" href="/assets/js/178.8dd00920.js"><link rel="prefetch" href="/assets/js/179.f7f4c661.js"><link rel="prefetch" href="/assets/js/18.4c170722.js"><link rel="prefetch" href="/assets/js/180.d02b4575.js"><link rel="prefetch" href="/assets/js/181.be3c0f7a.js"><link rel="prefetch" href="/assets/js/182.ae4673f8.js"><link rel="prefetch" href="/assets/js/183.ed56a865.js"><link rel="prefetch" href="/assets/js/184.43db12b1.js"><link rel="prefetch" href="/assets/js/185.3a09c20e.js"><link rel="prefetch" href="/assets/js/186.77240fee.js"><link rel="prefetch" href="/assets/js/187.c544cb6a.js"><link rel="prefetch" href="/assets/js/188.682782b1.js"><link rel="prefetch" href="/assets/js/189.1e81f7d7.js"><link rel="prefetch" href="/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/assets/js/190.c60243cc.js"><link rel="prefetch" href="/assets/js/191.841c59cf.js"><link rel="prefetch" href="/assets/js/192.6b3c14f5.js"><link rel="prefetch" href="/assets/js/193.47319c1f.js"><link rel="prefetch" href="/assets/js/194.95c798e0.js"><link rel="prefetch" href="/assets/js/195.258b0234.js"><link rel="prefetch" href="/assets/js/196.c5e95bf4.js"><link rel="prefetch" href="/assets/js/197.0a40131d.js"><link rel="prefetch" href="/assets/js/198.6ae77026.js"><link rel="prefetch" href="/assets/js/199.be929f6f.js"><link rel="prefetch" href="/assets/js/20.0d880388.js"><link rel="prefetch" href="/assets/js/200.6fdb4cde.js"><link rel="prefetch" href="/assets/js/201.2db1075b.js"><link rel="prefetch" href="/assets/js/202.6989c482.js"><link rel="prefetch" href="/assets/js/203.fed5be3d.js"><link rel="prefetch" href="/assets/js/204.2e2bd97a.js"><link rel="prefetch" href="/assets/js/205.919ad25d.js"><link rel="prefetch" href="/assets/js/206.caf46f82.js"><link rel="prefetch" href="/assets/js/207.b2786542.js"><link rel="prefetch" href="/assets/js/208.3ff31c7c.js"><link rel="prefetch" href="/assets/js/209.1ff1e0ba.js"><link rel="prefetch" href="/assets/js/21.0ad1d6a3.js"><link rel="prefetch" href="/assets/js/210.5673535d.js"><link rel="prefetch" href="/assets/js/211.07da8ae4.js"><link rel="prefetch" href="/assets/js/212.9a0d098d.js"><link rel="prefetch" href="/assets/js/213.289228c1.js"><link rel="prefetch" href="/assets/js/214.a9e3f658.js"><link rel="prefetch" href="/assets/js/215.2c849138.js"><link rel="prefetch" href="/assets/js/216.0b799039.js"><link rel="prefetch" href="/assets/js/217.248fa9ab.js"><link rel="prefetch" href="/assets/js/218.77bc5089.js"><link rel="prefetch" href="/assets/js/219.d0bcdf70.js"><link rel="prefetch" href="/assets/js/22.288b4852.js"><link rel="prefetch" href="/assets/js/220.abb5d7d1.js"><link rel="prefetch" href="/assets/js/221.39a29724.js"><link rel="prefetch" href="/assets/js/222.c8f848c5.js"><link rel="prefetch" href="/assets/js/223.3ea7fe96.js"><link rel="prefetch" href="/assets/js/224.afb1f423.js"><link rel="prefetch" href="/assets/js/225.cdd67273.js"><link rel="prefetch" href="/assets/js/226.89d69b6c.js"><link rel="prefetch" href="/assets/js/227.f5305f39.js"><link rel="prefetch" href="/assets/js/228.3276d530.js"><link rel="prefetch" href="/assets/js/229.ca4a013c.js"><link rel="prefetch" href="/assets/js/23.730038ee.js"><link rel="prefetch" href="/assets/js/230.19be1bec.js"><link rel="prefetch" href="/assets/js/231.940832b4.js"><link rel="prefetch" href="/assets/js/232.18dbe9c8.js"><link rel="prefetch" href="/assets/js/233.03187181.js"><link rel="prefetch" href="/assets/js/234.ed91cd88.js"><link rel="prefetch" href="/assets/js/235.277f96ac.js"><link rel="prefetch" href="/assets/js/236.8dee6d1a.js"><link rel="prefetch" href="/assets/js/237.6feb0534.js"><link rel="prefetch" href="/assets/js/238.57e64c14.js"><link rel="prefetch" href="/assets/js/239.8aeba238.js"><link rel="prefetch" href="/assets/js/24.933fffa9.js"><link rel="prefetch" href="/assets/js/240.864cffac.js"><link rel="prefetch" href="/assets/js/241.a1c6f45e.js"><link rel="prefetch" href="/assets/js/242.14475f90.js"><link rel="prefetch" href="/assets/js/243.fc4f7920.js"><link rel="prefetch" href="/assets/js/244.89f0d9fc.js"><link rel="prefetch" href="/assets/js/245.4836bb38.js"><link rel="prefetch" href="/assets/js/246.c3e0d73b.js"><link rel="prefetch" href="/assets/js/247.19eaf435.js"><link rel="prefetch" href="/assets/js/248.681c16e7.js"><link rel="prefetch" href="/assets/js/249.91c7786c.js"><link rel="prefetch" href="/assets/js/25.5a3957e2.js"><link rel="prefetch" href="/assets/js/250.999d9d17.js"><link rel="prefetch" href="/assets/js/252.69b6befe.js"><link rel="prefetch" href="/assets/js/253.dd46a3dd.js"><link rel="prefetch" href="/assets/js/254.be5da0c1.js"><link rel="prefetch" href="/assets/js/255.d817ce68.js"><link rel="prefetch" href="/assets/js/256.2c7be7d4.js"><link rel="prefetch" href="/assets/js/257.a6b2fbe0.js"><link rel="prefetch" href="/assets/js/258.a5554c78.js"><link rel="prefetch" href="/assets/js/259.5a99fba0.js"><link rel="prefetch" href="/assets/js/26.fe1a83b5.js"><link rel="prefetch" href="/assets/js/260.41f4e520.js"><link rel="prefetch" href="/assets/js/261.0f73b7e7.js"><link rel="prefetch" href="/assets/js/262.28fa19f9.js"><link rel="prefetch" href="/assets/js/263.4bfbecf4.js"><link rel="prefetch" href="/assets/js/264.e0c89f62.js"><link rel="prefetch" href="/assets/js/265.e9e1d674.js"><link rel="prefetch" href="/assets/js/266.a63b71fb.js"><link rel="prefetch" href="/assets/js/267.420cd7e6.js"><link rel="prefetch" href="/assets/js/268.51e0f667.js"><link rel="prefetch" href="/assets/js/269.3f0d4774.js"><link rel="prefetch" href="/assets/js/27.916eabeb.js"><link rel="prefetch" href="/assets/js/270.c644f9d3.js"><link rel="prefetch" href="/assets/js/271.35387f6e.js"><link rel="prefetch" href="/assets/js/272.a776fe07.js"><link rel="prefetch" href="/assets/js/273.6e463c6b.js"><link rel="prefetch" href="/assets/js/274.8ef8b8e6.js"><link rel="prefetch" href="/assets/js/275.aa2e316d.js"><link rel="prefetch" href="/assets/js/276.9d603319.js"><link rel="prefetch" href="/assets/js/277.d428f5d6.js"><link rel="prefetch" href="/assets/js/278.f702bcfc.js"><link rel="prefetch" href="/assets/js/279.e1449e30.js"><link rel="prefetch" href="/assets/js/28.1116b232.js"><link rel="prefetch" href="/assets/js/280.7601eaee.js"><link rel="prefetch" href="/assets/js/281.84cdb64a.js"><link rel="prefetch" href="/assets/js/282.a6f561ff.js"><link rel="prefetch" href="/assets/js/283.c55742fa.js"><link rel="prefetch" href="/assets/js/284.924e0d7d.js"><link rel="prefetch" href="/assets/js/285.a997b1fb.js"><link rel="prefetch" href="/assets/js/286.cdb934a7.js"><link rel="prefetch" href="/assets/js/287.6f03d7f1.js"><link rel="prefetch" href="/assets/js/288.79e9f811.js"><link rel="prefetch" href="/assets/js/289.4861ef8b.js"><link rel="prefetch" href="/assets/js/29.6bff2814.js"><link rel="prefetch" href="/assets/js/290.e5a58a2f.js"><link rel="prefetch" href="/assets/js/291.9fee54ed.js"><link rel="prefetch" href="/assets/js/292.f8550342.js"><link rel="prefetch" href="/assets/js/293.5f22eb00.js"><link rel="prefetch" href="/assets/js/294.0a21c523.js"><link rel="prefetch" href="/assets/js/295.278a632b.js"><link rel="prefetch" href="/assets/js/296.ffc317e3.js"><link rel="prefetch" href="/assets/js/297.239cab1c.js"><link rel="prefetch" href="/assets/js/298.9f79e196.js"><link rel="prefetch" href="/assets/js/299.5f334485.js"><link rel="prefetch" href="/assets/js/3.bc6bba9e.js"><link rel="prefetch" href="/assets/js/30.218767d4.js"><link rel="prefetch" href="/assets/js/300.0ba14677.js"><link rel="prefetch" href="/assets/js/301.e8f27c97.js"><link rel="prefetch" href="/assets/js/302.c122edfe.js"><link rel="prefetch" href="/assets/js/303.da637783.js"><link rel="prefetch" href="/assets/js/304.4ec1b29e.js"><link rel="prefetch" href="/assets/js/305.3c00ea1f.js"><link rel="prefetch" href="/assets/js/306.b20e9815.js"><link rel="prefetch" href="/assets/js/307.6b91424e.js"><link rel="prefetch" href="/assets/js/308.dc89c12c.js"><link rel="prefetch" href="/assets/js/309.cc9c859e.js"><link rel="prefetch" href="/assets/js/31.2759a7a8.js"><link rel="prefetch" href="/assets/js/310.a9d45b6b.js"><link rel="prefetch" href="/assets/js/311.2054a97f.js"><link rel="prefetch" href="/assets/js/312.4bbc87ce.js"><link rel="prefetch" href="/assets/js/313.6bfffef1.js"><link rel="prefetch" href="/assets/js/314.80c7873d.js"><link rel="prefetch" href="/assets/js/315.e2b4b0eb.js"><link rel="prefetch" href="/assets/js/316.3e4bf82f.js"><link rel="prefetch" href="/assets/js/317.67d43206.js"><link rel="prefetch" href="/assets/js/318.29c1cdea.js"><link rel="prefetch" href="/assets/js/319.902203c8.js"><link rel="prefetch" href="/assets/js/32.49c74da8.js"><link rel="prefetch" href="/assets/js/320.9f322f6c.js"><link rel="prefetch" href="/assets/js/321.9ec16835.js"><link rel="prefetch" href="/assets/js/322.3afb0458.js"><link rel="prefetch" href="/assets/js/323.7c17fa0a.js"><link rel="prefetch" href="/assets/js/324.99ba59d2.js"><link rel="prefetch" href="/assets/js/325.6317221b.js"><link rel="prefetch" href="/assets/js/326.05691f3e.js"><link rel="prefetch" href="/assets/js/327.57a0752b.js"><link rel="prefetch" href="/assets/js/328.bd689f6c.js"><link rel="prefetch" href="/assets/js/329.9d95b288.js"><link rel="prefetch" href="/assets/js/33.da97d900.js"><link rel="prefetch" href="/assets/js/330.3f1aabde.js"><link rel="prefetch" href="/assets/js/331.4d2b6bf2.js"><link rel="prefetch" href="/assets/js/332.3d04f06d.js"><link rel="prefetch" href="/assets/js/333.f76ff221.js"><link rel="prefetch" href="/assets/js/334.cd2fc1ea.js"><link rel="prefetch" href="/assets/js/335.03d03979.js"><link rel="prefetch" href="/assets/js/336.4190f1ee.js"><link rel="prefetch" href="/assets/js/337.fdb48b71.js"><link rel="prefetch" href="/assets/js/338.7db8c869.js"><link rel="prefetch" href="/assets/js/339.90cdb7f0.js"><link rel="prefetch" href="/assets/js/34.42f8b6ab.js"><link rel="prefetch" href="/assets/js/340.4ba3bbd5.js"><link rel="prefetch" href="/assets/js/341.697b02a9.js"><link rel="prefetch" href="/assets/js/342.4af3bc4a.js"><link rel="prefetch" href="/assets/js/343.ba3f5e26.js"><link rel="prefetch" href="/assets/js/344.a3cf4ad3.js"><link rel="prefetch" href="/assets/js/345.d00eb266.js"><link rel="prefetch" href="/assets/js/346.74f1e6d3.js"><link rel="prefetch" href="/assets/js/347.cc3995b9.js"><link rel="prefetch" href="/assets/js/348.37774278.js"><link rel="prefetch" href="/assets/js/349.94d05b9c.js"><link rel="prefetch" href="/assets/js/35.42c35a21.js"><link rel="prefetch" href="/assets/js/350.47f1df55.js"><link rel="prefetch" href="/assets/js/351.1627936d.js"><link rel="prefetch" href="/assets/js/352.277ab034.js"><link rel="prefetch" href="/assets/js/353.c11e8bb5.js"><link rel="prefetch" href="/assets/js/354.ba01078c.js"><link rel="prefetch" href="/assets/js/355.70321476.js"><link rel="prefetch" href="/assets/js/356.94f404af.js"><link rel="prefetch" href="/assets/js/357.ec546a74.js"><link rel="prefetch" href="/assets/js/358.d72741b2.js"><link rel="prefetch" href="/assets/js/359.31c31ceb.js"><link rel="prefetch" href="/assets/js/36.c3767d58.js"><link rel="prefetch" href="/assets/js/360.a654dc23.js"><link rel="prefetch" href="/assets/js/361.46441143.js"><link rel="prefetch" href="/assets/js/362.0aa22356.js"><link rel="prefetch" href="/assets/js/363.355f7781.js"><link rel="prefetch" href="/assets/js/364.7e5168cd.js"><link rel="prefetch" href="/assets/js/365.b5f9bbf4.js"><link rel="prefetch" href="/assets/js/366.35422147.js"><link rel="prefetch" href="/assets/js/367.17af4dd9.js"><link rel="prefetch" href="/assets/js/368.99c04015.js"><link rel="prefetch" href="/assets/js/369.6e269202.js"><link rel="prefetch" href="/assets/js/37.b8f739e7.js"><link rel="prefetch" href="/assets/js/370.4c9fc0f9.js"><link rel="prefetch" href="/assets/js/371.fe9ddc42.js"><link rel="prefetch" href="/assets/js/372.a1a19937.js"><link rel="prefetch" href="/assets/js/373.8244356e.js"><link rel="prefetch" href="/assets/js/374.046bb182.js"><link rel="prefetch" href="/assets/js/375.95079f01.js"><link rel="prefetch" href="/assets/js/376.cb4cbf85.js"><link rel="prefetch" href="/assets/js/377.7f9dcc45.js"><link rel="prefetch" href="/assets/js/378.8396aba6.js"><link rel="prefetch" href="/assets/js/379.78f55713.js"><link rel="prefetch" href="/assets/js/38.cfd18851.js"><link rel="prefetch" href="/assets/js/380.9df95a65.js"><link rel="prefetch" href="/assets/js/381.db02d710.js"><link rel="prefetch" href="/assets/js/382.f5f01bd1.js"><link rel="prefetch" href="/assets/js/383.551a9e39.js"><link rel="prefetch" href="/assets/js/384.521cbf24.js"><link rel="prefetch" href="/assets/js/385.ce4ea212.js"><link rel="prefetch" href="/assets/js/386.3f4d7458.js"><link rel="prefetch" href="/assets/js/387.70a5c9bc.js"><link rel="prefetch" href="/assets/js/388.6d8e6a12.js"><link rel="prefetch" href="/assets/js/389.0088e683.js"><link rel="prefetch" href="/assets/js/39.af3d4c88.js"><link rel="prefetch" href="/assets/js/390.ac189a90.js"><link rel="prefetch" href="/assets/js/391.77894ec3.js"><link rel="prefetch" href="/assets/js/392.94725ec9.js"><link rel="prefetch" href="/assets/js/393.0d91a9e5.js"><link rel="prefetch" href="/assets/js/394.035a8e79.js"><link rel="prefetch" href="/assets/js/395.6dfbee1b.js"><link rel="prefetch" href="/assets/js/396.beb18051.js"><link rel="prefetch" href="/assets/js/397.5326e3a9.js"><link rel="prefetch" href="/assets/js/398.02a3983e.js"><link rel="prefetch" href="/assets/js/399.59d68b2b.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.feab1c20.js"><link rel="prefetch" href="/assets/js/400.f8253cec.js"><link rel="prefetch" href="/assets/js/401.fe8992b6.js"><link rel="prefetch" href="/assets/js/402.c0f7e134.js"><link rel="prefetch" href="/assets/js/403.48996262.js"><link rel="prefetch" href="/assets/js/41.e39d4dc8.js"><link rel="prefetch" href="/assets/js/42.61fe8caf.js"><link rel="prefetch" href="/assets/js/43.a9b01c27.js"><link rel="prefetch" href="/assets/js/44.d0b30ba2.js"><link rel="prefetch" href="/assets/js/45.c503c388.js"><link rel="prefetch" href="/assets/js/46.7206f25e.js"><link rel="prefetch" href="/assets/js/47.f3038db2.js"><link rel="prefetch" href="/assets/js/48.5cb39349.js"><link rel="prefetch" href="/assets/js/49.f05e5dfa.js"><link rel="prefetch" href="/assets/js/5.7098d77a.js"><link rel="prefetch" href="/assets/js/50.f4051900.js"><link rel="prefetch" href="/assets/js/51.140718cc.js"><link rel="prefetch" href="/assets/js/52.df8cb15f.js"><link rel="prefetch" href="/assets/js/53.9322d2fd.js"><link rel="prefetch" href="/assets/js/54.083c2849.js"><link rel="prefetch" href="/assets/js/55.0db6b109.js"><link rel="prefetch" href="/assets/js/56.e36d9f94.js"><link rel="prefetch" href="/assets/js/57.aadb73ac.js"><link rel="prefetch" href="/assets/js/58.e0181ca8.js"><link rel="prefetch" href="/assets/js/59.71fa8395.js"><link rel="prefetch" href="/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/assets/js/60.ccbd5c67.js"><link rel="prefetch" href="/assets/js/61.b29ac4b8.js"><link rel="prefetch" href="/assets/js/62.2c041d9f.js"><link rel="prefetch" href="/assets/js/63.02e68290.js"><link rel="prefetch" href="/assets/js/64.52025364.js"><link rel="prefetch" href="/assets/js/65.821d4920.js"><link rel="prefetch" href="/assets/js/66.b01a2e1f.js"><link rel="prefetch" href="/assets/js/67.49786e78.js"><link rel="prefetch" href="/assets/js/68.c6418f35.js"><link rel="prefetch" href="/assets/js/69.7bd0a0e3.js"><link rel="prefetch" href="/assets/js/7.6a854e57.js"><link rel="prefetch" href="/assets/js/70.6bacad63.js"><link rel="prefetch" href="/assets/js/71.2d2f55cb.js"><link rel="prefetch" href="/assets/js/72.385a2106.js"><link rel="prefetch" href="/assets/js/73.3567215b.js"><link rel="prefetch" href="/assets/js/74.66d5e54d.js"><link rel="prefetch" href="/assets/js/75.e9939676.js"><link rel="prefetch" href="/assets/js/76.ef329155.js"><link rel="prefetch" href="/assets/js/77.704b996e.js"><link rel="prefetch" href="/assets/js/78.6a6ccbbc.js"><link rel="prefetch" href="/assets/js/79.a908ba71.js"><link rel="prefetch" href="/assets/js/80.a6cc65ef.js"><link rel="prefetch" href="/assets/js/81.55fd7628.js"><link rel="prefetch" href="/assets/js/82.9fd118ce.js"><link rel="prefetch" href="/assets/js/83.25043008.js"><link rel="prefetch" href="/assets/js/84.ec86d293.js"><link rel="prefetch" href="/assets/js/85.b4faa1bb.js"><link rel="prefetch" href="/assets/js/86.beade549.js"><link rel="prefetch" href="/assets/js/87.c816be2a.js"><link rel="prefetch" href="/assets/js/88.453dd1c1.js"><link rel="prefetch" href="/assets/js/89.eae28977.js"><link rel="prefetch" href="/assets/js/90.05307532.js"><link rel="prefetch" href="/assets/js/91.fd8bd853.js"><link rel="prefetch" href="/assets/js/92.14aed080.js"><link rel="prefetch" href="/assets/js/93.f1b00b72.js"><link rel="prefetch" href="/assets/js/94.debf50a7.js"><link rel="prefetch" href="/assets/js/95.f9a158ae.js"><link rel="prefetch" href="/assets/js/96.2833401e.js"><link rel="prefetch" href="/assets/js/97.957e0ee5.js"><link rel="prefetch" href="/assets/js/98.9c305f09.js"><link rel="prefetch" href="/assets/js/99.c8981936.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="思源笔记" class="logo"> <span class="site-name can-hide">思源笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/Python/" class="sidebar-heading clickable router-link-active open"><span>Python</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/CPython源码剖析/" class="sidebar-heading clickable"><span>CPython源码剖析</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python常用模块/" class="sidebar-heading clickable"><span>Python常用模块</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python常见问题.html" class="sidebar-link">Python常见问题</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python编程核心/" class="sidebar-heading clickable open"><span>Python编程核心</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/内存管理、垃圾回收/" class="sidebar-heading clickable"><span>内存管理、垃圾回收</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/函数/" class="sidebar-heading clickable"><span>函数</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/多语言混合开发/" class="sidebar-heading clickable"><span>多语言混合开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/并发编程/" class="sidebar-heading clickable open"><span>并发编程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/Process-多进程/" class="sidebar-heading clickable"><span>Process-多进程</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python编程核心/并发编程/Python GIL - CPython.html" class="sidebar-link">Python GIL - CPython</a></li><li><a href="/Python/Python编程核心/并发编程/Python并发编程概述.html" class="sidebar-link">Python并发编程概述</a></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/Thread-多线程/" class="sidebar-heading clickable"><span>Thread-多线程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/asyncio-协程/" class="sidebar-heading clickable open"><span>asyncio-协程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/Share对象防止缓存击穿-Python Asyncio实践.html" class="sidebar-link">Share对象防止缓存击穿-Python Asyncio实践</a></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/mini协程库.html" class="sidebar-link">mini协程库</a></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/从生成器看协程本质.html" class="sidebar-link">从生成器看协程本质</a></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/协程-Asyncio、Gevent.html" class="sidebar-link">协程-Asyncio、Gevent</a></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html" class="active sidebar-link">理解Python协程的本质</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html#_0x00-开始之前" class="sidebar-link">0x00 开始之前</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html#_0x01-io-多路复用" class="sidebar-link">0x01 IO 多路复用</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html#_0x02-用生成器消除-callback" class="sidebar-link">0x02 用生成器消除 callback</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html#_0x03-解决完整调用链" class="sidebar-link">0x03 解决完整调用链</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html#_0x04-提高扩展性" class="sidebar-link">0x04 提高扩展性</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html#_0x05-发展和变革" class="sidebar-link">0x05 发展和变革</a></li><li class="sidebar-sub-header"><a href="/Python/Python编程核心/并发编程/asyncio-协程/理解Python协程的本质.html#_0x06-总结和比较" class="sidebar-link">0x06 总结和比较</a></li></ul></li><li><a href="/Python/Python编程核心/并发编程/asyncio-协程/迭代器到生成器.html" class="sidebar-link">迭代器到生成器</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/其他实现/" class="sidebar-heading clickable"><span>其他实现</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python编程核心/并发编程/并发编程性能对比.html" class="sidebar-link">并发编程性能对比</a></li><li><section class="sidebar-group collapsable is-sub-group depth-3"><a href="/Python/Python编程核心/并发编程/并发编程数据管理/" class="sidebar-heading clickable"><span>并发编程数据管理</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/杂/" class="sidebar-heading clickable"><span>杂</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/模块化、私有化/" class="sidebar-heading clickable"><span>模块化、私有化</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/测试加密打包部署/" class="sidebar-heading clickable"><span>测试加密打包部署</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/环境配置/" class="sidebar-heading clickable"><span>环境配置</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/语法基础/" class="sidebar-heading clickable"><span>语法基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/调试优化dump分析/" class="sidebar-heading clickable"><span>调试优化dump分析</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/面向对象/" class="sidebar-heading clickable"><span>面向对象</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/Python编程核心/鸭子类型/" class="sidebar-heading clickable"><span>鸭子类型</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="理解python协程的本质"><a href="#理解python协程的本质" class="header-anchor">#</a> 理解Python协程的本质</h1> <hr> <ul><li><a href="https://zhuanlan.zhihu.com/p/330549526" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/330549526 - 知乎专栏<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>这两天因为一点个人原因写了点好久没碰的python，其中涉及到协程编程，上次搞的时候，它还是web框架 tornado特有的feature，现在已经有async await 关键字支持了。思考了一下其实现，回顾了下这些年的演变，觉得还…</li> <li>2023-01-10 14:32:12</li></ul> <hr> <p>这两天因为一点个人原因写了点好久没碰的python，其中涉及到协程编程，上次搞的时候，它还是web框架<code>tornado</code>​特有的feature，现在已经有<code>asyncawait</code>​ 关键字支持了。思考了一下其实现，回顾了下这些年的演变，觉得还有点意思。</p> <blockquote><p>都是单线程，为什么原来低效率的代码用了<code>async await</code>​加一些异步库就变得效率高了？</p></blockquote> <p>如果你做基于python的网络或者web开发时，对于这个问题曾感到疑惑，这篇文章会给你答案。</p> <h2 id="_0x00-开始之前"><a href="#_0x00-开始之前" class="header-anchor">#</a> 0x00 开始之前</h2> <p>首先，本文​<strong>不是带你浏览源代码</strong>​，然后对照原始代码给你讲python标准的实现。相反，我们会从实际问题出发，思考解决问题的方案，一步步体会解决方案的演进路径，最重要的，希望能在过程中获得知识系统性提升。</p> <p><strong>⚠️ 本文仅是提供此了一个独立的思考方向，并未遵循历史和现有实际具体的实现细节。</strong></p> <p>其次，阅读这篇文章需要你对python比较熟悉，至少了解python中的生成器<code>generator</code>​的概念。</p> <h2 id="_0x01-io-多路复用"><a href="#_0x01-io-多路复用" class="header-anchor">#</a> 0x01 IO 多路复用</h2> <p>这是性能的关键。但我们这里只解释概念，其实现细节不是重点，这对我们理解python的协程已经足够了，如已足够了解，前进到<code>0x02</code>​。</p> <p>首先，你要知道所有的网络服务程序都是一个巨大的死循环，你的业务逻辑都在这个循环的某个时刻被调用：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 处理请求</span>
    <span class="token keyword">pass</span>

<span class="token comment"># 你的 handler 运行在 while 循环中</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取一个新请求</span>
    request <span class="token operator">=</span> accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 根据路由映射获取到用户写的业务逻辑函数</span>
    handler <span class="token operator">=</span> get_handler<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token comment"># 运行用户的handler，处理请求</span>
    handler<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
</code></pre></div><p>设想你的web服务的某个<code>handler</code>​，在接收到请求后需要一个api调用才能响应结果。对于最传统的网络应用，你的api请求发出去后在等待响应，此时程序停止运行，甚至新的请求也得在响应结束后才进得来。如果你依赖的API请求网络丢包严重，响应特别慢呢？那应用的吞吐量将非常低。</p> <p>很多传统web服务器使用多线程技术解决这个问题：把<code>handler</code>​的运行放到其他线程上，每个线程处理一个请求，本线程阻塞不影响新请求进入。这能一定程度上解决问题，但对于并发比较大的系统，过多线程调度会带来很大的性能开销。</p> <p>IO多路复用可以做到不使用线程解决问题，它是由操作系统内核提供的功能，可以说专门为这类场景而生。简单来讲，你的程序遇到网络IO时，告诉操作系统帮你盯着，同时操作系统提供给你一个方法，让你可以随时获取到有哪些io操作已经完成。就像这样：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 操作系统的IO复用示例伪代码</span>
io_register<span class="token punctuation">(</span>io_id<span class="token punctuation">,</span> io_type<span class="token punctuation">)</span>  <span class="token comment"># 向操作系统io注册自己关注的io操作的id和类型</span>
io_register<span class="token punctuation">(</span>io_id<span class="token punctuation">,</span> io_type<span class="token punctuation">)</span>
<span class="token comment"># 获取完成的io操作, 使用 epoll() in Linux and kqueue() in Unix</span>
events <span class="token operator">=</span> io_get_finished<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>io_id<span class="token punctuation">,</span> io_type<span class="token punctuation">)</span> <span class="token keyword">in</span> events<span class="token punctuation">:</span>
    <span class="token keyword">if</span> io_type <span class="token operator">==</span> READ<span class="token punctuation">:</span>
        data <span class="token operator">=</span> read_data<span class="token punctuation">(</span>io_id<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> io_type <span class="token operator">==</span> WRITE<span class="token punctuation">:</span>
        write_data<span class="token punctuation">(</span>io_id，data<span class="token punctuation">)</span>
</code></pre></div><p>把IO复用逻辑融合到我们的服务器中，大概会像这样：</p> <div class="language-python extra-class"><pre class="language-python"><code>call_backs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># do jobs here</span>
    io_register<span class="token punctuation">(</span>io_id<span class="token punctuation">,</span> io_type<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">call_back</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 使用返回的result完成剩余工作</span>
    call_backs<span class="token punctuation">[</span>io_id<span class="token punctuation">]</span> <span class="token operator">=</span> call_back

<span class="token comment"># 新的循环</span>
<span class="token keyword">while</span> <span class="token boolean">True</span>：
    <span class="token comment"># 获取已经完成的io事件</span>
    events <span class="token operator">=</span> io_get_finished<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>io_id<span class="token punctuation">,</span> io_type<span class="token punctuation">)</span> <span class="token keyword">in</span> events<span class="token punctuation">:</span>
        <span class="token keyword">if</span> io_type <span class="token operator">==</span> READ<span class="token punctuation">:</span> <span class="token comment"># 读取</span>
            data <span class="token operator">=</span> read<span class="token punctuation">(</span>io_id<span class="token punctuation">)</span>
            call_back <span class="token operator">=</span> call_backs<span class="token punctuation">[</span>io_id<span class="token punctuation">]</span>
            call_back<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 其他类型io事件的处理</span>
            <span class="token keyword">pass</span>

    <span class="token comment"># 获取一个新请求</span>
    request <span class="token operator">=</span> accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 根据路由映射获取到用户写的业务逻辑函数</span>
    handler <span class="token operator">=</span> get_handler<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token comment"># 运行用户的handler，处理请求</span>
    handler<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
</code></pre></div><p>我们的handler对于IO操作，注册了回调就立刻返回，同时每次迭代都会对已完成的IO执行回调，网络请求不再阻塞整个服务器。</p> <p>上面的伪代码仅便于理解，具体实现细节更复杂。而且就连接受新请求也是在从操作系统得到监听端口的IO事件后进行的。我们如果把循环部分还有<code>call_backs</code>​字典拆分到单独模块，就能得到一个<code>EventLoop</code>​，也就是python标准库 <code>asyncio</code>​包中提供的<code>ioloop</code>​</p> <h2 id="_0x02-用生成器消除-callback"><a href="#_0x02-用生成器消除-callback" class="header-anchor">#</a> 0x02 用生成器消除 callback</h2> <p>着重看下我们业务中经常写的handler函数，在有独立的ioloop后，它现在变成类似这样：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 业务逻辑代码</span>

    <span class="token comment"># 需要执行一次API请求</span>
    <span class="token keyword">def</span> <span class="token function">call_back</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用API返回的result完成剩余工作</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token comment"># 注册回调，没有io_call这个方法，仅示意，表示注册一个io操作</span>
    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>io_call<span class="token punctuation">(</span>api<span class="token punctuation">,</span> call_back<span class="token punctuation">)</span>
</code></pre></div><p>到这里，性能问题已经解决了：我们不再需要多线程就能源源不断接受新请求，而且不用care依赖的API响应有多慢。</p> <p>但是我们也引入了一个新问题，原来流畅的业务逻辑代码现在被拆成了两部分，请求API之前的代码还正常，请求API之后的代码只能写在回调函数里面了。这里我们业务逻辑只有一个API调用，如果有多个API，再加上对redis或者mysql的调用（它们本质也是网络请求），整个逻辑会被拆分的更散，这对业务开发是一笔负担。对于有匿名函数的一些语言（没错就是javascript），还可能会引发所谓的「回调地狱」。接下来我们想办法解决这个问题。</p> <blockquote><p>如果函数在运行到网络IO操作处后能够暂停，完成后又能在断点处唤醒就好了。</p></blockquote> <p>如果你对python的<strong>生成器</strong>熟悉，你应该会发现，它恰好具有这个功能：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    value <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> value

g <span class="token operator">=</span> example<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 使用send(None)启动生成器，我们应该会得到 2</span>
got <span class="token operator">=</span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>got<span class="token punctuation">)</span>  <span class="token comment"># 2</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment"># 再次启动 会显示 &quot;get 4&quot;, 就是我们传入的值</span>
    got <span class="token operator">=</span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span>got<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token comment"># 生成器运行完成，将会print(4)，e.value 是生成器return的值</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
</code></pre></div><p>函数中有<code>yield</code>​关键字，调用函数将会得到一个生成器，生成器一个关键的方法<code>send()</code>​可以跟生成器交互。<code>g.send(None)</code>​ 会运行生成器内代码直到遇到<code>yield</code>​，并返回其后的对象，也就是<code>2</code>​，生成器代码就停在这里了，直到我们再次执行<code>g.send(got*2)</code>​,会把<code>2*2</code>​也就是<code>4</code>​ 赋值给<code>yield</code>​前面的变量<code>value</code>​,然后继续运行生成器代码。 <strong>yield在这里就像一扇门，可以把一件东西从这里送出去，也可以把另一件东西拿进来。</strong></p> <p>如果<code>send</code>​让生成器运行到下一个<code>yield</code>​前就结束了，send调用会引发一个特殊的异常<code>StopIteration</code>​，这个异常自带一个属性<code>value</code>​，为生成器return的值。</p> <p>如果我们把我们的<code>handler</code>​用<code>yield</code>​关键字转换成一个生成器，运行它来把<strong>IO操作的具体内容</strong>返回，IO完成后的回调函数中把IO结果放回并恢复生成器运行，那就解决了业务代码不流畅的问题了：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 业务逻辑代码</span>

    <span class="token comment"># 需要执行一次API请求，直接把IO请求信息yield出去</span>
    result <span class="token operator">=</span> <span class="token keyword">yield</span> io_info
    <span class="token comment"># 使用API返回的result完成剩余工作</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

<span class="token comment"># 这个函数注册到ioloop中，用来当有新请求的时候回调</span>
<span class="token keyword">def</span> <span class="token function">on_request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据路由映射获取到用户写的业务逻辑函数</span>
    handler <span class="token operator">=</span> get_handler<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    g <span class="token operator">=</span> handler<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token comment"># 首次启动获得io_info</span>
    io_info <span class="token operator">=</span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token comment"># io完成回调函数</span>
    <span class="token keyword">def</span> <span class="token function">call_back</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>
        g<span class="token punctuation">.</span>send<span class="token punctuation">(</span>result<span class="token punctuation">)</span>  <span class="token comment"># 重新启动生成器</span>

    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>io_call<span class="token punctuation">(</span>io_info<span class="token punctuation">,</span> call_back<span class="token punctuation">)</span>
</code></pre></div><p>上面的例子，用户写的<code>handler</code>​代码已经不会被打散到callback 中，<code>on_request</code>​函数使用callback和<code>ioloop</code>​交互，但它会被实现在web框架中，对用户不可见。上面代码足以给我们提供用生成器消灭的callback的启发，但局限性有两点：</p> <ol><li>业务逻辑中仅发起一次网络IO，但实际中往往更多</li> <li>业务逻辑没有调用其他异步函数（协程），但实际中我们往往会调用其他协程</li></ol> <h2 id="_0x03-解决完整调用链"><a href="#_0x03-解决完整调用链" class="header-anchor">#</a> 0x03 解决完整调用链</h2> <p>我们来看一个更复杂的例子：</p> <p>函数调用链路图。</p> <p>其中<code>request</code>​ 执行真正的IO，<code>func1 func2</code>​ 仅调用。显然我们的代码只能写成这样：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> <span class="token keyword">yield</span> request<span class="token punctuation">(</span><span class="token string">&quot;http://test.com/foo&quot;</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> <span class="token keyword">yield</span> func2<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ret

<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token keyword">yield</span> request<span class="token punctuation">(</span><span class="token string">&quot;http://test.com/&quot;</span><span class="token operator">+</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result

<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 这里模拟返回一个io操作，包含io操作的所有信息，这里用URL简化</span>
    <span class="token comment"># &quot;iojob of %s&quot; % url 部分模拟注册IO操作到ioloop</span>
    result <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token string">&quot;iojob of %s&quot;</span> <span class="token operator">%</span> url
    <span class="token keyword">return</span> result
</code></pre></div><p>对于<code>request</code>​，我们把IO操作通过yield暴露给框架。​<strong>对于</strong>​**<code>func1</code><strong>​ ** 和 <strong>​</strong><code>func2</code><strong>​ <strong>，调用</strong>​</strong><code>request</code><strong>​</strong>显然也要加</strong>​**<code>yield</code><strong>​</strong>关键字**​，否则<code>request</code>​调用返回一个生成器后不会暂停，继续执行后续逻辑显然会出错。</p> <p>这基本就是我们在没有<code>yield from aysnc await</code>​时代，在tornado框架中写异步代码的样子。</p> <p>要运行整个调用栈，大概流程如下：</p> <ol><li>调用<code>func1()</code>​得到生成器</li> <li>调用<code>send(None)</code>​启动它得到会得到<code>request(&quot;http://test.com/foo&quot;)</code>​的结果，还是生成器对象</li> <li>​<code>send(None)</code>​启动由<code>request()</code>​产生的生成器，会得到IO操作，由框架注册到ioloop并指定回调</li> <li>IO完成后的回调函数内唤醒<code>request</code>​生成器，生成器会走到<code>return</code>​语句结束</li> <li>捕获异常得到<code>request</code>​生成器的返回值，将上一层<code>func1</code>​唤醒，同时又得到<code>func2()</code>​生成器</li> <li>... 继续执行</li></ol> <p>对算法和数据结构熟悉的朋友遇到这种前进后退的遍历逻辑，可以递归也可以用栈，因为递归使用生成器还做不到，我们可以使用栈，其实这就是「调用栈」一词的由来。</p> <p>​<img src="assets/v2-25ac28c9f9be1247a3b2b401447f0964_b-20230110143212-m13u26r.jpg" alt="">​</p> <p>调用栈示意</p> <p>借助栈，我们可以​<strong>把整个调用链上串联的所有生成器对表现为一个生成器</strong>​，对其不断send就能不断得到所有io操作信息并推动调用链前进，实现方法如下：</p> <ol><li>第一个生成器入栈</li> <li>调用<code>send</code>​，如果得到生成器就入栈并进入下一轮迭代</li> <li>遇到到IO请求<code>yield</code>​出来，让框架注册到ioloop</li> <li>IO操作完成后被唤醒，缓存结果并出栈，进入下一轮迭代，目的让上层函数使用IO结果恢复运行</li> <li>如果一个生成器运行完毕，也需要和4一样让上层函数恢复运行</li></ol> <p>如果实现出来，代码不长但信息量比较大。他把整个调用链对外变成一个生成器，对其调用send，就能整个调用链中的IO，完成这些IO，继续推动调用链内的逻辑执行，直到整体逻辑结束：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 第一层调用 入栈</span>
    stack <span class="token operator">=</span> Stack<span class="token punctuation">(</span><span class="token punctuation">)</span>
    stack<span class="token punctuation">.</span>push<span class="token punctuation">(</span>gen<span class="token punctuation">)</span>

    <span class="token comment"># 开始逐层调用</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取栈顶元素</span>
        item <span class="token operator">=</span> stack<span class="token punctuation">.</span>peak<span class="token punctuation">(</span><span class="token punctuation">)</span>

        result <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> isgenerator<span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 生成器，</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token comment"># 尝试获取下个生成器调用，并入栈</span>
                <span class="token comment"># result 初始为None，之后迭代中将为下层调用的返回值</span>
                child <span class="token operator">=</span> item<span class="token punctuation">.</span>send<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                result <span class="token operator">=</span> <span class="token boolean">None</span>
                stack<span class="token punctuation">.</span>push<span class="token punctuation">(</span>child<span class="token punctuation">)</span>
                <span class="token comment"># 入栈后直接进入下次循环，继续深入调用链</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token comment"># 如果自己运行结束了，就暂存result，下一步让自己出栈</span>
                result <span class="token operator">=</span> e<span class="token punctuation">.</span>value
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># io 操作</span>
            <span class="token comment"># 遇到了io操作，yield出去</span>
            <span class="token comment"># IO完成后会被用IO结果唤醒并暂存到result</span>
            result <span class="token operator">=</span> <span class="token keyword">yield</span> item

        <span class="token comment"># 走到这里则本层已经执行完毕，出栈，下次迭代将回到调用链上一层</span>
        stack<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 没有上一层的话，那整个调用链都执行完成了，return</span>
        <span class="token keyword">if</span> stack<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;finished&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> result
</code></pre></div><p>这可能是最复杂的部分，如果一下难以接受可以略过，对于本文理解无碍。只需要知道对于上面示例中的调用链，存在上面这种方法产生如下效果：</p> <div class="language-python extra-class"><pre class="language-python"><code>w <span class="token operator">=</span> wrapper<span class="token punctuation">(</span>func1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 启动 wrpper, 将会得到 &quot;iojob of http://test.com/foo&quot;</span>
w<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token comment"># 上个iojob foo 完成后的结果&quot;bar&quot;传入，继续运行，得到  &quot;iojob of http://test.com/bar&quot;</span>
w<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span>
<span class="token comment"># 上个iojob bar 完成后的结构&quot;barz&quot;传入，继续运行，结束。</span>
w<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;barz&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>有了这部分以后，框架只需要再加上配套的代码：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 维护一个就绪列表，存放所有完成的IO事件，格式为（wrapper，result）</span>
ready <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">on_request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    handler <span class="token operator">=</span> get_handler<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token comment"># 使用 wrapper 包装后，可以只通过send处理IO了</span>
    g <span class="token operator">=</span> wrapper<span class="token punctuation">(</span>func1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 把开始状态直接视为结果为None的就绪状态</span>
    ready<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 让ioloop每轮循环都执行此函数，用来处理的就绪的IO，</span>
<span class="token keyword">def</span> <span class="token function">process_ready</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">call_back</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ready<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 遍历所有已经就绪生成器，将其向下推进</span>
    <span class="token keyword">for</span> g<span class="token punctuation">,</span> result <span class="token keyword">in</span> self<span class="token punctuation">.</span>ready<span class="token punctuation">:</span>
        <span class="token comment"># 用result唤醒生成器，并得到下一个io操作</span>
        io_job <span class="token operator">=</span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token comment"># 注册io操作</span>
        asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>io_call<span class="token punctuation">(</span>
            io_job<span class="token punctuation">,</span>
            <span class="token comment"># 完成后把生成器加入就绪列表，等待下一轮处理</span>
            <span class="token keyword">lambda</span> result<span class="token punctuation">:</span> ready<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
</code></pre></div><p>这里核心思想是维护一个就绪列表，ioloop每轮迭代都来扫一遍，推动就绪的状态的生成器向下运行，并把新的到到IO操作注册，IO完成后再次加入就绪，经过几轮ioloop的迭代一个<code>handler</code>​最终会被执行完成。</p> <p>至此，我们使用生成器写法写业务逻辑已经可以正常运行。</p> <h2 id="_0x04-提高扩展性"><a href="#_0x04-提高扩展性" class="header-anchor">#</a> 0x04 提高扩展性</h2> <p>如果到这里能读懂，python的协程原理基本就明白了。我们已经实现了一个微型的协程框架，标准库的实现细节跟这里看起来大不一样，但具体的思想是一致的。</p> <p>我们的协程框架有一个限制，我们只能把IO操作异步化，虽然在网络编程和web编程的世界里，阻塞的基本只有IO操作，但也有一些例外，比如我想让当前操作<code>sleep</code>​几秒，用<code>time.sleep()</code>​又会让整个线程阻塞住，就需要特殊实现。再比如，可以把一些cpu密集的操作通过多线程异步化，让另一个线程通知事件已经完成后再执行后续。</p> <p>所以，协程最好能与网络解耦开，让等待网络IO只是其中一种场景，提高扩展性。Python官方的解决方案是让用户自己处理阻塞代码，至于是向ioloop来注册IO事件还是开一个线程完全由你自己，并提供了一个标准「占位符」<code>Future</code>​，表示他的结果等到未来才会有，其部分原型如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Future</span>：
    <span class="token comment"># 设置结果</span>
    <span class="token keyword">def</span> <span class="token function">set_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>
    <span class="token comment"># 获取结果</span>
    <span class="token keyword">def</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">pass</span>
    <span class="token comment"># 表示这个future对象是fou已被设置过结果</span>
    <span class="token keyword">def</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>
    <span class="token comment"># 设置在他被设置结果时应该执行的回调函数，可以设置多个</span>
    <span class="token keyword">def</span> <span class="token function">add_done_callback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">pass</span>
</code></pre></div><p>我们的稍加改动就能支持future，让扩展性变得更强。对于用户代码的中的网络请求函数<code>request</code>​：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 现在 request 函数，不是生成器，它返回future</span>
<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># future 理解为占位符</span>
    fut <span class="token operator">=</span> Future<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 当网络IO完成回调的时候给占位符赋值</span>
        fut<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token comment"># 注册回调</span>
    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>io_call<span class="token punctuation">(</span>url<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>

    <span class="token comment"># 返回占位符</span>
    <span class="token keyword">return</span> future
</code></pre></div><p>现在，<code>request</code>​不再是一个生成器，而是直接返回future。而对于位于框架中处理就绪列表的函数：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">process_ready</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>fut<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># future被设置结果会被放入就绪列表</span>
        ready<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> fut<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 遍历所有已经就绪生成器，将其向下推进</span>
    <span class="token keyword">for</span> g<span class="token punctuation">,</span> result <span class="token keyword">in</span> self<span class="token punctuation">.</span>ready<span class="token punctuation">:</span>
        <span class="token comment"># 用result唤醒生成器，得到的不再是io操作，而是future</span>
        fut <span class="token operator">=</span> g<span class="token punctuation">.</span>send<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token comment"># future被设置结果的时候会调用callback</span>
        fut<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
</code></pre></div><h2 id="_0x05-发展和变革"><a href="#_0x05-发展和变革" class="header-anchor">#</a> 0x05 发展和变革</h2> <p>许多年前用<code>tornado</code>​的时候，大概只有一个<code>yield</code>​关键字可用，协程要想实现，就是这么个思路，甚至<code>yield</code>​关键字和<code>return</code>​关键字不能一个函数里面出现，你要想在生成器运行完后返回一个值，需要手动<code>raise</code>​一个异常，虽然效果跟现在<code>return</code>​一样，但写起来还是很别扭，不优雅。</p> <p>后来有了<code>yield from</code>​ 表达式。他可以做什么？通俗地说，他就是做了上面那个生成器<code>wrapper</code>​所做的事：通过栈实现调用链遍历的 ，​<strong>它是</strong>​**<code>wrapper</code><strong>​</strong>逻辑的语法糖**​。有了它，同一个例子你可以这么写：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 注意 yield from</span>
    ret <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> request<span class="token punctuation">(</span><span class="token string">&quot;http://test.com/foo&quot;</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> func2<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ret

<span class="token keyword">def</span> <span class="token function">func2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 注意 yield from</span>
    result <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> request<span class="token punctuation">(</span><span class="token string">&quot;http://test.com/&quot;</span><span class="token operator">+</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result

<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 同上基于future实现的request</span>
    <span class="token keyword">pass</span>
</code></pre></div><p>然后你就不再需要那个烧脑的<code>wrapper</code>​函数了，<code>yield from</code>​ 背后实现了那段晦涩的逻辑：</p> <div class="language-python extra-class"><pre class="language-python"><code>g <span class="token operator">=</span> func1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 返回第一个请求的 future</span>
g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token comment"># 继续运行，进入func2 并得到第它里面的那个future</span>
g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span>
<span class="token comment"># 继续运行，完成调用链剩余逻辑，抛出StopIteration异常</span>
g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;barz&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>​<code>yield from</code>​直接打通了整个调用链，这已经算是很大的进步了，但是用来异步编程看着还是别扭，其他语言此时已经有专门的协程<code>async await</code>​关键字了。终于，再后来的版本把这些内容进一步封装到的<code>async await</code>​ 关键字，才成为今天比较优雅的样子。</p> <h2 id="_0x06-总结和比较"><a href="#_0x06-总结和比较" class="header-anchor">#</a> 0x06 总结和比较</h2> <p>总的来说，python的原生的协程从两方面实现：</p> <ol><li>基于IO多路复用技术，让整个应用在IO上非阻塞，实现高效率</li> <li>通过生成器让分散的callback代码变成同步代码，减少业务编写困难</li></ol> <p>有生成器这种对象的语言，其IO协程实现大抵如此，javascript协程的演进基本一模一样，关键字相同，<code>Future</code>​类比<code>Promise</code>​本质上区别不大。</p> <p>但是对于以协程闻名的<code>go</code>​语言，协程实现跟这个就不同了，它并不基于已有的生成器数据结构。如果要类比的话，可以勉强和python的<code>gevent</code>​算作一类，都是自己实现runtime，并patch掉直接的系统调用接入自己的runtime，自己来调度协程，gevent专注于网络相关，基于网络IO调度，比较简单，go实现了完善的多核支持，调度更加复杂和完善，而且创造了基于<code>channel</code>​新编程范式。</p> <hr> <p>以上。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/Python编程核心/并发编程/asyncio-协程/协程-Asyncio、Gevent.html" class="prev">
        协程-Asyncio、Gevent
      </a></span> <span class="next"><a href="/Python/Python编程核心/并发编程/asyncio-协程/迭代器到生成器.html">
        迭代器到生成器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d3c0dc77.js" defer></script><script src="/assets/js/2.5fbe0391.js" defer></script><script src="/assets/js/1.dc7adba2.js" defer></script><script src="/assets/js/251.758471d1.js" defer></script>
  </body>
</html>
