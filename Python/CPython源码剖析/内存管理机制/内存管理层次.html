<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内存管理层次 | 思源笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link href="/images/logo.png" rel="icon">
    <meta name="description" content="来自思源笔记的内容">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.d3c0dc77.js" as="script"><link rel="preload" href="/assets/js/2.5fbe0391.js" as="script"><link rel="preload" href="/assets/js/1.dc7adba2.js" as="script"><link rel="preload" href="/assets/js/26.fe1a83b5.js" as="script"><link rel="prefetch" href="/assets/js/10.a9ace829.js"><link rel="prefetch" href="/assets/js/100.1ffa901d.js"><link rel="prefetch" href="/assets/js/101.37fdabbb.js"><link rel="prefetch" href="/assets/js/102.9c0f99bd.js"><link rel="prefetch" href="/assets/js/103.571daa23.js"><link rel="prefetch" href="/assets/js/104.88901889.js"><link rel="prefetch" href="/assets/js/105.e1c7fc4a.js"><link rel="prefetch" href="/assets/js/106.366c43d3.js"><link rel="prefetch" href="/assets/js/107.077c5081.js"><link rel="prefetch" href="/assets/js/108.c7d4e1fb.js"><link rel="prefetch" href="/assets/js/109.e7b7cb8f.js"><link rel="prefetch" href="/assets/js/11.32adc493.js"><link rel="prefetch" href="/assets/js/110.86cb08fa.js"><link rel="prefetch" href="/assets/js/111.b725586a.js"><link rel="prefetch" href="/assets/js/112.9f3b9f75.js"><link rel="prefetch" href="/assets/js/113.4a5023eb.js"><link rel="prefetch" href="/assets/js/114.6556c4e7.js"><link rel="prefetch" href="/assets/js/115.72cdb14c.js"><link rel="prefetch" href="/assets/js/116.6d5b51c2.js"><link rel="prefetch" href="/assets/js/117.65ec9b76.js"><link rel="prefetch" href="/assets/js/118.7f4861c9.js"><link rel="prefetch" href="/assets/js/119.650ac25d.js"><link rel="prefetch" href="/assets/js/12.92b47e85.js"><link rel="prefetch" href="/assets/js/120.8e7250e1.js"><link rel="prefetch" href="/assets/js/121.c5a06028.js"><link rel="prefetch" href="/assets/js/122.29f4e7bd.js"><link rel="prefetch" href="/assets/js/123.5e449baf.js"><link rel="prefetch" href="/assets/js/124.a44b0134.js"><link rel="prefetch" href="/assets/js/125.df3fe3e7.js"><link rel="prefetch" href="/assets/js/126.6974e54f.js"><link rel="prefetch" href="/assets/js/127.f2454306.js"><link rel="prefetch" href="/assets/js/128.b900fa7e.js"><link rel="prefetch" href="/assets/js/129.15864c0a.js"><link rel="prefetch" href="/assets/js/13.ebfb1f42.js"><link rel="prefetch" href="/assets/js/130.cc6853ea.js"><link rel="prefetch" href="/assets/js/131.5bb214da.js"><link rel="prefetch" href="/assets/js/132.1a83e445.js"><link rel="prefetch" href="/assets/js/133.da4547b9.js"><link rel="prefetch" href="/assets/js/134.0aeb00a9.js"><link rel="prefetch" href="/assets/js/135.16eb5d31.js"><link rel="prefetch" href="/assets/js/136.67396e70.js"><link rel="prefetch" href="/assets/js/137.afeb5d96.js"><link rel="prefetch" href="/assets/js/138.36e805ef.js"><link rel="prefetch" href="/assets/js/139.7d8c0405.js"><link rel="prefetch" href="/assets/js/14.3e65117c.js"><link rel="prefetch" href="/assets/js/140.6df70824.js"><link rel="prefetch" href="/assets/js/141.f642dacf.js"><link rel="prefetch" href="/assets/js/142.10230571.js"><link rel="prefetch" href="/assets/js/143.d599ee24.js"><link rel="prefetch" href="/assets/js/144.e1a88c20.js"><link rel="prefetch" href="/assets/js/145.eb357101.js"><link rel="prefetch" href="/assets/js/146.b3fe7f16.js"><link rel="prefetch" href="/assets/js/147.dbfb2f7d.js"><link rel="prefetch" href="/assets/js/148.8ed5bf1d.js"><link rel="prefetch" href="/assets/js/149.2c73c82d.js"><link rel="prefetch" href="/assets/js/15.5304afab.js"><link rel="prefetch" href="/assets/js/150.78115158.js"><link rel="prefetch" href="/assets/js/151.22badb82.js"><link rel="prefetch" href="/assets/js/152.a99d0f22.js"><link rel="prefetch" href="/assets/js/153.6a863a43.js"><link rel="prefetch" href="/assets/js/154.c6a0b3dc.js"><link rel="prefetch" href="/assets/js/155.b8591455.js"><link rel="prefetch" href="/assets/js/156.dd9eeca0.js"><link rel="prefetch" href="/assets/js/157.48909220.js"><link rel="prefetch" href="/assets/js/158.99fac6bc.js"><link rel="prefetch" href="/assets/js/159.3bcae7d0.js"><link rel="prefetch" href="/assets/js/16.9ca9aae8.js"><link rel="prefetch" href="/assets/js/160.7c8a9be5.js"><link rel="prefetch" href="/assets/js/161.30bee0bb.js"><link rel="prefetch" href="/assets/js/162.0dde5818.js"><link rel="prefetch" href="/assets/js/163.d4de9cde.js"><link rel="prefetch" href="/assets/js/164.1aa26354.js"><link rel="prefetch" href="/assets/js/165.67d8c450.js"><link rel="prefetch" href="/assets/js/166.81d14b26.js"><link rel="prefetch" href="/assets/js/167.ae715f9a.js"><link rel="prefetch" href="/assets/js/168.f2998afb.js"><link rel="prefetch" href="/assets/js/169.fd39ee46.js"><link rel="prefetch" href="/assets/js/17.3dbcb51f.js"><link rel="prefetch" href="/assets/js/170.147fd31a.js"><link rel="prefetch" href="/assets/js/171.35f8ce60.js"><link rel="prefetch" href="/assets/js/172.10db3085.js"><link rel="prefetch" href="/assets/js/173.11a8ff33.js"><link rel="prefetch" href="/assets/js/174.e196a1f6.js"><link rel="prefetch" href="/assets/js/175.0157f18d.js"><link rel="prefetch" href="/assets/js/176.6d3d456c.js"><link rel="prefetch" href="/assets/js/177.9c40b853.js"><link rel="prefetch" href="/assets/js/178.8dd00920.js"><link rel="prefetch" href="/assets/js/179.f7f4c661.js"><link rel="prefetch" href="/assets/js/18.4c170722.js"><link rel="prefetch" href="/assets/js/180.d02b4575.js"><link rel="prefetch" href="/assets/js/181.be3c0f7a.js"><link rel="prefetch" href="/assets/js/182.ae4673f8.js"><link rel="prefetch" href="/assets/js/183.ed56a865.js"><link rel="prefetch" href="/assets/js/184.43db12b1.js"><link rel="prefetch" href="/assets/js/185.3a09c20e.js"><link rel="prefetch" href="/assets/js/186.77240fee.js"><link rel="prefetch" href="/assets/js/187.c544cb6a.js"><link rel="prefetch" href="/assets/js/188.682782b1.js"><link rel="prefetch" href="/assets/js/189.1e81f7d7.js"><link rel="prefetch" href="/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/assets/js/190.c60243cc.js"><link rel="prefetch" href="/assets/js/191.841c59cf.js"><link rel="prefetch" href="/assets/js/192.6b3c14f5.js"><link rel="prefetch" href="/assets/js/193.47319c1f.js"><link rel="prefetch" href="/assets/js/194.95c798e0.js"><link rel="prefetch" href="/assets/js/195.258b0234.js"><link rel="prefetch" href="/assets/js/196.c5e95bf4.js"><link rel="prefetch" href="/assets/js/197.0a40131d.js"><link rel="prefetch" href="/assets/js/198.6ae77026.js"><link rel="prefetch" href="/assets/js/199.be929f6f.js"><link rel="prefetch" href="/assets/js/20.0d880388.js"><link rel="prefetch" href="/assets/js/200.6fdb4cde.js"><link rel="prefetch" href="/assets/js/201.2db1075b.js"><link rel="prefetch" href="/assets/js/202.6989c482.js"><link rel="prefetch" href="/assets/js/203.fed5be3d.js"><link rel="prefetch" href="/assets/js/204.2e2bd97a.js"><link rel="prefetch" href="/assets/js/205.919ad25d.js"><link rel="prefetch" href="/assets/js/206.caf46f82.js"><link rel="prefetch" href="/assets/js/207.b2786542.js"><link rel="prefetch" href="/assets/js/208.3ff31c7c.js"><link rel="prefetch" href="/assets/js/209.1ff1e0ba.js"><link rel="prefetch" href="/assets/js/21.0ad1d6a3.js"><link rel="prefetch" href="/assets/js/210.5673535d.js"><link rel="prefetch" href="/assets/js/211.07da8ae4.js"><link rel="prefetch" href="/assets/js/212.9a0d098d.js"><link rel="prefetch" href="/assets/js/213.289228c1.js"><link rel="prefetch" href="/assets/js/214.a9e3f658.js"><link rel="prefetch" href="/assets/js/215.2c849138.js"><link rel="prefetch" href="/assets/js/216.0b799039.js"><link rel="prefetch" href="/assets/js/217.248fa9ab.js"><link rel="prefetch" href="/assets/js/218.77bc5089.js"><link rel="prefetch" href="/assets/js/219.d0bcdf70.js"><link rel="prefetch" href="/assets/js/22.288b4852.js"><link rel="prefetch" href="/assets/js/220.abb5d7d1.js"><link rel="prefetch" href="/assets/js/221.39a29724.js"><link rel="prefetch" href="/assets/js/222.c8f848c5.js"><link rel="prefetch" href="/assets/js/223.3ea7fe96.js"><link rel="prefetch" href="/assets/js/224.afb1f423.js"><link rel="prefetch" href="/assets/js/225.cdd67273.js"><link rel="prefetch" href="/assets/js/226.89d69b6c.js"><link rel="prefetch" href="/assets/js/227.f5305f39.js"><link rel="prefetch" href="/assets/js/228.3276d530.js"><link rel="prefetch" href="/assets/js/229.ca4a013c.js"><link rel="prefetch" href="/assets/js/23.730038ee.js"><link rel="prefetch" href="/assets/js/230.19be1bec.js"><link rel="prefetch" href="/assets/js/231.940832b4.js"><link rel="prefetch" href="/assets/js/232.18dbe9c8.js"><link rel="prefetch" href="/assets/js/233.03187181.js"><link rel="prefetch" href="/assets/js/234.ed91cd88.js"><link rel="prefetch" href="/assets/js/235.277f96ac.js"><link rel="prefetch" href="/assets/js/236.8dee6d1a.js"><link rel="prefetch" href="/assets/js/237.6feb0534.js"><link rel="prefetch" href="/assets/js/238.57e64c14.js"><link rel="prefetch" href="/assets/js/239.8aeba238.js"><link rel="prefetch" href="/assets/js/24.933fffa9.js"><link rel="prefetch" href="/assets/js/240.864cffac.js"><link rel="prefetch" href="/assets/js/241.a1c6f45e.js"><link rel="prefetch" href="/assets/js/242.14475f90.js"><link rel="prefetch" href="/assets/js/243.fc4f7920.js"><link rel="prefetch" href="/assets/js/244.89f0d9fc.js"><link rel="prefetch" href="/assets/js/245.4836bb38.js"><link rel="prefetch" href="/assets/js/246.c3e0d73b.js"><link rel="prefetch" href="/assets/js/247.19eaf435.js"><link rel="prefetch" href="/assets/js/248.681c16e7.js"><link rel="prefetch" href="/assets/js/249.91c7786c.js"><link rel="prefetch" href="/assets/js/25.5a3957e2.js"><link rel="prefetch" href="/assets/js/250.999d9d17.js"><link rel="prefetch" href="/assets/js/251.758471d1.js"><link rel="prefetch" href="/assets/js/252.69b6befe.js"><link rel="prefetch" href="/assets/js/253.dd46a3dd.js"><link rel="prefetch" href="/assets/js/254.be5da0c1.js"><link rel="prefetch" href="/assets/js/255.d817ce68.js"><link rel="prefetch" href="/assets/js/256.2c7be7d4.js"><link rel="prefetch" href="/assets/js/257.a6b2fbe0.js"><link rel="prefetch" href="/assets/js/258.a5554c78.js"><link rel="prefetch" href="/assets/js/259.5a99fba0.js"><link rel="prefetch" href="/assets/js/260.41f4e520.js"><link rel="prefetch" href="/assets/js/261.0f73b7e7.js"><link rel="prefetch" href="/assets/js/262.28fa19f9.js"><link rel="prefetch" href="/assets/js/263.4bfbecf4.js"><link rel="prefetch" href="/assets/js/264.e0c89f62.js"><link rel="prefetch" href="/assets/js/265.e9e1d674.js"><link rel="prefetch" href="/assets/js/266.a63b71fb.js"><link rel="prefetch" href="/assets/js/267.420cd7e6.js"><link rel="prefetch" href="/assets/js/268.51e0f667.js"><link rel="prefetch" href="/assets/js/269.3f0d4774.js"><link rel="prefetch" href="/assets/js/27.916eabeb.js"><link rel="prefetch" href="/assets/js/270.c644f9d3.js"><link rel="prefetch" href="/assets/js/271.35387f6e.js"><link rel="prefetch" href="/assets/js/272.a776fe07.js"><link rel="prefetch" href="/assets/js/273.6e463c6b.js"><link rel="prefetch" href="/assets/js/274.8ef8b8e6.js"><link rel="prefetch" href="/assets/js/275.aa2e316d.js"><link rel="prefetch" href="/assets/js/276.9d603319.js"><link rel="prefetch" href="/assets/js/277.d428f5d6.js"><link rel="prefetch" href="/assets/js/278.f702bcfc.js"><link rel="prefetch" href="/assets/js/279.e1449e30.js"><link rel="prefetch" href="/assets/js/28.1116b232.js"><link rel="prefetch" href="/assets/js/280.7601eaee.js"><link rel="prefetch" href="/assets/js/281.84cdb64a.js"><link rel="prefetch" href="/assets/js/282.a6f561ff.js"><link rel="prefetch" href="/assets/js/283.c55742fa.js"><link rel="prefetch" href="/assets/js/284.924e0d7d.js"><link rel="prefetch" href="/assets/js/285.a997b1fb.js"><link rel="prefetch" href="/assets/js/286.cdb934a7.js"><link rel="prefetch" href="/assets/js/287.6f03d7f1.js"><link rel="prefetch" href="/assets/js/288.79e9f811.js"><link rel="prefetch" href="/assets/js/289.4861ef8b.js"><link rel="prefetch" href="/assets/js/29.6bff2814.js"><link rel="prefetch" href="/assets/js/290.e5a58a2f.js"><link rel="prefetch" href="/assets/js/291.9fee54ed.js"><link rel="prefetch" href="/assets/js/292.f8550342.js"><link rel="prefetch" href="/assets/js/293.5f22eb00.js"><link rel="prefetch" href="/assets/js/294.0a21c523.js"><link rel="prefetch" href="/assets/js/295.278a632b.js"><link rel="prefetch" href="/assets/js/296.ffc317e3.js"><link rel="prefetch" href="/assets/js/297.239cab1c.js"><link rel="prefetch" href="/assets/js/298.9f79e196.js"><link rel="prefetch" href="/assets/js/299.5f334485.js"><link rel="prefetch" href="/assets/js/3.bc6bba9e.js"><link rel="prefetch" href="/assets/js/30.218767d4.js"><link rel="prefetch" href="/assets/js/300.0ba14677.js"><link rel="prefetch" href="/assets/js/301.e8f27c97.js"><link rel="prefetch" href="/assets/js/302.c122edfe.js"><link rel="prefetch" href="/assets/js/303.da637783.js"><link rel="prefetch" href="/assets/js/304.4ec1b29e.js"><link rel="prefetch" href="/assets/js/305.3c00ea1f.js"><link rel="prefetch" href="/assets/js/306.b20e9815.js"><link rel="prefetch" href="/assets/js/307.6b91424e.js"><link rel="prefetch" href="/assets/js/308.dc89c12c.js"><link rel="prefetch" href="/assets/js/309.cc9c859e.js"><link rel="prefetch" href="/assets/js/31.2759a7a8.js"><link rel="prefetch" href="/assets/js/310.a9d45b6b.js"><link rel="prefetch" href="/assets/js/311.2054a97f.js"><link rel="prefetch" href="/assets/js/312.4bbc87ce.js"><link rel="prefetch" href="/assets/js/313.6bfffef1.js"><link rel="prefetch" href="/assets/js/314.80c7873d.js"><link rel="prefetch" href="/assets/js/315.e2b4b0eb.js"><link rel="prefetch" href="/assets/js/316.3e4bf82f.js"><link rel="prefetch" href="/assets/js/317.67d43206.js"><link rel="prefetch" href="/assets/js/318.29c1cdea.js"><link rel="prefetch" href="/assets/js/319.902203c8.js"><link rel="prefetch" href="/assets/js/32.49c74da8.js"><link rel="prefetch" href="/assets/js/320.9f322f6c.js"><link rel="prefetch" href="/assets/js/321.9ec16835.js"><link rel="prefetch" href="/assets/js/322.3afb0458.js"><link rel="prefetch" href="/assets/js/323.7c17fa0a.js"><link rel="prefetch" href="/assets/js/324.99ba59d2.js"><link rel="prefetch" href="/assets/js/325.6317221b.js"><link rel="prefetch" href="/assets/js/326.05691f3e.js"><link rel="prefetch" href="/assets/js/327.57a0752b.js"><link rel="prefetch" href="/assets/js/328.bd689f6c.js"><link rel="prefetch" href="/assets/js/329.9d95b288.js"><link rel="prefetch" href="/assets/js/33.da97d900.js"><link rel="prefetch" href="/assets/js/330.3f1aabde.js"><link rel="prefetch" href="/assets/js/331.4d2b6bf2.js"><link rel="prefetch" href="/assets/js/332.3d04f06d.js"><link rel="prefetch" href="/assets/js/333.f76ff221.js"><link rel="prefetch" href="/assets/js/334.cd2fc1ea.js"><link rel="prefetch" href="/assets/js/335.03d03979.js"><link rel="prefetch" href="/assets/js/336.4190f1ee.js"><link rel="prefetch" href="/assets/js/337.fdb48b71.js"><link rel="prefetch" href="/assets/js/338.7db8c869.js"><link rel="prefetch" href="/assets/js/339.90cdb7f0.js"><link rel="prefetch" href="/assets/js/34.42f8b6ab.js"><link rel="prefetch" href="/assets/js/340.4ba3bbd5.js"><link rel="prefetch" href="/assets/js/341.697b02a9.js"><link rel="prefetch" href="/assets/js/342.4af3bc4a.js"><link rel="prefetch" href="/assets/js/343.ba3f5e26.js"><link rel="prefetch" href="/assets/js/344.a3cf4ad3.js"><link rel="prefetch" href="/assets/js/345.d00eb266.js"><link rel="prefetch" href="/assets/js/346.74f1e6d3.js"><link rel="prefetch" href="/assets/js/347.cc3995b9.js"><link rel="prefetch" href="/assets/js/348.37774278.js"><link rel="prefetch" href="/assets/js/349.94d05b9c.js"><link rel="prefetch" href="/assets/js/35.42c35a21.js"><link rel="prefetch" href="/assets/js/350.47f1df55.js"><link rel="prefetch" href="/assets/js/351.1627936d.js"><link rel="prefetch" href="/assets/js/352.277ab034.js"><link rel="prefetch" href="/assets/js/353.c11e8bb5.js"><link rel="prefetch" href="/assets/js/354.ba01078c.js"><link rel="prefetch" href="/assets/js/355.70321476.js"><link rel="prefetch" href="/assets/js/356.94f404af.js"><link rel="prefetch" href="/assets/js/357.ec546a74.js"><link rel="prefetch" href="/assets/js/358.d72741b2.js"><link rel="prefetch" href="/assets/js/359.31c31ceb.js"><link rel="prefetch" href="/assets/js/36.c3767d58.js"><link rel="prefetch" href="/assets/js/360.a654dc23.js"><link rel="prefetch" href="/assets/js/361.46441143.js"><link rel="prefetch" href="/assets/js/362.0aa22356.js"><link rel="prefetch" href="/assets/js/363.355f7781.js"><link rel="prefetch" href="/assets/js/364.7e5168cd.js"><link rel="prefetch" href="/assets/js/365.b5f9bbf4.js"><link rel="prefetch" href="/assets/js/366.35422147.js"><link rel="prefetch" href="/assets/js/367.17af4dd9.js"><link rel="prefetch" href="/assets/js/368.99c04015.js"><link rel="prefetch" href="/assets/js/369.6e269202.js"><link rel="prefetch" href="/assets/js/37.b8f739e7.js"><link rel="prefetch" href="/assets/js/370.4c9fc0f9.js"><link rel="prefetch" href="/assets/js/371.fe9ddc42.js"><link rel="prefetch" href="/assets/js/372.a1a19937.js"><link rel="prefetch" href="/assets/js/373.8244356e.js"><link rel="prefetch" href="/assets/js/374.046bb182.js"><link rel="prefetch" href="/assets/js/375.95079f01.js"><link rel="prefetch" href="/assets/js/376.cb4cbf85.js"><link rel="prefetch" href="/assets/js/377.7f9dcc45.js"><link rel="prefetch" href="/assets/js/378.8396aba6.js"><link rel="prefetch" href="/assets/js/379.78f55713.js"><link rel="prefetch" href="/assets/js/38.cfd18851.js"><link rel="prefetch" href="/assets/js/380.9df95a65.js"><link rel="prefetch" href="/assets/js/381.db02d710.js"><link rel="prefetch" href="/assets/js/382.f5f01bd1.js"><link rel="prefetch" href="/assets/js/383.551a9e39.js"><link rel="prefetch" href="/assets/js/384.521cbf24.js"><link rel="prefetch" href="/assets/js/385.ce4ea212.js"><link rel="prefetch" href="/assets/js/386.3f4d7458.js"><link rel="prefetch" href="/assets/js/387.70a5c9bc.js"><link rel="prefetch" href="/assets/js/388.6d8e6a12.js"><link rel="prefetch" href="/assets/js/389.0088e683.js"><link rel="prefetch" href="/assets/js/39.af3d4c88.js"><link rel="prefetch" href="/assets/js/390.ac189a90.js"><link rel="prefetch" href="/assets/js/391.77894ec3.js"><link rel="prefetch" href="/assets/js/392.94725ec9.js"><link rel="prefetch" href="/assets/js/393.0d91a9e5.js"><link rel="prefetch" href="/assets/js/394.035a8e79.js"><link rel="prefetch" href="/assets/js/395.6dfbee1b.js"><link rel="prefetch" href="/assets/js/396.beb18051.js"><link rel="prefetch" href="/assets/js/397.5326e3a9.js"><link rel="prefetch" href="/assets/js/398.02a3983e.js"><link rel="prefetch" href="/assets/js/399.59d68b2b.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.feab1c20.js"><link rel="prefetch" href="/assets/js/400.f8253cec.js"><link rel="prefetch" href="/assets/js/401.fe8992b6.js"><link rel="prefetch" href="/assets/js/402.c0f7e134.js"><link rel="prefetch" href="/assets/js/403.48996262.js"><link rel="prefetch" href="/assets/js/41.e39d4dc8.js"><link rel="prefetch" href="/assets/js/42.61fe8caf.js"><link rel="prefetch" href="/assets/js/43.a9b01c27.js"><link rel="prefetch" href="/assets/js/44.d0b30ba2.js"><link rel="prefetch" href="/assets/js/45.c503c388.js"><link rel="prefetch" href="/assets/js/46.7206f25e.js"><link rel="prefetch" href="/assets/js/47.f3038db2.js"><link rel="prefetch" href="/assets/js/48.5cb39349.js"><link rel="prefetch" href="/assets/js/49.f05e5dfa.js"><link rel="prefetch" href="/assets/js/5.7098d77a.js"><link rel="prefetch" href="/assets/js/50.f4051900.js"><link rel="prefetch" href="/assets/js/51.140718cc.js"><link rel="prefetch" href="/assets/js/52.df8cb15f.js"><link rel="prefetch" href="/assets/js/53.9322d2fd.js"><link rel="prefetch" href="/assets/js/54.083c2849.js"><link rel="prefetch" href="/assets/js/55.0db6b109.js"><link rel="prefetch" href="/assets/js/56.e36d9f94.js"><link rel="prefetch" href="/assets/js/57.aadb73ac.js"><link rel="prefetch" href="/assets/js/58.e0181ca8.js"><link rel="prefetch" href="/assets/js/59.71fa8395.js"><link rel="prefetch" href="/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/assets/js/60.ccbd5c67.js"><link rel="prefetch" href="/assets/js/61.b29ac4b8.js"><link rel="prefetch" href="/assets/js/62.2c041d9f.js"><link rel="prefetch" href="/assets/js/63.02e68290.js"><link rel="prefetch" href="/assets/js/64.52025364.js"><link rel="prefetch" href="/assets/js/65.821d4920.js"><link rel="prefetch" href="/assets/js/66.b01a2e1f.js"><link rel="prefetch" href="/assets/js/67.49786e78.js"><link rel="prefetch" href="/assets/js/68.c6418f35.js"><link rel="prefetch" href="/assets/js/69.7bd0a0e3.js"><link rel="prefetch" href="/assets/js/7.6a854e57.js"><link rel="prefetch" href="/assets/js/70.6bacad63.js"><link rel="prefetch" href="/assets/js/71.2d2f55cb.js"><link rel="prefetch" href="/assets/js/72.385a2106.js"><link rel="prefetch" href="/assets/js/73.3567215b.js"><link rel="prefetch" href="/assets/js/74.66d5e54d.js"><link rel="prefetch" href="/assets/js/75.e9939676.js"><link rel="prefetch" href="/assets/js/76.ef329155.js"><link rel="prefetch" href="/assets/js/77.704b996e.js"><link rel="prefetch" href="/assets/js/78.6a6ccbbc.js"><link rel="prefetch" href="/assets/js/79.a908ba71.js"><link rel="prefetch" href="/assets/js/80.a6cc65ef.js"><link rel="prefetch" href="/assets/js/81.55fd7628.js"><link rel="prefetch" href="/assets/js/82.9fd118ce.js"><link rel="prefetch" href="/assets/js/83.25043008.js"><link rel="prefetch" href="/assets/js/84.ec86d293.js"><link rel="prefetch" href="/assets/js/85.b4faa1bb.js"><link rel="prefetch" href="/assets/js/86.beade549.js"><link rel="prefetch" href="/assets/js/87.c816be2a.js"><link rel="prefetch" href="/assets/js/88.453dd1c1.js"><link rel="prefetch" href="/assets/js/89.eae28977.js"><link rel="prefetch" href="/assets/js/90.05307532.js"><link rel="prefetch" href="/assets/js/91.fd8bd853.js"><link rel="prefetch" href="/assets/js/92.14aed080.js"><link rel="prefetch" href="/assets/js/93.f1b00b72.js"><link rel="prefetch" href="/assets/js/94.debf50a7.js"><link rel="prefetch" href="/assets/js/95.f9a158ae.js"><link rel="prefetch" href="/assets/js/96.2833401e.js"><link rel="prefetch" href="/assets/js/97.957e0ee5.js"><link rel="prefetch" href="/assets/js/98.9c305f09.js"><link rel="prefetch" href="/assets/js/99.c8981936.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="思源笔记" class="logo"> <span class="site-name can-hide">思源笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><span class="title">Python</span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/Python编程核心/" class="nav-link">
  Python编程核心
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常用模块/" class="nav-link">
  Python常用模块
</a></li><li class="dropdown-item"><!----> <a href="/Python/CPython源码剖析/" class="nav-link">
  CPython源码剖析
</a></li><li class="dropdown-item"><!----> <a href="/Python/Python常见问题.html" class="nav-link">
  Python常见问题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="来自思源笔记" class="dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="来自思源笔记" class="mobile-dropdown-title"><span class="title">来自思源笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Python/" class="nav-link router-link-active">
  Python
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/Python/" class="sidebar-heading clickable router-link-active open"><span>Python</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/CPython源码剖析/" class="sidebar-heading clickable open"><span>CPython源码剖析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/CPython源码剖析/内存管理机制/" class="sidebar-heading clickable open"><span>内存管理机制</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/CPython源码剖析/内存管理机制/关键源码.html" class="sidebar-link">关键源码</a></li><li><a href="/Python/CPython源码剖析/内存管理机制/内存泄漏诊断.html" class="sidebar-link">内存泄漏诊断</a></li><li><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html" class="active sidebar-link">内存管理层次</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html#内存管理层次-2" class="sidebar-link">内存管理层次</a></li><li class="sidebar-sub-header"><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html#按内存尺寸分类管理" class="sidebar-link">按内存尺寸分类管理</a></li><li class="sidebar-sub-header"><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html#pool" class="sidebar-link">pool</a></li><li class="sidebar-sub-header"><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html#pool的组织" class="sidebar-link">pool的组织</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html#虚拟节点和双向循环链表" class="sidebar-link">虚拟节点和双向循环链表</a></li><li class="sidebar-sub-header"><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html#used-full" class="sidebar-link">used-&gt;full</a></li><li class="sidebar-sub-header"><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html#used-empty" class="sidebar-link">used-&gt;empty</a></li><li class="sidebar-sub-header"><a href="/Python/CPython源码剖析/内存管理机制/内存管理层次.html#pool链表数组" class="sidebar-link">pool链表数组</a></li></ul></li></ul></li><li><a href="/Python/CPython源码剖析/内存管理机制/垃圾回收机制.html" class="sidebar-link">垃圾回收机制</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/CPython源码剖析/函数机制/" class="sidebar-heading clickable"><span>函数机制</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/CPython源码剖析/字节码.html" class="sidebar-link">字节码</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/CPython源码剖析/对象模型/" class="sidebar-heading clickable"><span>对象模型</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/CPython源码剖析/生成器和协程/" class="sidebar-heading clickable"><span>生成器和协程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/CPython源码剖析/类机制/" class="sidebar-heading clickable"><span>类机制</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/Python/CPython源码剖析/编译器和虚拟机/" class="sidebar-heading clickable"><span>编译器和虚拟机</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python常用模块/" class="sidebar-heading clickable"><span>Python常用模块</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/Python/Python常见问题.html" class="sidebar-link">Python常见问题</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Python/Python编程核心/" class="sidebar-heading clickable"><span>Python编程核心</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="内存管理层次"><a href="#内存管理层次" class="header-anchor">#</a> 内存管理层次</h1> <p>‍</p> <h2 id="内存管理层次-2"><a href="#内存管理层次-2" class="header-anchor">#</a> 内存管理层次</h2> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220062309-xnvy0xq.png" alt="image">​</p> <p>众所周知，计算机硬件资源由操作系统负责管理，内存资源也不例外。应用程序通过 <strong>系统调用</strong> 向操作系统申请内存，而 C 库函数则进一步将系统调用封装成通用的 <strong>内存分配器</strong> ，并提供了 malloc 系列函数。</p> <p>C 库函数实现的通用目的内存管理器是一个重要的分水岭，即内存管理层次中的 <strong>第 0 层</strong> 。此层之上是应用程序自己的内存管理，此层之下则是隐藏在冰山下方的操作系统部分。</p> <p>操作系统内部是一个基于页表的虚拟内存管理器 (<strong>第 - 1 层</strong>)，以 <strong>页</strong> ( page ) 为单位管理内存，CPU <strong>内存管理单元</strong> ( MMU ) 在这个过程中发挥重要作用。虚拟内存管理器下方则是底层存储设备 (** 第 - 2 层**)，直接管理物理内存以及磁盘等二级存储设备。</p> <p>绿色部分则是 Python 自己的内存管理，分为 3 层：</p> <ul><li>第 1 层，是一个内存分配器，接管一切内存分配，内部是本文的主角 —— <strong>内存池</strong> ；</li> <li>第 2 层，在第 1 层提供的统一 PyMem_XXXX 接口基础上，实现统一的对象内存分配 ( object.tp_alloc )；</li> <li>第 3 层，为特定对象服务，例如前面章节介绍的 float 空闲对象缓存池；</li></ul> <p>Python 为什么不直接使用 malloc 系列函数，而是自己折腾一遍呢？原因主要是以下几点：</p> <ul><li>引入内存池，可化解对象频繁创建销毁带来的内存分配压力；</li> <li>最大程度避免内存碎片化，提升内存利用效率；</li> <li>malloc 有很多实现版本，不同实现性能千差万别；</li></ul> <p>‍</p> <h2 id="按内存尺寸分类管理"><a href="#按内存尺寸分类管理" class="header-anchor">#</a> 按内存尺寸分类管理</h2> <p>在内存管理中，内存碎片的问题是难以避免的，而其问题产生的根源则是将不同尺寸内存块混合管理，将大块内存切分后再次分配的做法是罪魁祸首。</p> <p>因此一般都采用按尺寸分类管理的方案-根据内存块尺寸，将内存空间划分成不同区域，独立管理。</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220062642-pu2bd4s.png" alt="image">​</p> <p>如图，内存被划分成小、中、大三个不同尺寸的区域，区域可由若干内存页组成，每个页都划分为统一规格的内存块。这样一来，小块内存的分配，不会影响大块内存区域，使其碎片化。</p> <p>每个区域的碎片仍无法完全避免，但这些碎片都是可以被重新分配出去的，影响不大。</p> <p>此外，通过优化分配策略，碎片还可被进一步合并。以小块内存为例，新内存优先从内存页 1 分配，内存页 2 将慢慢变空，最终将被整体回收。</p> <p>在 Python 虚拟机内部，时刻有对象创建、销毁，这引发频繁的内存申请、释放动作。这类内存尺寸一般不大，但分配、释放频率非常高，因此 Python 专门设计 <strong>内存池</strong> 对此进行优化。</p> <p>Python 以 512 字节为限，小于 512 的内存分配才会被内存池接管：</p> <ul><li>0 ，直接调用 malloc 函数；</li> <li>1 ~ 512 ，由专门的内存池负责分配，内存池以内存尺寸进行划分；</li> <li>512 以上，直接调动 malloc 函数；</li></ul> <p>同时，Python 并不会为每个尺寸的内存都准备一个独立内存池，原因如下：</p> <ul><li>内存规格有 512 种之多，如果内存池分也分 512 种，徒增复杂性；</li> <li>内存池种类越多，额外开销越大；</li> <li>如果某个尺寸内存只申请一次，将浪费内存页内其他空闲内存；</li></ul> <p>实际操作中，Python 以 8 字节为梯度，将内存块分为：8 字节、16 字节、24 字节，以此类推。总共 64 种：</p> <table><thead><tr><th><strong>请求大小</strong></th> <th><strong>分配内存块大小</strong></th> <th><strong>类别编号</strong></th></tr></thead> <tbody><tr><td>1 ~ 8</td> <td>8</td> <td>0</td></tr> <tr><td>9 ~ 16</td> <td>16</td> <td>1</td></tr> <tr><td>17 ~ 24</td> <td>24</td> <td>2</td></tr> <tr><td>25 ~ 32</td> <td>32</td> <td>3</td></tr> <tr><td>…</td> <td>…</td> <td>…</td></tr> <tr><td>497 ~ 504</td> <td>504</td> <td>62</td></tr> <tr><td>505 ~ 512</td> <td>512</td> <td>63</td></tr></tbody></table> <p>以八字节内存块为例，只要请求的内存大小不超过 8 字节，Python 都在这个内存池为其分配一块 8 字节内存，就算只申请 1 字节内存也是如此。</p> <p>这种做法好处显而易见，前面提到的问题均得到解决，还带来另一个好处：内存起始地址均以计算机字为单位对齐。计算机以 <strong>字</strong> ( word ) 为单位访问内存，因此内存以字对齐可提升内存读写速度。字大小从早期硬件的 2 字节、4 字节，慢慢发展到现在的 8 字节，甚至 16 字节。</p> <p>当然了，有得必有失，内存利用率成了被牺牲的因素，平均利用率为<code>(1+8)/2/8*100%</code>​ ，大约只有 56.25% ，但这只是 8 字节内存块的平均利用率。如果考虑所有内存块的平均利用率，其实数值并不低 —— 可以达到 98.65% 。计算方法如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 请求内存总量</span>
total_requested <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment"># 实际分配内存总量</span>
total_allocated <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment"># 请求内存从1到512字节</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">513</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    total_requested <span class="token operator">+=</span> i
    <span class="token comment"># 实际分配内存为请求内存向上对齐为8的整数倍</span>
    total_allocated <span class="token operator">+=</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{:.2f}%'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>total_requested<span class="token operator">/</span>total_allocated<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 98.65%</span>
</code></pre></div><p>‍</p> <h2 id="pool"><a href="#pool" class="header-anchor">#</a> pool</h2> <p>Python内存池实现源码位于<code>Objects/obmalloc.c</code>​，在源码中可以看到，对于64位系统，Python将内存块大小定义为16字节的整数倍。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">SIZEOF_VOID_P <span class="token operator">&gt;</span> <span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ALIGNMENT</span>              <span class="token expression"><span class="token number">16</span>               </span><span class="token comment">/* must be 2^N */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ALIGNMENT_SHIFT</span>         <span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ALIGNMENT</span>               <span class="token expression"><span class="token number">8</span>               </span><span class="token comment">/* must be 2^N */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ALIGNMENT_SHIFT</span>         <span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre></div><p>（不过为了方便描述，以下仍假设定义的是8字节）</p> <p>Python中存在一个将类别编号转化为块大小的宏-INDEX2SIZE(I)</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">INDEX2SIZE</span><span class="token expression"><span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> ALIGNMENT_SHIFT<span class="token punctuation">)</span></span></span>
</code></pre></div><p>Python 每次申请一个 <strong>内存页</strong> ( page )，然后将其划分为统一尺寸的 <strong>内存块</strong> ( block )，一个内存页大小是 4K ：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYSTEM_PAGE_SIZE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYSTEM_PAGE_SIZE_MASK</span>   <span class="token expression"><span class="token punctuation">(</span>SYSTEM_PAGE_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POOL_SIZE</span>               <span class="token expression">SYSTEM_PAGE_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POOL_SIZE_MASK</span>          <span class="token expression">SYSTEM_PAGE_SIZE_MASK</span></span>
</code></pre></div><p>Python 将内存页看做是由一个个内存块组成的池子 ( pool )，内存页开头是一个 pool_header 结构，用于组织当前页，并记录页中的空闲内存块：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">/* Pool for small blocks. */</span>
<span class="token keyword">struct</span> <span class="token class-name">pool_header</span> <span class="token punctuation">{</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span> block <span class="token operator">*</span>_padding<span class="token punctuation">;</span>
            uint count<span class="token punctuation">;</span> <span class="token punctuation">}</span> ref<span class="token punctuation">;</span>          <span class="token comment">/* 已分配内存块个数：number of allocated blocks    */</span>
    block <span class="token operator">*</span>freeblock<span class="token punctuation">;</span>                   <span class="token comment">/* 空闲块链表头:pool's free list head         */</span>
    <span class="token keyword">struct</span> <span class="token class-name">pool_header</span> <span class="token operator">*</span>nextpool<span class="token punctuation">;</span>       <span class="token comment">/* 下一个pool:next pool of this size class  */</span>
    <span class="token keyword">struct</span> <span class="token class-name">pool_header</span> <span class="token operator">*</span>prevpool<span class="token punctuation">;</span>       <span class="token comment">/* 上一个pool:previous pool       &quot;&quot;        */</span>
    uint arenaindex<span class="token punctuation">;</span>                    <span class="token comment">/* index into arenas of base adr */</span>
    uint szidx<span class="token punctuation">;</span>                         <span class="token comment">/* 尺寸类别编号:block size class index        */</span>
    uint nextoffset<span class="token punctuation">;</span>                    <span class="token comment">/* 下一个未初始化内存块的偏移量:bytes to virgin block         */</span>
    uint maxnextoffset<span class="token punctuation">;</span>                 <span class="token comment">/* 合法内存块最大偏移量:largest valid nextoffset      */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>当 Python 通过内存池申请内存时，如果没有可用 pool ，内存池将新申请一个 4K 页，并进行初始化。注意到，由于新内存页总是由内存请求触发，因此初始化时第一个内存块便已经被分配出去了，并且随着随着内存分配请求的发起，空闲块将被分配出去。Python 将从灰色区域取出下一个作为空闲块，直到灰色块用光：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220064202-bma8lvy.png" alt="image">​</p> <p>当有内存块被释放时，比如第一块，Python 将其链入空闲块链表头。请注意空闲块链表的组织方式 —— 每个块头部保存一个 next 指针，指向下一个空闲块：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220064408-k6wgr3k.png" alt="image">​</p> <p>因此一个 pool 在其生命周期内，可能处于以下 3 种状态：</p> <ul><li>empty ，<strong>完全空闲</strong> 状态，内部所有内存块都是空闲的，没有任何块已被分配，因此 count 为 0 ；</li> <li>used ，<strong>部分使用</strong> 状态，内部内存块部分已被分配，但还有另一部分是空闲的；</li> <li>full ，<strong>完全用满</strong> 状态，内部所有内存块都已被分配，没有任何空闲块，因此 freeblock 为 NULL ；</li></ul> <p>同时pool的状态也决定了Python对其的处理策略：</p> <ul><li>如果 pool 完全空闲，Python 可以将它占用的内存页归还给操作系统，或者缓存起来，后续需要分配新 pool 时直接拿来用；</li> <li>如果 pool 完全用满，Python 就无须关注它了，将它丢到一边；</li> <li>如果 pool 只是部分使用，说明它还有内存块未分配，Python 则将它们以 <strong>双向循环链表</strong> 的形式组织起来；</li></ul> <p>‍</p> <h2 id="pool的组织"><a href="#pool的组织" class="header-anchor">#</a> pool的组织</h2> <h3 id="虚拟节点和双向循环链表"><a href="#虚拟节点和双向循环链表" class="header-anchor">#</a> 虚拟节点和双向循环链表</h3> <p>由于 used 状态的 pool 只是部分使用，内部还有内存块未分配，将它们组织起来可供后续分配。Python 通过 pool_header 结构体中的 nextpool 和 prevpool 指针，将他们连成一个双向循环链表：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220064927-p24777i.png" alt="image">​</p> <p>注意到，同个可用 pool 链表中的内存块大小规格都是一样的。</p> <p>另外，为了简化链表处理逻辑，Python 引入了一个虚拟节点，这是一个常见的 C 语言链表实现技巧。一个空的 pool 链表是这样的，判断条件是 <code>pool-&gt;nextpool == pool</code>​ ：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220065028-1p8grco.png" alt="image">​</p> <p>虚拟节点只参与链表维护，并不实际管理内存块。因此，无须为虚拟节点分配一个完整的 4K 内存页，64 字节的 pool_header 结构体足矣。实际上，Python 作者们更抠，只分配刚好足够 nextpool 和 prevpool 指针用的内存，手法巧妙得令人瞠目结舌，我们稍后再表。</p> <h3 id="used-full"><a href="#used-full" class="header-anchor">#</a> used-&gt;full</h3> <p>Python 优先从链表第一个 pool 分配内存块，如果 pool 用满则将其从链表中剔除：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220065102-fufohtk.png" alt="image">​</p> <p>当一个内存块 ( block ) 被回收，Python 根据块地址计算得到 pool 地址。计算方法是大概是这样的：将 block 地址对齐为内存页 ( pool ) 尺寸的整数倍，便得到 pool 地址，具体请参看源码中的宏定义 POOL_ADDR 。</p> <p>得到 pool 地址后，Python 将空闲内存块插到空闲内存块链表头部。如果 pool 状态是由 <strong>完全用满</strong> ( full ) 变为 <strong>可用</strong> ( used )，Python 还会将它插回可用 pool 链表头部：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220065143-oo57vs1.png" alt="image">​</p> <p>插到可用 pool 链表头部是为了保证比较满的 pool 在链表前面，以便优先使用。位于尾部的 pool 被使用的概率很低，随着时间的推移，更多的内存块被释放出来，慢慢变空。因此，pool 链表明显头重脚轻，靠前的 pool 比较满，而靠后的 pool 比较空，正如上图所示。</p> <h3 id="used-empty"><a href="#used-empty" class="header-anchor">#</a> used-&gt;empty</h3> <p>当一个 pool 所有内存块 ( block ) 都被释放，状态就变为 <strong>完全空闲</strong> ( empty )。Python 会将它移出链表，内存页可能直接归还给操作系统，或者缓存起来以备后用：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220065257-e9ptsiy.png" alt="image">​</p> <p>实际上，pool 链表任一节点均有机会完全空闲下来。这由概率决定，尾部节点概率最高，因此上图就这么画了。</p> <p>‍</p> <h3 id="pool链表数组"><a href="#pool链表数组" class="header-anchor">#</a> pool链表数组</h3> <p>Python 内存池管理内存块，按照尺寸分门别类进行。因此，每种规格都需要维护一个独立的可用 pool 链表。如果以 8 字节为梯度，内存块规格可分 64 种之多。</p> <p>那么，如何组织这么多 pool 链表呢？最直接的方法是分配一个长度为 64 的虚拟节点数组：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220065416-4bly3ju.png" alt="image">​</p> <p>但实际上因为虚拟节点只参与维护链表结构，并不管理内存页。因此，虚拟节点其实只使用 pool_header 结构体中参与链表维护的 nextpool 和 prevpool 这两个指针字段，所以Python 作者们将虚拟节点想象成一个个卡片，将深蓝色部分首尾相接，最终转换成一个纯指针数组。数组在 Objects/obmalloc.c 中定义，即 usedpools 。每个虚拟节点对应数组里面的两个指针：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230220065455-ssts43s.png" alt="image">​</p> <p>接下来的一切交给想象力 —— 将两个指针前后的内存空间想象成自己的，这样就得到一个虚无缥缈的却非常完整的 pool_header 结构体（如下图左边虚线部分），我们甚至可以使用这个 pool_header 结构体的地址！由于我们不会访问除了 nextpool 和 prevpool 指针以外的字段，因此虽有内存越界，却也无伤大雅。</p> <p>下图以一个代表空链表的虚拟节点为例，nextpool 和 prevpool 指针均指向 pool_header 自己。虽然实际上 nextpool 和 prevpool 都指向了数组中的其他虚拟节点，但逻辑上可以想象成指向当前的 pool_header 结构体：</p> <p>​<img src="https://assets.b3logfile.com/siyuan/xxxxxx/assets/net-img-5f583b660001963211110585-20230220065656-fytvavh.png" alt="图片描述">​</p> <p>‍</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Python/CPython源码剖析/内存管理机制/内存泄漏诊断.html" class="prev">
        内存泄漏诊断
      </a></span> <span class="next"><a href="/Python/CPython源码剖析/内存管理机制/垃圾回收机制.html">
        垃圾回收机制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d3c0dc77.js" defer></script><script src="/assets/js/2.5fbe0391.js" defer></script><script src="/assets/js/1.dc7adba2.js" defer></script><script src="/assets/js/26.fe1a83b5.js" defer></script>
  </body>
</html>
