(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{337:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"类机制与字节码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#类机制与字节码"}},[t._v("#")]),t._v(" 类机制与字节码")]),t._v(" "),s("h2",{attrs:{id:"compile-手动编译类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#compile-手动编译类"}},[t._v("#")]),t._v(" compile 手动编译类")]),t._v(" "),s("h3",{attrs:{id:"compile-text-exec"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#compile-text-exec"}},[t._v("#")]),t._v(" compile(text,'','exec')")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" text "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v("'''\n... class Dog:\n...     def yelp(self):\n...         print('woof')\n... '''")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" code "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("compile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("text"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'exec'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" dis\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" dis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" LOAD_BUILD_CLASS\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("code "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),t._v(" Dog at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10110f8a0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" line "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Dog'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" MAKE_FUNCTION            "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Dog'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" CALL_FUNCTION            "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" STORE_NAME               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Dog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" RETURN_VALUE\n\nDisassembly of "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("code "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),t._v(" Dog at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10110f8a0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" line "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" LOAD_NAME                "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__name__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" STORE_NAME               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__module__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Dog'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" STORE_NAME               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__qualname__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("code "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),t._v(" yelp at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10110f390")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" line "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Dog.yelp'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" MAKE_FUNCTION            "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(" STORE_NAME               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("yelp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" RETURN_VALUE\n\nDisassembly of "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("code "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),t._v(" yelp at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10110f390")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" line "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("           "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" LOAD_GLOBAL              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'woof'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" CALL_FUNCTION            "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" POP_TOP\n              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" LOAD_CONST               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" RETURN_VALUE\n")])])]),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230219061000-ly51dp4.png",alt:"image"}}),t._v("​")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230219055224-5gy2k86.png",alt:"image"}}),t._v("​")]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("h3",{attrs:{id:"虚拟机执行过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#虚拟机执行过程"}},[t._v("#")]),t._v(" 虚拟机执行过程")]),t._v(" "),s("h4",{attrs:{id:"创建名为-dog-的函数对象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建名为-dog-的函数对象"}},[t._v("#")]),t._v(" 创建名为 Dog 的函数对象")]),t._v(" "),s("p",[t._v("以上面手动编译的 Dog 类为例。")]),t._v(" "),s("p",[t._v("模块代码执行时，虚拟机内部有一个 "),s("strong",[t._v("栈帧")]),t._v(" 对象，维护着代码对象运行时时的上下文信息，全局和局部名字空间均指向模块属性空间。")]),t._v(" "),s("p",[t._v("前 3 条字节码，负责往运行栈加载数据。"),s("code",[t._v("LOAD_BUILD_CLASS")]),t._v("​ ​这个字节码源码在 "),s("code",[t._v("Python/ceval.c")]),t._v("​​ 中，其作用很简单，只是将 "),s("code",[t._v("__build_class__")]),t._v("​ ​这个内建函数加载进栈顶。该函数为 "),s("code",[t._v("builtins")]),t._v("​ ​模块中的一员，一个负责创建类的工具函数。")]),t._v(" "),s("p",[t._v("接着，第 2 条字节码将下标为 0 的常量加载到栈顶，这是代表 Dog 类代码块的代码对象，如红色箭头所示。第 3 条字节码将常量 Dog 加载到栈顶。第 4 条字码时我们在函数机制中学过的 "),s("code",[t._v("MAKE_FUNCTION")]),t._v("​​​指令，用于创建函数对象。")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230219061216-azq1qai.png",alt:"image"}}),t._v("​")]),t._v(" "),s("h4",{attrs:{id:"名为-dog-的函数对象创建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#名为-dog-的函数对象创建"}},[t._v("#")]),t._v(" 名为 Dog 的函数对象创建")]),t._v(" "),s("p",[t._v("指令执行完毕后，名为 Dog 的函数对象就被保存在栈顶了。")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230219061622-esakpib.png",alt:"image"}}),t._v("​")]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("h4",{attrs:{id:"build-class-​"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#build-class-​"}},[t._v("#")]),t._v(" "),s("code",[t._v("__build_class__")]),t._v("​")]),t._v(" "),s("h5",{attrs:{id:"执行前"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#执行前"}},[t._v("#")]),t._v(" 执行前")]),t._v(" "),s("p",[t._v("查看 "),s("code",[t._v("__build_class__")]),t._v("​ ​函数帮助文档可以得知，该函数第一个参数是一个函数，第二个参数是一个名字。")]),t._v(" "),s("div",{staticClass:"language-cpp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("help")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__build_class__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nHelp on built"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("in function __build_class__ in "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token module"}},[t._v("builtins"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n\n__build_class__")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__build_class__")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("func"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("bases"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" metaclass"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("None"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("kwds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Internal")]),t._v(" helper function used by the "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("statement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),s("p",[t._v("其中第一个函数由字节码 2-4 创建完成，即上一步创建的名为 Dog 的函数，第二个名字将在字节码 5 处加载入栈帧对象的临时栈顶。")]),t._v(" "),s("p",[t._v("​"),s("code",[t._v("__build_class__")]),t._v("​源码实现在"),s("code",[t._v("Python/bltinmodule.c")]),t._v("​，观察可以发现，其并没有直接调用新创建的Dog函数，而是先创建一个dict对象，作为新生类的属性空间，然后从Dog函数中取出全局名字空间和代码对象，最后新建一个栈帧对象并开始执行Dog类代码对象。")]),t._v(" "),s("p",[t._v("其中关键的关系如下：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("模块的属性空间=Dog函数的全局名字空间=栈帧对象的全局名字空间")]),t._v(" "),s("blockquote",[s("p",[t._v("栈帧对象的f_global会继承父栈帧对象的f_global")])])]),t._v(" "),s("li",[s("p",[t._v("Dog函数的代码对象=Dog类的代码对象")])]),t._v(" "),s("li",[s("p",[t._v("Dog函数的局部名字空间("),s("code",[t._v("__dict__")]),t._v("​)=Dog类的属性空间")])])]),t._v(" "),s("p",[t._v("即实际上Dog函数只是作为打包参数的包袱，将代码对象、全局名字空间等参数作为一个整体进行传递")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230219131427-oyytngq.png",alt:"image"}}),t._v("​")]),t._v(" "),s("h5",{attrs:{id:"准备属性空间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备属性空间"}},[t._v("#")]),t._v(" 准备属性空间")]),t._v(" "),s("p",[t._v("代码先从全局名字空间取出模块名 "),s("code",[t._v("__name__")]),t._v("​，在局部名字空间中保存为 "),s("code",[t._v("__module__")]),t._v("​，然后将类名 Dog 保存到局部名字空间中的 "),s("code",[t._v("__qualname__")]),t._v("​。最后取出 yelp 函数的代码对象，完成 yelp 函数对象的创建工作。至此，新生类 Dog 的属性空间完成初始化，属性空间准备完成。")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230219134153-wnm5w8o.png",alt:"image"}}),t._v("​")]),t._v(" "),s("h5",{attrs:{id:"创建新生类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建新生类"}},[t._v("#")]),t._v(" 创建新生类")]),t._v(" "),s("p",[t._v("类属性空间准备完毕，"),s("code",[t._v("__build_class__")]),t._v("​接着调用 type 元类型对象完成 Dog 类的创建。type 需要的参数有 3个，分别是： "),s("strong",[t._v("类名")]),t._v(" 、 "),s("strong",[t._v("基类列表")]),t._v(" (类继承)以及代表 "),s("strong",[t._v("类属性空间")]),t._v(" 的 dict 对象。")]),t._v(" "),s("p",[t._v("至此，Dog类创建完成")]),t._v(" "),s("div",{staticClass:"language-cpp extra-class"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("help")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nHelp on "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("type")]),t._v(" in "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token module"}},[t._v("builtins")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object_or_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bases"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" the object"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("'")]),t._v("s type\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bases"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" a "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" type\n")])])]),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230219134353-fxxrbsp.png",alt:"image"}}),t._v("​")]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("h4",{attrs:{id:"收尾"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#收尾"}},[t._v("#")]),t._v(" 收尾")]),t._v(" "),s("p",[t._v("模块代码对象最后的字节码将 Dog 类对象保存于模块属性空间")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/image-20230219134504-jvr03ma.png",alt:"image"}}),t._v("​")]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("h2",{attrs:{id:"python模拟"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#python模拟"}},[t._v("#")]),t._v(" Python模拟")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 模块代码对象")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" code\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("code "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("module"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10b42e8a0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" line "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Dog 类代码对象")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("co_consts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("code "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),t._v(" Dog at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10b42ac00")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" line "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Dog 类 yelp 函数代码对象")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("co_consts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("co_consts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("code "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),t._v(" yelp at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10b5136f0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" line "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 新建一个dict对象作为类的属性空间")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" attrs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 以类属性空间为局部名字空间，执行类代码对象，以此完成新类属性空间初始化")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("code"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("co_consts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("globals")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attrs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" attrs\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__module__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__main__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__qualname__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Dog'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'yelp'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("function Dog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yelp at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10b732e18")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 调用type函数完成类对象创建")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Dog "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Dog'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attrs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Dog\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__main__.Dog'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" dog "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Dog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" dog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yelp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nwoof\n")])])]),s("p",[t._v("‍")])])}),[],!1,null,null,null);s.default=e.exports}}]);