(window.webpackJsonp=window.webpackJsonp||[]).push([[204],{486:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"内存泄露诊断案例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内存泄露诊断案例"}},[t._v("#")]),t._v(" 内存泄露诊断案例")]),t._v(" "),s("h2",{attrs:{id:"原文"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原文"}},[t._v("#")]),t._v(" 原文")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://www.imooc.com/read/76/article/1940",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.imooc.com/read/76/article/1940"),s("OutboundLink")],1)])]),t._v(" "),s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("虽然 "),s("em",[t._v("Python")]),t._v(" 自带垃圾回收机制，替开发人员管理内存，并不意味着 "),s("em",[t._v("Python")]),t._v(" 程序没有内存泄露之虞。实际上，"),s("em",[t._v("Python")]),t._v(" 程序内存泄露问题时有发生 —— 程序跑着跑着，占用内存越来越多，最后只能动用重启大法释放内存……")]),t._v(" "),s("p",[t._v("由于内存分配回收工作已被 "),s("em",[t._v("Python")]),t._v(" 接管，内存泄露问题排查起来相对来说也比较晦涩。正常情况下，"),s("strong",[t._v("引用计数")]),t._v(" 机制确保对象没有引用时释放，而 "),s("strong",[t._v("标记清除")]),t._v(" 则解决了 "),s("strong",[t._v("循环引用")]),t._v(" 的问题，理论上不存在内存泄露的可能性。")]),t._v(" "),s("p",[t._v("那么，"),s("em",[t._v("Python")]),t._v(" 程序内存泄露问题一般是如何造成的呢？程序员的失误是其中的主要原因，最常见的是下面两点：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("容器泄露")]),t._v(" ，使用容器对象存储数据，但数据只进不出，没有清理机制，容器便慢慢变大，最后撑爆内存；")]),t._v(" "),s("li",[t._v("​ "),s("strong",[t._v("__del__魔术方法误用")]),t._v("​，如果对象实现了  "),s("em",[s("strong",[t._v("del")])]),t._v("  魔术方法，"),s("em",[t._v("Python")]),t._v(" 就无法用标记清除法解决循环引用问题，这必然带来内存泄露风险；")])]),t._v(" "),s("p",[t._v("既然内存泄露无法完全避免，当 "),s("em",[t._v("Python")]),t._v(" 程序发生内存泄漏时，又该如何排查呢？")]),t._v(" "),s("p",[t._v("本节，我们将以一个简单的案例，详细讲解预防、排查、解决 "),s("em",[t._v("Python")]),t._v(" 内存泄露问题的 "),s("strong",[t._v("方法论")]),t._v(" 。")]),t._v(" "),s("p",[t._v("工欲善其事，必先利其器。在这个过程中，我们将利用一些趁手的工具（例如 "),s("em",[t._v("objgraph")]),t._v(" 等）。只有选择正确工具，掌握工具正确使用姿势，才能做到事半功倍。")]),t._v(" "),s("h2",{attrs:{id:"问题服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题服务"}},[t._v("#")]),t._v(" 问题服务")]),t._v(" "),s("p",[t._v("我们以一个存在内存泄露问题的 "),s("em",[t._v("API")]),t._v(" 服务 ( "),s("em",[t._v("service.py")]),t._v(" ) 作为例子，演示定位内存泄露问题的步骤：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" uvicorn\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" fastapi "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" FastAPI\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" faker "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Faker\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" pyconsole "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" start_console_server\n\nfaker "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Faker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncache "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\napp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" FastAPI"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch_user_from_database")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user_id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" faker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sha256"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" user_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'random'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'name'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" faker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'email'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" faker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("email"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'address'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" faker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("address"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'desc'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" faker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" data\n\n    data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" fetch_user_from_database"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user_id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" data\n\n"),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/users/{user_id}'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("retrieve_user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" get_user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" __name__ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__main__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    start_console_server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    uvicorn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("run"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("这是一个基于 "),s("a",{attrs:{href:"https://python.fasionchan.com/zh_CN/latest/advanced/restful/fastapi/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("fastapi"),s("OutboundLink")],1),t._v(" 框架编写的 "),s("em",[t._v("API")]),t._v(" 服务，它只实现了一个接口：根据用户 "),s("em",[t._v("ID")]),t._v(" 获取用户信息。"),s("em",[t._v("API")]),t._v(" 服务由 "),s("em",[t._v("uvicorn")]),t._v(" 启动，它是一个性能非常优秀的 "),s("em",[t._v("ASGI")]),t._v(" 服务器。")]),t._v(" "),s("p",[t._v("为减少数据库访问频率，程序将数据库返回的用户数据，以用户 "),s("em",[t._v("ID")]),t._v(" 为索引，缓存在内存中 ( "),s("em",[t._v("cache")]),t._v(" 字典)。注意到，演示服务直接使用 "),s("a",{attrs:{href:"https://python.fasionchan.com/zh_CN/latest/libs/faker.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("faker"),s("OutboundLink")],1),t._v(" 随机生成用户数据，模拟数据库查询，以此消除数据库依赖。")]),t._v(" "),s("p",[t._v("顺便提一下，"),s("em",[t._v("faker")]),t._v(" 是一个生成假数据的模块，非常好用。特别是需要测试数据时，完全不用自己绞尽脑汁拼造。")]),t._v(" "),s("p",[t._v("服务还启动了一个远程交互式终端，以便我们可以连上服务进程，并在里面执行一些代码。交互式终端的源码可以在 "),s("em",[t._v("github")]),t._v(" 上获得： "),s("a",{attrs:{href:"https://gist.github.com/fasionchan/e3087acd6e61e38ad25af27228a8406e",target:"_blank",rel:"noopener noreferrer"}},[t._v("pyconsole.py"),s("OutboundLink")],1),t._v(" ，原理超过本节讨论范围不展开介绍。")]),t._v(" "),s("p",[t._v("由于例子代码非常简单，哪里内存泄露我们甚至仅凭肉眼便可看出。尽管如此，我们假装什么都不知道，来研究解决问题的思路：如何观察程序？如何运用工具来获取一些关键信息？如何分析各个线索？如何逐步接近问题的根源？")]),t._v(" "),s("h2",{attrs:{id:"运行服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运行服务"}},[t._v("#")]),t._v(" 运行服务")]),t._v(" "),s("p",[t._v("由于服务依赖几个第三方包，启动它之前请先用 "),s("em",[t._v("pip")]),t._v(" 安装这些依赖包，并且确保安装是成功的：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pip "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" uvicorn\n$ pip "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" fastapi\n$ pip "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" faker\n")])])]),s("p",[t._v("直接执行 "),s("em",[t._v("service.py")]),t._v(" 即可启动服务，默认它会监听 "),s("em",[t._v("8000")]),t._v(" 端口：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ python service.py\nINFO:     Started server process "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("76591")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nINFO:     Waiting "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" application startup.\nINFO:     Application startup complete.\nINFO:     Uvicorn running on http://127.0.0.1:8000 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Press CTRL+C to quit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("服务启动后，即可通过 "),s("em",[t._v("8000")]),t._v(" 端口访问用户信息接口，用户 "),s("em",[t._v("ID")]),t._v(" 可以随便给：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://127.0.0.1:8000/users/bef76936c7d22e98f3d7b4c7e1aeef524da4ec1b48f871926fee43c5ec071a2d\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user_id"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bef76936c7d22e98f3d7b4c7e1aeef524da4ec1b48f871926fee43c5ec071a2d"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Patricia Johnson"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"email"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"epatton@yahoo.com"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"address"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"837 Jacobs Field'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('Gregorybury, ND 81050"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"desc"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Third choice air together expect account war. Seven dog safe significant. Expect exist wrong finish window there raise. Third blue and cover."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("服务接口还支持随机查询，随机返回一个用户的信息：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://127.0.0.1:8000/users/random\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user_id"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"d6a55f04bab8ddec83d651bdca77f7215042b792970482213b6da56a119f18a8"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Evan Carter"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"email"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"andrea79@garcia.com"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"address"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"109 Miller Lights Apt. 843'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('Port Jamie, IN 97570"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"desc"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Resource green allow him. Build store enough effect alone. Everybody right remember public coach book not.'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('Conference respond trip girl."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"远程终端"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#远程终端"}},[t._v("#")]),t._v(" 远程终端")]),t._v(" "),s("p",[t._v("我们直接执行 "),s("em",[t._v("pyconsole.py")]),t._v(" ，以默认端口即可连接正在运行中的 "),s("em",[t._v("API")]),t._v(" 服务进程：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("$ python pyconsole"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("py\nPython "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.8")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".5")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Aug  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("49")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("57")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("GCC "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.4")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20160609")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" on linux\nType "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"help"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"copyright"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"credits"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"license"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" more information"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ConsoleClient"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),s("p",[s("em",[t._v("pyconsole")]),t._v(" 用法跟 "),s("em",[t._v("Python")]),t._v(" 交互式终端一样，但代码执行环境是在被连接的服务进程里面，因此可以看到服务内部的实时状态。我们先通过 "),s("em",[t._v("dir")]),t._v(" 内建函数看看远程终端的名字空间都有些啥：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("dir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__builtins__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__doc__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__name__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'main'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sys'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" main\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("module "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__main__'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'service.py'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("dir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Faker'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'FastAPI'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__annotations__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__builtins__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__cached__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__doc__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__file__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__loader__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__name__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__package__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__spec__'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'app'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cache'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'faker'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fetch_user_from_database'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'get_user'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'retrieve_user'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'start_console_server'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'uvicorn'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[s("em",[t._v("main")]),t._v(" 就是服务的  "),s("em",[s("strong",[t._v("main")])]),t._v("  模块，从中还可以找到 "),s("em",[t._v("service.py")]),t._v(" 导入的 "),s("em",[t._v("Faker")]),t._v(" 、"),s("em",[t._v("FastAPI")]),t._v(" 等，它定义的函数 "),s("em",[t._v("retrieve_user")]),t._v(" 、"),s("em",[t._v("get_user")]),t._v(" 等，还有作为全局变量存在的 "),s("em",[t._v("cache")]),t._v(" 字典。甚至，我们还可以看到 "),s("em",[t._v("cache")]),t._v(" 当前缓存了多少用户信息：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n")])])]),s("p",[t._v("由于我们前面通过 "),s("em",[t._v("API")]),t._v(" 获取了 "),s("em",[t._v("2")]),t._v(" 条用户数据，因此 "),s("em",[t._v("cache")]),t._v(" 当前缓存了 "),s("em",[t._v("2")]),t._v(" 条数据。当我们再次访问接口获取其他用户数据时，我们会看到 "),s("em",[t._v("cache")]),t._v(" 缓存的用户数据会慢慢增加：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n")])])]),s("p",[s("em",[t._v("pyconsole")]),t._v(" 是一个很神奇的终端，能够实时查看 "),s("em",[t._v("Python")]),t._v(" 进程里面各种数据的状态，在排查问题时非常方便！")]),t._v(" "),s("h2",{attrs:{id:"内存测量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内存测量"}},[t._v("#")]),t._v(" 内存测量")]),t._v(" "),s("p",[t._v("解决内存泄露问题，首先需要确认问题的存在性以及严重程度。程序它占用了多少内存？内存增长速度快吗？")]),t._v(" "),s("p",[t._v("在 "),s("em",[t._v("Linux")]),t._v(" 系统，可以执行 "),s("em",[t._v("ps")]),t._v(" 命令查看进程信息，从中可以看到内存占用量：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" aux "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" python "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" service.py\nfasion    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6467")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.2")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.5")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("306600")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("44152")]),t._v(" pts/2    Sl+  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":02   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(":03 python service.py\n")])])]),s("p",[t._v("我们重点关注 "),s("em",[t._v("VSZ")]),t._v(" 和 "),s("em",[t._v("RSS")]),t._v(" ，这两者是评价进程内存的重要指标，必要时请复习操作系统相关知识力求准确理解。")]),t._v(" "),s("ul",[s("li",[s("em",[t._v("VSZ")]),t._v(" ，程序虚拟内存空间大小；")]),t._v(" "),s("li",[s("em",[t._v("RSS")]),t._v(" ，程序占用的物理内存大小；")])]),t._v(" "),s("p",[s("em",[t._v("ps")]),t._v(" 命令输出告诉我们，服务进程刚启动时，虚拟内存空间大小大概是 "),s("em",[t._v("306M")]),t._v(" ，占用物理内存大概 "),s("em",[t._v("44M")]),t._v(" 。看上去没问题，但进程内存会不会随着时间推移不断增长呢？")]),t._v(" "),s("p",[t._v("接下来，我们用 "),s("a",{attrs:{href:"https://network.fasionchan.com/zh_CN/latest/performance/web-pressure-test.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ab"),s("OutboundLink")],1),t._v(" 命令向服务压大量请求，看看它有什么反应。先压 "),s("em",[t._v("1")]),t._v(" 万个请求试试看：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("ab -n 10000 -c 100 http://127.0.0.1:8000/users/random\n")])])]),s("p",[t._v("我们发现程序进程虚拟内存空间增长到 "),s("em",[t._v("327M")]),t._v(" ，而物理内存则增长到 "),s("em",[t._v("63M")]),t._v(" ，继续压请求发现内存还继续涨：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("strong",[t._v("请求数")])]),t._v(" "),s("th",[s("strong",[t._v("虚拟内存 / M")])]),t._v(" "),s("th",[t._v("** 物理内存 / M**")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("10000")]),t._v(" "),s("td",[t._v("327")]),t._v(" "),s("td",[t._v("63")])]),t._v(" "),s("tr",[s("td",[t._v("20000")]),t._v(" "),s("td",[t._v("339")]),t._v(" "),s("td",[t._v("75")])]),t._v(" "),s("tr",[s("td",[t._v("50000")]),t._v(" "),s("td",[t._v("365")]),t._v(" "),s("td",[t._v("101")])]),t._v(" "),s("tr",[s("td",[t._v("100000")]),t._v(" "),s("td",[t._v("400")]),t._v(" "),s("td",[t._v("135")])])])]),t._v(" "),s("p",[t._v("随着时间的推移，新请求不断达到，进程内存也在缓缓上升。不管内存上升速度多慢，程序最终必然翻车。建议利用监控系统，对重要服务进程内存进行监控，这样可以第一时间发现内存泄露问题：")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/5f680f100001919e08850574-20231216182334-fdkiih2.png",alt:"图片描述"}}),t._v("​")]),t._v(" "),s("p",[t._v("回放历史数据，从中可以看出进程内存的长期增长趋势。通过分析长期趋势，甚至能够精准确定内存问题出现的时间点；结合当时变更情况，准确定位问题代码，事半功倍：")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/5f680f180001095a08670583-20231216182334-7ecdko0.png",alt:"图片描述"}}),t._v("​")]),t._v(" "),s("p",[t._v("如上图，程序虚拟内存大小在某个时间点突然陡增。联系当时相关代码变更，定位问题更有针对性。")]),t._v(" "),s("h2",{attrs:{id:"objgraph"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#objgraph"}},[t._v("#")]),t._v(" objgraph")]),t._v(" "),s("p",[s("em",[t._v("objgraph")]),t._v(" 是一个用于勘察 "),s("em",[t._v("Python")]),t._v(" 内部对象的第三方模块，擅长绘制对象引用关系图以及排查内存泄露问题：")]),t._v(" "),s("ul",[s("li",[t._v("取出某种类型的所有实例对象 ( "),s("em",[t._v("by_type")]),t._v(" )；")]),t._v(" "),s("li",[t._v("统计程序中数量最多的对象，并排序 ( "),s("em",[t._v("show_most_common_types")]),t._v(" )；")]),t._v(" "),s("li",[t._v("绘制对象引用关系图 ( "),s("em",[t._v("show_refs")]),t._v(" )；")]),t._v(" "),s("li",[t._v("绘制反向引用关系图 ( "),s("em",[t._v("show_backrefs")]),t._v(" )；")]),t._v(" "),s("li",[s("em",[t._v("etc")])])]),t._v(" "),s("p",[t._v("开始使用之前，我们先通过 "),s("em",[t._v("pip")]),t._v(" 来安装，确保 "),s("em",[t._v("service.py")]),t._v(" 服务进程可以导入该模块：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("$ pip install objgraph\n")])])]),s("p",[t._v("安装完毕后，我们回到 "),s("em",[t._v("pyconsole")]),t._v(" 远程终端，在服务进程中导入 "),s("em",[t._v("objgraph")]),t._v(" ：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" objgraph\n")])])]),s("p",[t._v("现在，我们先调用 "),s("em",[t._v("show_most_common_types")]),t._v(" 函数，统计数量最多的对象类型：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("show_most_common_types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("dict")]),t._v("                 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16482")]),t._v("\nmethod               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8189")]),t._v("\nfunction             "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7095")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),t._v("                 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6632")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("tuple")]),t._v("                "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4797")]),t._v("\ndeque                "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4670")]),t._v("\nEvent                "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3112")]),t._v("\nweakref              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2307")]),t._v("\nAsyncExitStack       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1554")]),t._v("\nRequestResponseCycle "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1553")]),t._v("\n")])])]),s("p",[t._v("我们看到，程序中 "),s("em",[t._v("dict")]),t._v(" 对象最多，总过有 "),s("em",[t._v("16000")]),t._v(" 多个，"),s("em",[t._v("method")]),t._v(" 对象次之。一般而言，存在内存泄露的程序，内部会有大量的某种对象。如果发现某个类的对象特别多，问题就可以缩小到与该类相关的代码逻辑。")]),t._v(" "),s("p",[t._v("由于我们的程序没有定义类，因此这里看到的大部分对象都是内建类型，没有足够特异性。那是不是就无解了呢？")]),t._v(" "),s("p",[t._v("肯定不是的。由于泄露的大量对象一定是保存在某种容器中，因此程序中应该有某个容器对象长度特别长。只要找到这个容器对象，问题也就解决了。那么，如何找到这个关键对象呢？")]),t._v(" "),s("p",[t._v("常用的容器对象无非 "),s("em",[t._v("tuple")]),t._v(" 、"),s("em",[t._v("list")]),t._v(" 、"),s("em",[t._v("dict")]),t._v(" 这几个，我们只需将这几个种类的对象找到即可。"),s("em",[t._v("objgraph")]),t._v(" 有一个函数 "),s("em",[t._v("by_type")]),t._v(" ，用于获取某个种类的对象，刚好可以派上用场。我们先将程序中所有 "),s("em",[t._v("tuple")]),t._v(" 对象找出来：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" tuples "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("by_type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tuple'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tuples"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4425")]),t._v("\n")])])]),s("p",[t._v("如此一来，我们可以写一个函数将长度最长的给定类型对象找出来：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_max_instance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 取出所有实例")]),t._v("\n    instances "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("by_type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" instances"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 临时记录最大大小")]),t._v("\n    maxsize "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    max_one "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 遍历实例")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" instance "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" instances"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        size "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" maxsize"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            maxsize "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" size\n            max_one "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" instance\n  \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" max_one\n")])])]),s("p",[t._v("接着，我们将每种容器中，长度最大的对象找出来：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" max_tuple "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" get_max_instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tuple'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("max_tuple"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("42")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" max_list "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" get_max_instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'list'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("max_list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65535")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" max_dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" get_max_instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dict'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("max_dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("85865")]),t._v("\n")])])]),s("p",[t._v("最大的 "),s("em",[t._v("tuple")]),t._v(" 长度只有 "),s("em",[t._v("42")]),t._v(" ，肯定与问题无关；剩下的 "),s("em",[t._v("list")]),t._v(" 和 "),s("em",[t._v("dict")]),t._v(" ，"),s("em",[t._v("dict")]),t._v(" 更大一点，严重怀疑它。先来看看它里面都保存着什么东西：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" k"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" max_dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" k\n"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'956712794f14a1377352f77c844c89fe75c96fb1bf7cd3220e11e31ff8761d67'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" v\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user_id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'956712794f14a1377352f77c844c89fe75c96fb1bf7cd3220e11e31ff8761d67'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'name'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Luis Lewis'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'email'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tammyhale@yahoo.com'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'address'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'24043 Javier Summit Apt. 283\\nEdwardchester, CA 19580'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'desc'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Trip alone material because doctor. Story play night between entire interview as dog.\\nMeasure actually law high. Discussion at project would argue knowledge land direction.'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("由于我们的服务程序非常简单，以 "),s("em",[t._v("ID")]),t._v(" 为 "),s("em",[t._v("key")]),t._v(" ，以用户信息为 "),s("em",[t._v("value")]),t._v(" 的字典就只有 "),s("em",[t._v("cache")]),t._v(" 了。由此，我们发现了问题的所在，正是 "),s("em",[t._v("cache")]),t._v(" 字典长度不断增长，导致服务占用内存越来越多。")]),t._v(" "),s("p",[t._v("再退一步，如果服务逻辑非常复杂，无法肉眼看出这个巨大的 "),s("em",[t._v("dict")]),t._v(" 是什么东西，又该如何定位问题呢？莫慌，"),s("em",[t._v("objgraph")]),t._v(" 可以帮忙找出引用这个 "),s("em",[t._v("dict")]),t._v(" 的地方：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" chain "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("find_backref_chain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("max_dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_proper_module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("em",[t._v("find_backref_chain")]),t._v(" 函数将找出 "),s("em",[t._v("max_dict")]),t._v(" 对象的反向引用链，引用链以 "),s("em",[t._v("list")]),t._v(" 的形式返回。"),s("em",[t._v("is_proper_module")]),t._v(" 告诉它，当回溯遇到模块对象后，停止搜索。"),s("em",[t._v("Python")]),t._v(" 模块对象辨识度很高，从模块对象出发，沿着引用链即可发现 "),s("em",[t._v("max_dict")]),t._v(" 的来龙去脉。")]),t._v(" "),s("p",[t._v("在这个例子，引用链非常简单，只有区区 "),s("em",[t._v("3")]),t._v(" 个节点：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" chain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" max_dict\n"),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n")])])]),s("p",[t._v("其中，最后一个节点就是我们要定位的 "),s("em",[t._v("max_dict")]),t._v(" 字典；第一个节点是  "),s("em",[s("strong",[t._v("main")])]),t._v("  模块。由此，我们可以断定： "),s("em",[t._v("max_dict")]),t._v(" 是  "),s("em",[s("strong",[t._v("main")])]),t._v("  模块中的某个属性，而第二个节点就是  "),s("em",[s("strong",[t._v("main")])]),t._v("  模块的属性空间：")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/5f680f250001945310540393-20231216182334-fdaasw3.png",alt:"图片描述"}}),t._v("​")]),t._v(" "),s("p",[t._v("如果引用链较长，建议将它画在一个图片上进行分析，更为直观。"),s("em",[t._v("objgraph")]),t._v(" 内置生成图片的功能，不过需要先安装 "),s("em",[t._v("graphviz")]),t._v(" 以及 "),s("em",[t._v("xdot")]),t._v(" 这两个依赖。注意 "),s("em",[t._v("graphviz")]),t._v(" 与 "),s("em",[t._v("xdot")]),t._v(" 不同，它不是 "),s("em",[t._v("Python")]),t._v(" 包，以 "),s("em",[t._v("Ubuntu")]),t._v(" 为例用 "),s("em",[t._v("apt")]),t._v(" 安装：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("$ apt install graphviz\n$ pip install xdot\n")])])]),s("p",[t._v("依赖安装完毕后，调用 "),s("em",[t._v("show_chain")]),t._v(" 函数进行绘图，"),s("em",[t._v("filename")]),t._v(" 参数指定图片名字：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("show_chain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filename"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'chain.png'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nGraph written to "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("tmp"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("objgraph"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("szst76n5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dot "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" nodes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nImage generated "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" chain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("png\n")])])]),s("p",[t._v("由于我们通过远程终端在服务进程内部执行代码，因此生成的图片被保存在服务进程工作目录。它大致是这样的：")]),t._v(" "),s("p",[t._v("​"),s("img",{attrs:{src:"https://assets.b3logfile.com/siyuan/xxxxxx/assets/5f680f2e000159b301970372-20231216182334-q1ommeu.png",alt:"图片描述"}}),t._v("​")]),t._v(" "),s("p",[t._v("如果模块对象非常复杂，包含很多字典属性，难以区分。我们就只能逐个遍历对比，才能确定问题属性：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attrs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" attrs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" max_dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("         "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("         "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\ncache\n")])])]),s("p",[t._v("至此，通过种种手段，我们已经百分之百确定 —— 问题字典就是  "),s("em",[s("strong",[t._v("main")])]),t._v("  模块中用于缓存数据的 "),s("em",[t._v("cache")]),t._v(" ：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" max_dict "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cache\n"),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n")])])]),s("h2",{attrs:{id:"未雨绸缪"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#未雨绸缪"}},[t._v("#")]),t._v(" 未雨绸缪")]),t._v(" "),s("p",[t._v("扁鹊曰：长兄于病视神，未有形而除之，故名不出于家。所谓解决患难者强，防患于未然者神。那么，对于内存泄露隐患，是否也能够做到防范于未然呢？答案是肯定的。")]),t._v(" "),s("p",[t._v("首先，针对造成内存泄露的根源，我们在写代码时要时刻牢记以下两点：")]),t._v(" "),s("ul",[s("li",[t._v("往容器添加元素时，要考虑退出 (删除) 机制；")]),t._v(" "),s("li",[t._v("慎用  "),s("em",[s("strong",[t._v("del")])]),t._v("  魔术方法；")])]),t._v(" "),s("p",[t._v("其次，做好程序内存监控。将程序占用内存大小，每种容器对象的最大长度等关键指标提交到监控系统，并绘制趋势图。这样一来，趋势图可以帮我们发现一些潜在的问题，将它解决在爆发前夜。此外，每次服务变更时，勿忘关注内存使用趋势，异常可在第一时间发现。")]),t._v(" "),s("p",[t._v("最后，我们还可以事先在程序中定义一些常用工具函数。一旦程序出现内存泄露问题，我们可以通过远程终端连上服务进程实时诊断，这些工具函数将极大加速问题定位的速度。下面是一个例子：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" objgraph\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" random\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("show_instance_randomly")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 类型名及图片输出路径")]),t._v("\n    type_name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    filename "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/tmp/%s.png'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 取出所有实例")]),t._v("\n    instances "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("by_type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" instances"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 随机取出一个实例")]),t._v("\n    instance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" random"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("choice"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("instances"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 画反向引用图")]),t._v("\n    objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("show_backrefs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filename"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_max_instance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 取出所有实例")]),t._v("\n    instances "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("by_type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" instances"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 临时记录最大大小")]),t._v("\n    maxsize "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    max_one "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 遍历实例")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" instance "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" instances"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        size "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" maxsize"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            maxsize "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" size\n            max_one "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" instance\n  \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" max_one\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("show_max_instance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 类型名及图片输出路径")]),t._v("\n    type_name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    filename "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/tmp/max_%s.png'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 找出最大实例")]),t._v("\n    max_one "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" get_max_instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("type_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 反向引用图")]),t._v("\n    objgraph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("show_backrefs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("max_one"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filename"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("ul",[s("li",[s("em",[t._v("show_instance_randomly")]),t._v(" ，随机取出一个指定类型对象，生成反向引用图，保存在  "),s("em",[t._v("/tmp")]),t._v(" 目录；")]),t._v(" "),s("li",[s("em",[t._v("get_max_instance")]),t._v(" ，搜索长度最大的指定类型容器对象；")]),t._v(" "),s("li",[s("em",[t._v("show_max_instance")]),t._v(" ，搜索长度最大的指定类型容器对象，生成反向引用图，保存在  "),s("em",[t._v("/tmp")]),t._v(" 目录；")])])])}),[],!1,null,null,null);s.default=e.exports}}]);